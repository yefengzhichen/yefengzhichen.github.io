<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Istio pilot-agent 源码解析 - yefengzhichen&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="yefengzhichen" /><meta name="description" content="pilot-agent 源码 整体流程 整体逻辑如下图，简单来说分为以下几步： pilot-agent 启动后，生成私钥和 CSR（证书签名请求），用 CSR 请求 istiod 获取工作负载证书，ROOTCA 根证" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.92.1 with theme even" />


<link rel="canonical" href="https://yefengzhichen.github.io/post/istio_pilot_agent_src/" />
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../manifest.json">
<link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="../../sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Istio pilot-agent 源码解析" />
<meta property="og:description" content="pilot-agent 源码 整体流程 整体逻辑如下图，简单来说分为以下几步： pilot-agent 启动后，生成私钥和 CSR（证书签名请求），用 CSR 请求 istiod 获取工作负载证书，ROOTCA 根证" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yefengzhichen.github.io/post/istio_pilot_agent_src/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-02-03T18:46:11+08:00" />
<meta property="article:modified_time" content="2023-02-03T18:46:11+08:00" />

<meta itemprop="name" content="Istio pilot-agent 源码解析">
<meta itemprop="description" content="pilot-agent 源码 整体流程 整体逻辑如下图，简单来说分为以下几步： pilot-agent 启动后，生成私钥和 CSR（证书签名请求），用 CSR 请求 istiod 获取工作负载证书，ROOTCA 根证"><meta itemprop="datePublished" content="2023-02-03T18:46:11+08:00" />
<meta itemprop="dateModified" content="2023-02-03T18:46:11+08:00" />
<meta itemprop="wordCount" content="11739">
<meta itemprop="keywords" content="kubernetes,istio,pilot-agent," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Istio pilot-agent 源码解析"/>
<meta name="twitter:description" content="pilot-agent 源码 整体流程 整体逻辑如下图，简单来说分为以下几步： pilot-agent 启动后，生成私钥和 CSR（证书签名请求），用 CSR 请求 istiod 获取工作负载证书，ROOTCA 根证"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../../">
        <li class="mobile-menu-item">首页</li>
      </a><a href="../../post/">
        <li class="mobile-menu-item">列表</li>
      </a><a href="../../tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="../../categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../../">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../post/">列表</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../categories/">分类</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Istio pilot-agent 源码解析</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-02-03 </span>
        <div class="post-category">
            <a href="../../categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"> 云原生 </a>
            </div>
          <span class="more-meta"> 约 11739 字 </span>
          <span class="more-meta"> 预计阅读 24 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#pilot-agent-源码">pilot-agent 源码</a>
      <ul>
        <li><a href="#整体流程">整体流程</a></li>
        <li><a href="#pilot-agent-命令">pilot-agent 命令</a></li>
        <li><a href="#istio-agent-下的-agent">istio-agent 下的 Agent</a></li>
        <li><a href="#initsdsserver">initSdsServer</a>
          <ul>
            <li><a href="#istiod-服务端-createcertificate">istiod 服务端 CreateCertificate</a></li>
          </ul>
        </li>
        <li><a href="#secretmanagerclient">SecretManagerClient</a></li>
        <li><a href="#sds-grpc-服务">SDS Grpc 服务</a></li>
        <li><a href="#sdsservice">sdsservice</a></li>
        <li><a href="#registersecretdiscoveryserviceserver">RegisterSecretDiscoveryServiceServer</a></li>
        <li><a href="#xdsproxy">XdsProxy</a></li>
        <li><a href="#envoy-agent">envoy agent</a></li>
        <li><a href="#envoy-proxy">envoy proxy</a></li>
      </ul>
    </li>
    <li><a href="#istio-证书逻辑">istio 证书逻辑</a>
      <ul>
        <li><a href="#sidecar-证书配置">sidecar 证书配置</a></li>
        <li><a href="#gateway-证书配置">Gateway 证书配置</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="pilot-agent-源码">pilot-agent 源码</h1>
<h2 id="整体流程">整体流程</h2>
<p>整体逻辑如下图，简单来说分为以下几步：</p>
<ul>
<li>pilot-agent 启动后，生成私钥和 CSR（证书签名请求），用 CSR 请求 istiod 获取工作负载证书，ROOTCA 根证书是挂载在本地目录的</li>
<li>pilot-agent 创建 envoy 启动配置文件，使用 cmd 方式启动 envoy，启动配置文件中包含 istiod 的地址，pilot-agent SDS（secret discovery service）服务的 UDS（unix domain socket）地址</li>
<li>envoy 请求 SDS，获取私钥、工作负载证书、ROOTCA 根证书，并请求 istiod 获取 XDS 动态配置（经过 pilot-agent 转发和 istiod 建立的长连接）</li>
<li>如果服务器证书有更新，pilot-agent 收到推送的更新，会经过 UDS 发给 envoy</li>
</ul>
<p><img src="../../image/pilot_agent/agent_arch_overview.png" alt="agent_arch_overview" title="pilot-agent 逻辑"></p>
<h2 id="pilot-agent-命令">pilot-agent 命令</h2>
<p>pilot-agent 是用来启动 envoy 的，可以用在两种场景：</p>
<ul>
<li>应用容器的边车代理中：启动命令为“pilot-agent proxy sidecar xx”</li>
<li>Gateway pods 中转发流量：启动命令为“pilot-agent proxy router xx”</li>
</ul>
<p>pilot-agent 在启动时会从 istiod 中获取 envoy 部分配置来启动 envoy，等 envoy 启动后，envoy 和 istiod 连接动态获取 XDS 配置。pilot-agent 使用 cobra 来启动服务的，这里只关注 proxy 子命令逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pilot/cmd/pilot-agent/app/cmd.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newProxyCommand</span><span class="p">()</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;proxy&#34;</span><span class="p">,</span>
    <span class="nx">RunE</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="c1">// 根据启动参数创建和初始化 Proxy，Proxy 包含代理实例的信息（envoy sizecar，gateway）
</span><span class="c1"></span>      <span class="nx">proxy</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">initProxy</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="c1">// 构建代理配置，自动注入时 istio-proxy 容器设置了 PROXY_CONFIG 环境变量，指定了 meshId
</span><span class="c1"></span>      <span class="nx">proxyConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">ConstructProxyConfig</span><span class="p">(</span><span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">MeshConfigFile</span><span class="p">,</span> <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">ServiceCluster</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ProxyConfigEnv</span><span class="p">,</span> <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">Concurrency</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get proxy config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">protomarshal</span><span class="p">.</span><span class="nf">ToYAML</span><span class="p">(</span><span class="nx">proxyConfig</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Failed to serialize to YAML: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Effective config: %s&#34;</span><span class="p">,</span> <span class="nx">out</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// Options 保存用于 secret 服务发现的所有配置参数和 CA 配置
</span><span class="c1"></span>      <span class="nx">secOpts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">NewSecurityOptions</span><span class="p">(</span><span class="nx">proxyConfig</span><span class="p">,</span> <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">StsPort</span><span class="p">,</span> <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">TokenManagerPlugin</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>

      <span class="nx">envoyOptions</span> <span class="o">:=</span> <span class="nx">envoy</span><span class="p">.</span><span class="nx">ProxyConfig</span><span class="p">{</span>
        <span class="nx">LogLevel</span><span class="p">:</span>          <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">ProxyLogLevel</span><span class="p">,</span>
        <span class="nx">ComponentLogLevel</span><span class="p">:</span> <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">ProxyComponentLogLevel</span><span class="p">,</span>
        <span class="nx">LogAsJSON</span><span class="p">:</span>         <span class="nx">loggingOptions</span><span class="p">.</span><span class="nx">JSONEncoding</span><span class="p">,</span>
        <span class="nx">NodeIPs</span><span class="p">:</span>           <span class="nx">proxy</span><span class="p">.</span><span class="nx">IPAddresses</span><span class="p">,</span>
        <span class="nx">Sidecar</span><span class="p">:</span>           <span class="nx">proxy</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">model</span><span class="p">.</span><span class="nx">SidecarProxy</span><span class="p">,</span>
        <span class="nx">OutlierLogPath</span><span class="p">:</span>    <span class="nx">proxyArgs</span><span class="p">.</span><span class="nx">OutlierLogPath</span><span class="p">,</span>
      <span class="p">}</span>
      <span class="nx">agentOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">NewAgentOptions</span><span class="p">(</span><span class="nx">proxy</span><span class="p">,</span> <span class="nx">proxyConfig</span><span class="p">)</span>
      <span class="c1">// 创建 Agent
</span><span class="c1"></span>      <span class="nx">agent</span> <span class="o">:=</span> <span class="nx">istio_agent</span><span class="p">.</span><span class="nf">NewAgent</span><span class="p">(</span><span class="nx">proxyConfig</span><span class="p">,</span> <span class="nx">agentOptions</span><span class="p">,</span> <span class="nx">secOpts</span><span class="p">,</span> <span class="nx">envoyOptions</span><span class="p">)</span>
      <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
      <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>

      <span class="c1">// 优雅退出
</span><span class="c1"></span>      <span class="k">go</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">WaitSignalFunc</span><span class="p">(</span><span class="nx">cancel</span><span class="p">)</span>

      <span class="c1">// 启动 SDS 服务发现、dns 服务、xds 代理和 Envoy
</span><span class="c1"></span>      <span class="nx">wait</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">agent</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="nf">wait</span><span class="p">()</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="istio-agent-下的-agent">istio-agent 下的 Agent</h2>
<p>Agent 承载了本地 SDS 和 XDS 服务发现的功能，其定义和运行逻辑如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/istio-agent/agent.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Agent</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">proxyConfig</span> <span class="o">*</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">ProxyConfig</span>

  <span class="nx">cfg</span>       <span class="o">*</span><span class="nx">AgentOptions</span>
  <span class="nx">secOpts</span>   <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span>
  <span class="nx">envoyOpts</span> <span class="nx">envoy</span><span class="p">.</span><span class="nx">ProxyConfig</span>

  <span class="nx">envoyAgent</span>             <span class="o">*</span><span class="nx">envoy</span><span class="p">.</span><span class="nx">Agent</span>
  <span class="nx">dynamicBootstrapWaitCh</span> <span class="kd">chan</span> <span class="kt">error</span>

  <span class="nx">sdsServer</span>   <span class="o">*</span><span class="nx">sds</span><span class="p">.</span><span class="nx">Server</span>
  <span class="nx">secretCache</span> <span class="o">*</span><span class="nx">cache</span><span class="p">.</span><span class="nx">SecretManagerClient</span>

  <span class="c1">// Used when proxying envoy xds via istio-agent is enabled.
</span><span class="c1"></span>  <span class="nx">xdsProxy</span>    <span class="o">*</span><span class="nx">XdsProxy</span>
  <span class="nx">fileWatcher</span> <span class="nx">filewatcher</span><span class="p">.</span><span class="nx">FileWatcher</span>

  <span class="c1">// local DNS Server that processes DNS requests locally and forwards to upstream DNS if needed.
</span><span class="c1"></span>  <span class="nx">localDNSServer</span> <span class="o">*</span><span class="nx">dnsClient</span><span class="p">.</span><span class="nx">LocalDNSServer</span>

  <span class="c1">// Signals true completion (e.g. with delayed graceful termination of Envoy)
</span><span class="c1"></span>  <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewAgent</span><span class="p">(</span><span class="nx">proxyConfig</span> <span class="o">*</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">ProxyConfig</span><span class="p">,</span> <span class="nx">agentOpts</span> <span class="o">*</span><span class="nx">AgentOptions</span><span class="p">,</span> <span class="nx">sopts</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">eopts</span> <span class="nx">envoy</span><span class="p">.</span><span class="nx">ProxyConfig</span><span class="p">)</span> <span class="o">*</span><span class="nx">Agent</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Agent</span><span class="p">{</span>
    <span class="nx">proxyConfig</span><span class="p">:</span> <span class="nx">proxyConfig</span><span class="p">,</span>
    <span class="nx">cfg</span><span class="p">:</span>         <span class="nx">agentOpts</span><span class="p">,</span>
    <span class="nx">secOpts</span><span class="p">:</span>     <span class="nx">sopts</span><span class="p">,</span>
    <span class="nx">envoyOpts</span><span class="p">:</span>   <span class="nx">eopts</span><span class="p">,</span>
    <span class="nx">fileWatcher</span><span class="p">:</span> <span class="nx">filewatcher</span><span class="p">.</span><span class="nf">NewWatcher</span><span class="p">(),</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 非阻塞调用
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kd">func</span><span class="p">(),</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="c1">// 初始化 dns 服务（gateway 不需要 dns 服务）
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">initLocalDNSServer</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start local DNS server: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 检查用于 SDS 发现的 unix domain socket 是否存在
</span><span class="c1"></span>  <span class="nx">socketExists</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">checkSocket</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentitySocketPath</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to check SDS socket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">socketExists</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Workload SDS socket found. Istio SDS Server won&#39;t be started&#34;</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 使用 istio 的 SDS 服务
</span><span class="c1"></span>    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Workload SDS socket not found. Starting Istio SDS Server&#34;</span><span class="p">)</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">initSdsServer</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start SDS server: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">xdsProxy</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">initXdsProxy</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start xds proxy: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 定义当代理连接到控制面是如何认证的
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">ControlPlaneAuthPolicy</span> <span class="o">!=</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">AuthenticationPolicy_NONE</span> <span class="p">{</span>
    <span class="c1">// 决定在 bootstrap 文件中配置的根 CA，可能与证书服务器的不同
</span><span class="c1"></span>    <span class="nx">rootCAForXDS</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">FindRootCAForXDS</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to find root XDS CA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">go</span> <span class="nx">a</span><span class="p">.</span><span class="nf">startFileWatcher</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">rootCAForXDS</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">xdsProxy</span><span class="p">.</span><span class="nf">initIstiodDialOptions</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;Failed to init xds proxy dial options&#34;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
  <span class="c1">// 开启了 envoy 代理
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">!</span><span class="nx">a</span><span class="p">.</span><span class="nf">EnvoyDisabled</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 初始化 envoy agent 和 envoy proxy，用于创建 envoy 执行的 cmd
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">initializeEnvoyAgent</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to initialize envoy agent: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">a</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">defer</span> <span class="nx">a</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
      <span class="c1">// 启动 envoy 命令
</span><span class="c1"></span>      <span class="nx">a</span><span class="p">.</span><span class="nx">envoyAgent</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="p">}()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">WaitForSigterm</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">initializeEnvoyAgent</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="c1">// 节点信息
</span><span class="c1"></span>  <span class="nx">node</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">generateNodeMetadata</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to generate bootstrap metadata: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 日志示例：Pilot SAN: [istiod.istio-system.svc]
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Pilot SAN: %v&#34;</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">Metadata</span><span class="p">.</span><span class="nx">PilotSubjectAltName</span><span class="p">)</span>

  <span class="c1">// 自定义代理配置文件路径
</span><span class="c1"></span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">CustomConfigFile</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="c1">// there is a custom configuration. Don&#39;t write our own config - but keep watching the certs.
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">ConfigPath</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">CustomConfigFile</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">ConfigCleanup</span> <span class="p">=</span> <span class="kc">false</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">out</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bootstrap</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">bootstrap</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
      <span class="nx">Node</span><span class="p">:</span> <span class="nx">node</span><span class="p">,</span>
    <span class="p">}).</span><span class="nf">CreateFile</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to generate bootstrap config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">ConfigPath</span> <span class="p">=</span> <span class="nx">out</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">ConfigCleanup</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="c1">// 用 proxy 配置回填 envoy 配置
</span><span class="c1"></span>  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">BinaryPath</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">BinaryPath</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">AdminPort</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">ProxyAdminPort</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">DrainDuration</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">DrainDuration</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">ParentShutdownDuration</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">ParentShutdownDuration</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">Concurrency</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">Concurrency</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span>

  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">.</span><span class="nx">AgentIsRoot</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSAddr</span><span class="p">,</span> <span class="s">&#34;:53&#34;</span><span class="p">)</span>
  <span class="c1">// 创建代理控制命令的实例
</span><span class="c1"></span>  <span class="nx">envoyProxy</span> <span class="o">:=</span> <span class="nx">envoy</span><span class="p">.</span><span class="nf">NewProxy</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">envoyOpts</span><span class="p">)</span>

  <span class="nx">drainDuration</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">TerminationDrainDuration</span><span class="p">.</span><span class="nf">AsDuration</span><span class="p">()</span>
  <span class="nx">localHostAddr</span> <span class="o">:=</span> <span class="nx">localHostIPv4</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">IsIPv6</span> <span class="p">{</span>
    <span class="nx">localHostAddr</span> <span class="p">=</span> <span class="nx">localHostIPv6</span>
  <span class="p">}</span>
  <span class="c1">// 创建新的代理 agent，其持有 envoyProxy 并管理 envoyProxy 的启动
</span><span class="c1"></span>  <span class="nx">a</span><span class="p">.</span><span class="nx">envoyAgent</span> <span class="p">=</span> <span class="nx">envoy</span><span class="p">.</span><span class="nf">NewAgent</span><span class="p">(</span><span class="nx">envoyProxy</span><span class="p">,</span> <span class="nx">drainDuration</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">MinimumDrainDuration</span><span class="p">,</span> <span class="nx">localHostAddr</span><span class="p">,</span>
    <span class="nb">int</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">ProxyAdminPort</span><span class="p">),</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EnvoyStatusPort</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EnvoyPrometheusPort</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ExitOnZeroActiveConnections</span><span class="p">)</span>
  <span class="c1">// 动态生成启动配置
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EnableDynamicBootstrap</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">dynamicBootstrapWaitCh</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">// 模拟一个启动的 xDS 请求
</span><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">backoff</span><span class="p">.</span><span class="nf">NewExponentialBackOff</span><span class="p">(</span><span class="nx">backoff</span><span class="p">.</span><span class="nf">DefaultOption</span><span class="p">())</span>
    <span class="k">for</span> <span class="p">{</span>
      <span class="c1">// handleStream 在退出后处理请求，因此创建一个新的
</span><span class="c1"></span>      <span class="nx">bsStream</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bootstrapDiscoveryStream</span><span class="p">{</span>
        <span class="nx">node</span><span class="p">:</span>        <span class="nx">node</span><span class="p">,</span>
        <span class="nx">errCh</span><span class="p">:</span>       <span class="nx">a</span><span class="p">.</span><span class="nx">dynamicBootstrapWaitCh</span><span class="p">,</span>
        <span class="c1">// 配置有更新，调用 envoy.envoy 的 UpdateConfig 将配置写入到 etc/istio/proxy/envoy-rev.json
</span><span class="c1"></span>        <span class="nx">envoyUpdate</span><span class="p">:</span> <span class="nx">envoyProxy</span><span class="p">.</span><span class="nx">UpdateConfig</span><span class="p">,</span>
      <span class="p">}</span>
      <span class="nx">_</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">xdsProxy</span><span class="p">.</span><span class="nf">handleStream</span><span class="p">(</span><span class="nx">bsStream</span><span class="p">)</span>
      <span class="nx">delay</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">NextBackOff</span><span class="p">()</span>
      <span class="k">select</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">a</span><span class="p">.</span><span class="nx">dynamicBootstrapWaitCh</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
          <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;successfully updated bootstrap config&#34;</span><span class="p">)</span>
          <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="c1">// received invalid config, could not happen in normal case.
</span><span class="c1"></span>        <span class="nx">log</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">nil</span>
      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">delay</span><span class="p">):</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;retrying bootstrap discovery request with backoff: %v&#34;</span><span class="p">,</span> <span class="nx">delay</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="initsdsserver">initSdsServer</h2>
<p>initSdsServer 是初始化 SDS 服务发现，在 newSecretManager 函数中，获取了集群的根证书、本地服务器证书、私钥等。这里逻辑是，生成私钥和 CSR，向 istiod 发送 CSR，istiod 根据请求的服务身份签发证书。查看 sidecar 的日志中，对于 tlsOpts.RootCert 有打印“Using CA istiod.istio-system.svc:15012 cert with certs: var/run/secrets/istio/root-cert.pem”，结合 sidecar 的 pod 描述看，CA 根证书实际是从 istio-system 空间的 istio-ca-root-cert cm 中获取的，而 cm 这个值从手动创建的 cacerts secret 中获取的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/istio-agent/agent.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">initSdsServer</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="c1">// 检查工作负载证书文件是否挂载在指定的路径
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">security</span><span class="p">.</span><span class="nf">CheckWorkloadCertificate</span><span class="p">(</span><span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentityCertChainPath</span><span class="p">,</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentityKeyPath</span><span class="p">,</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentityRootCertPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;workload certificate files detected, creating secret manager without caClient&#34;</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">RootCertFilePath</span> <span class="p">=</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentityRootCertPath</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CertChainFilePath</span> <span class="p">=</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentityCertChainPath</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">KeyFilePath</span> <span class="p">=</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentityKeyPath</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">FileMountedCerts</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="nx">a</span><span class="p">.</span><span class="nx">secretCache</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">newSecretManager</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start workload secret manager %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 关闭 envoy 代理功能
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DisableEnvoy</span> <span class="p">{</span>
    <span class="c1">// 对于无代理模式，不需要 SDS 服务器，但仍然需要密钥并且需要定期刷新。
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secretCache</span>
      <span class="nx">st</span><span class="p">.</span><span class="nf">RegisterSecretHandler</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 缓存无效时，在 secret 需要更新时调用此 handler
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">getWorkloadCerts</span><span class="p">(</span><span class="nx">st</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="c1">// 尝试获取证书，直到工作负载证书和根证书都获取了才返回
</span><span class="c1"></span>      <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">getWorkloadCerts</span><span class="p">(</span><span class="nx">st</span><span class="p">)</span>
    <span class="p">}()</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 私钥配置
</span><span class="c1"></span>    <span class="nx">pkpConf</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nf">GetPrivateKeyProvider</span><span class="p">()</span>
    <span class="c1">// 创建和开启 SDS 的 grpc 服务器
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">sdsServer</span> <span class="p">=</span> <span class="nx">sds</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secretCache</span><span class="p">,</span> <span class="nx">pkpConf</span><span class="p">)</span>
    <span class="c1">// secretCache 注册当 secret 更新时调用的 handler
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">secretCache</span><span class="p">.</span><span class="nf">RegisterSecretHandler</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">sdsServer</span><span class="p">.</span><span class="nx">OnSecretUpdate</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="err">###</span> <span class="nx">SecretManager</span>
<span class="c1">// 为负载 secret 创建 SecretManager
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">newSecretManager</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">cache</span><span class="p">.</span><span class="nx">SecretManagerClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 使用文件挂载的证书
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">FileMountedCerts</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Workload is using file mounted certificates. Skipping connecting to CA&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">NewSecretManagerClient</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 打印示例：“CA Endpoint istiod.istio-system.svc:15012, provider Citadel”，即通过 istiod 的 15012 端口的 Citadel 模块获取
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;CA Endpoint %s, provider %s&#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAProviderName</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">tlsOpts</span> <span class="o">*</span><span class="nx">citadel</span><span class="p">.</span><span class="nx">TLSOptions</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">,</span> <span class="s">&#34;:15010&#34;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;Debug mode or IP-secure network&#34;</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">tlsOpts</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">citadel</span><span class="p">.</span><span class="nx">TLSOptions</span><span class="p">{}</span>
    <span class="c1">// 获取根证书
</span><span class="c1"></span>    <span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">FindRootCAForCA</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to find root CA cert for CA: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">RootCert</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Using CA %s cert with system certs&#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nf">fileExists</span><span class="p">(</span><span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;invalid config - %s missing a root certificate %s&#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">,</span> <span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 获取了有效的 CA 根证书，打印示例：“Using CA istiod.istio-system.svc:15012 cert with certs: var/run/secrets/istio/root-cert.pem”
</span><span class="c1"></span>      <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Using CA %s cert with certs: %s&#34;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">,</span> <span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// secOpts.ProvCert 为空，这两个也为空
</span><span class="c1"></span>    <span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">tlsOpts</span><span class="p">.</span><span class="nx">Cert</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">getKeyCertsForCA</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="c1">// 创建 CitadelClient，即用于 Citadel 的 CA 客户端
</span><span class="c1"></span>  <span class="nx">caClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">citadel</span><span class="p">.</span><span class="nf">NewCitadelClient</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">,</span> <span class="nx">tlsOpts</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="c1">// 创建 SecretManagerClient，使用提供的 client 签发证书签名请求文件
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">NewSecretManagerClient</span><span class="p">(</span><span class="nx">caClient</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里会创建 CitadelClient 用来请求 Citadel 模块，SecretManagerClient 里面会调用 CitadelClient 的 CSRSign 方法，这里关注下初始化和 CSRSign 方法逻辑：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">CitadelClient</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// 不为空表示开启 tls 连接
</span><span class="c1"></span>  <span class="nx">tlsOpts</span>   <span class="o">*</span><span class="nx">TLSOptions</span>
  <span class="nx">client</span>    <span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateServiceClient</span>
  <span class="nx">conn</span>      <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span>
  <span class="nx">provider</span>  <span class="o">*</span><span class="nx">caclient</span><span class="p">.</span><span class="nx">TokenProvider</span>
  <span class="nx">opts</span>      <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span>
  <span class="nx">usingMtls</span> <span class="o">*</span><span class="nx">atomic</span><span class="p">.</span><span class="nx">Bool</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewCitadelClient</span><span class="p">(</span><span class="nx">opts</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">tlsOpts</span> <span class="o">*</span><span class="nx">TLSOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CitadelClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CitadelClient</span><span class="p">{</span>
    <span class="nx">tlsOpts</span><span class="p">:</span>   <span class="nx">tlsOpts</span><span class="p">,</span>
    <span class="nx">opts</span><span class="p">:</span>      <span class="nx">opts</span><span class="p">,</span>
    <span class="nx">provider</span><span class="p">:</span>  <span class="nx">caclient</span><span class="p">.</span><span class="nf">NewCATokenProvider</span><span class="p">(</span><span class="nx">opts</span><span class="p">),</span>
    <span class="nx">usingMtls</span><span class="p">:</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">NewBool</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="c1">// 建立 grpc 连接
</span><span class="c1"></span>  <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">buildConnection</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to connect to endpoint %s&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">CAEndpoint</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="p">=</span> <span class="nx">conn</span>
  <span class="c1">// IstioCertificateServiceClient 是 IstioCertificateService 服务的客户端 API
</span><span class="c1"></span>  <span class="c1">// 里面的 CreateCertificate 方法，使用提供的证书签名请求，来获取签发的证书
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">client</span> <span class="p">=</span> <span class="nx">pb</span><span class="p">.</span><span class="nf">NewIstioCertificateServiceClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 使用 CSR 请求 Citadel 来签发证书
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">CitadelClient</span><span class="p">)</span> <span class="nf">CSRSign</span><span class="p">(</span><span class="nx">csrPEM</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">certValidTTLInSec</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">crMetaStruct</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">structpb</span><span class="p">.</span><span class="nx">Struct</span><span class="p">{</span>
    <span class="nx">Fields</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">structpb</span><span class="p">.</span><span class="nx">Value</span><span class="p">{</span>
      <span class="nx">security</span><span class="p">.</span><span class="nx">CertSigner</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">Kind</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">structpb</span><span class="p">.</span><span class="nx">Value_StringValue</span><span class="p">{</span><span class="nx">StringValue</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">CertSigner</span><span class="p">},</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
  <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateRequest</span><span class="p">{</span>
    <span class="nx">Csr</span><span class="p">:</span>              <span class="nb">string</span><span class="p">(</span><span class="nx">csrPEM</span><span class="p">),</span>
    <span class="nx">ValidityDuration</span><span class="p">:</span> <span class="nx">certValidTTLInSec</span><span class="p">,</span>
    <span class="nx">Metadata</span><span class="p">:</span>         <span class="nx">crMetaStruct</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">reconnectIfNeeded</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">NewOutgoingContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">Pairs</span><span class="p">(</span><span class="s">&#34;ClusterID&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">ClusterID</span><span class="p">))</span>
  <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;create certificate: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">CertChain</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid empty CertChain&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">CertChain</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="istiod-服务端-createcertificate">istiod 服务端 CreateCertificate</h3>
<p>在上面的 client 中可以看到请求的 istiod 接口是“istio.v1.auth.IstioCertificateService/CreateCertificate”，找到对应的服务端处理逻辑如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">_IstioCertificateService_CreateCertificate_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">IstioCertificateRequest</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">IstioCertificateServiceServer</span><span class="p">).</span><span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
    <span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
    <span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/istio.v1.auth.IstioCertificateService/CreateCertificate&#34;</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">IstioCertificateServiceServer</span><span class="p">).</span><span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">IstioCertificateRequest</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面最终会调用到下面的 server.CreateCertificate 函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// security/pkg/server/ca/server.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">grpcServer</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterIstioCertificateServiceServer</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// s.Ca 是通过 createIstioCA 函数创建的，详细参考 pilot-discovery 源码解析
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateRequest</span><span class="p">)</span> <span class="p">(</span>
  <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">CSR</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
  <span class="nx">am</span> <span class="o">:=</span> <span class="nx">security</span><span class="p">.</span><span class="nx">AuthenticationManager</span><span class="p">{</span><span class="nx">Authenticators</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Authenticators</span><span class="p">}</span>
  <span class="nx">caller</span> <span class="o">:=</span> <span class="nx">am</span><span class="p">.</span><span class="nf">Authenticate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">caller</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">AuthnError</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unauthenticated</span><span class="p">,</span> <span class="s">&#34;request authenticate failure&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// By default, we will use the callers identity for the certificate
</span><span class="c1"></span>  <span class="nx">sans</span> <span class="o">:=</span> <span class="nx">caller</span><span class="p">.</span><span class="nx">Identities</span>
  <span class="nx">crMetadata</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Metadata</span><span class="p">.</span><span class="nf">GetFields</span><span class="p">()</span>
  <span class="nx">impersonatedIdentity</span> <span class="o">:=</span> <span class="nx">crMetadata</span><span class="p">[</span><span class="nx">security</span><span class="p">.</span><span class="nx">ImpersonatedIdentity</span><span class="p">].</span><span class="nf">GetStringValue</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">impersonatedIdentity</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span>
  <span class="c1">// 获取请求 metadata 中的字段“CertSigner”
</span><span class="c1"></span>  <span class="nx">certSigner</span> <span class="o">:=</span> <span class="nx">crMetadata</span><span class="p">[</span><span class="nx">security</span><span class="p">.</span><span class="nx">CertSigner</span><span class="p">].</span><span class="nf">GetStringValue</span><span class="p">()</span>
  <span class="c1">// 打印示例：generating a certificate for [spiffe://cluster.local/ns/sample/sa/sleep], requested ttl: 24h0m0s
</span><span class="c1"></span>  <span class="nx">serverCaLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;generating a certificate for %v, requested ttl: %s&#34;</span><span class="p">,</span>
    <span class="nx">sans</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">ValidityDuration</span><span class="o">*</span><span class="nb">int64</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)))</span>
  <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">certChainBytes</span><span class="p">,</span> <span class="nx">rootCertBytes</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">GetCAKeyCertBundle</span><span class="p">().</span><span class="nf">GetAll</span><span class="p">()</span>
  <span class="nx">certOpts</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">CertOpts</span><span class="p">{</span>
    <span class="nx">SubjectIDs</span><span class="p">:</span> <span class="nx">sans</span><span class="p">,</span>
    <span class="nx">TTL</span><span class="p">:</span>        <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">ValidityDuration</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
    <span class="nx">ForCA</span><span class="p">:</span>      <span class="kc">false</span><span class="p">,</span>
    <span class="nx">CertSigner</span><span class="p">:</span> <span class="nx">certSigner</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">signErr</span> <span class="kt">error</span>
  <span class="kd">var</span> <span class="nx">cert</span> <span class="p">[]</span><span class="kt">byte</span>
  <span class="kd">var</span> <span class="nx">respCertChain</span> <span class="p">[]</span><span class="kt">string</span>
  <span class="k">if</span> <span class="nx">certSigner</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="c1">// 为空直接签发证书
</span><span class="c1"></span>    <span class="nx">cert</span><span class="p">,</span> <span class="nx">signErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">Sign</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Csr</span><span class="p">),</span> <span class="nx">certOpts</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 不为空，签发证书后，会返回此证书的证书链
</span><span class="c1"></span>    <span class="nx">respCertChain</span><span class="p">,</span> <span class="nx">signErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ca</span><span class="p">.</span><span class="nf">SignWithCertChain</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Csr</span><span class="p">),</span> <span class="nx">certOpts</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">certSigner</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="nx">respCertChain</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nb">string</span><span class="p">(</span><span class="nx">cert</span><span class="p">)}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">certChainBytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nx">respCertChain</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">respCertChain</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">certChainBytes</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 在证书链最后加上根证书，会导致 pods 证书链中有两个一样的根证书
</span><span class="c1"></span>  <span class="c1">// 因为 certChainBytes 中包含了集群中间证书和根证书
</span><span class="c1"></span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rootCertBytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">respCertChain</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">respCertChain</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">rootCertBytes</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">IstioCertificateResponse</span><span class="p">{</span>
    <span class="nx">CertChain</span><span class="p">:</span> <span class="nx">respCertChain</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">Success</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
  <span class="nx">serverCaLog</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;CSR successfully signed.&#34;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里会调用到：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// security/pkg/pki/ca/ca.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="nf">Sign</span><span class="p">(</span><span class="nx">csrPEM</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">certOpts</span> <span class="nx">CertOpts</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">,)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="nx">csrPEM</span><span class="p">,</span> <span class="nx">certOpts</span><span class="p">.</span><span class="nx">SubjectIDs</span><span class="p">,</span> <span class="nx">certOpts</span><span class="p">.</span><span class="nx">TTL</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">certOpts</span><span class="p">.</span><span class="nx">ForCA</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="nf">GetCAKeyCertBundle</span><span class="p">()</span> <span class="o">*</span><span class="nx">util</span><span class="p">.</span><span class="nx">KeyCertBundle</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">keyCertBundle</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="nf">sign</span><span class="p">(</span><span class="nx">csrPEM</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">subjectIDs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">requestedLifetime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">checkLifetime</span><span class="p">,</span> <span class="nx">forCA</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 当前集群证书和私钥
</span><span class="c1"></span>  <span class="nx">signingCert</span><span class="p">,</span> <span class="nx">signingKey</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nx">keyCertBundle</span><span class="p">.</span><span class="nf">GetAll</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">signingCert</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">caerror</span><span class="p">.</span><span class="nf">NewError</span><span class="p">(</span><span class="nx">caerror</span><span class="p">.</span><span class="nx">CANotReady</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Istio CA is not ready&#34;</span><span class="p">))</span> <span class="c1">// nolint
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="c1">// 解析 csr 请求并检查签名
</span><span class="c1"></span>  <span class="nx">csr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">ParsePemEncodedCSR</span><span class="p">(</span><span class="nx">csrPEM</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">caerror</span><span class="p">.</span><span class="nf">NewError</span><span class="p">(</span><span class="nx">caerror</span><span class="p">.</span><span class="nx">CSRError</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">csr</span><span class="p">.</span><span class="nf">CheckSignature</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">caerror</span><span class="p">.</span><span class="nf">NewError</span><span class="p">(</span><span class="nx">caerror</span><span class="p">.</span><span class="nx">CSRError</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// 生成证书
</span><span class="c1"></span>  <span class="nx">certBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GenCertFromCSR</span><span class="p">(</span><span class="nx">csr</span><span class="p">,</span> <span class="nx">signingCert</span><span class="p">,</span> <span class="nx">csr</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">,</span> <span class="o">*</span><span class="nx">signingKey</span><span class="p">,</span> <span class="nx">subjectIDs</span><span class="p">,</span> <span class="nx">lifetime</span><span class="p">,</span> <span class="nx">forCA</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">caerror</span><span class="p">.</span><span class="nf">NewError</span><span class="p">(</span><span class="nx">caerror</span><span class="p">.</span><span class="nx">CertGenError</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">block</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pem</span><span class="p">.</span><span class="nx">Block</span><span class="p">{</span>
    <span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;CERTIFICATE&#34;</span><span class="p">,</span>
    <span class="nx">Bytes</span><span class="p">:</span> <span class="nx">certBytes</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="nx">cert</span> <span class="o">:=</span> <span class="nx">pem</span><span class="p">.</span><span class="nf">EncodeToMemory</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">cert</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 跟 Sign 类似，但返回叶子证书和整个证书链
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="nf">SignWithCertChain</span><span class="p">(</span><span class="nx">csrPEM</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">certOpts</span> <span class="nx">CertOpts</span><span class="p">)</span> <span class="p">(</span>
  <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">cert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">signWithCertChain</span><span class="p">(</span><span class="nx">csrPEM</span><span class="p">,</span> <span class="nx">certOpts</span><span class="p">.</span><span class="nx">SubjectIDs</span><span class="p">,</span> <span class="nx">certOpts</span><span class="p">.</span><span class="nx">TTL</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">certOpts</span><span class="p">.</span><span class="nx">ForCA</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nb">string</span><span class="p">(</span><span class="nx">cert</span><span class="p">)},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ca</span> <span class="o">*</span><span class="nx">IstioCA</span><span class="p">)</span> <span class="nf">signWithCertChain</span><span class="p">(</span><span class="nx">csrPEM</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">subjectIDs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">requestedLifetime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">lifetimeCheck</span><span class="p">,</span>
  <span class="nx">forCA</span> <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">cert</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="nx">csrPEM</span><span class="p">,</span> <span class="nx">subjectIDs</span><span class="p">,</span> <span class="nx">requestedLifetime</span><span class="p">,</span> <span class="nx">lifetimeCheck</span><span class="p">,</span> <span class="nx">forCA</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">chainPem</span> <span class="o">:=</span> <span class="nx">ca</span><span class="p">.</span><span class="nf">GetCAKeyCertBundle</span><span class="p">().</span><span class="nf">GetCertChainPem</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">chainPem</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">cert</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cert</span><span class="p">,</span> <span class="nx">chainPem</span><span class="o">...</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">cert</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中 keyCertBundle.GetAll() 逻辑如下，其中 ca.KeyCertBundle 由 NewVerifiedKeyCertBundleFromFile 函数创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// security/pkg/pki/util/keycertbundle.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">KeyCertBundle</span><span class="p">)</span> <span class="nf">GetAll</span><span class="p">()</span> <span class="p">(</span><span class="nx">cert</span> <span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">,</span> <span class="nx">privKey</span> <span class="o">*</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">,</span> <span class="nx">certChainBytes</span><span class="p">,</span>
  <span class="nx">rootCertBytes</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">b</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
  <span class="nx">cert</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">cert</span>
  <span class="nx">privKey</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">privKey</span>
  <span class="nx">certChainBytes</span> <span class="p">=</span> <span class="nf">copyBytes</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">certChainBytes</span><span class="p">)</span>
  <span class="nx">rootCertBytes</span> <span class="p">=</span> <span class="nf">copyBytes</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">rootCertBytes</span><span class="p">)</span>
  <span class="nx">b</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
  <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// 传入的四个参数，分别多集群初始化时创建的 secret cacerts 中的四个文件：ca-cert.pem、ca-key.pem、cert-chain.pem、root-cert.pem
</span><span class="c1">// 在 security/pkg/pki/ca/ca.go 的 NewPluggedCertIstioCAOptions 函数中调用
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewVerifiedKeyCertBundleFromFile</span><span class="p">(</span><span class="nx">certFile</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">privKeyFile</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">certChainFiles</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">rootCertFile</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span>
  <span class="o">*</span><span class="nx">KeyCertBundle</span><span class="p">,</span> <span class="kt">error</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="nx">certBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">certFile</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="nx">privKeyBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">privKeyFile</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">certChainBytes</span> <span class="p">[]</span><span class="kt">byte</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">certChainFiles</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">certChainFiles</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span>

      <span class="k">if</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
      <span class="p">}</span>

      <span class="nx">certChainBytes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">certChainBytes</span><span class="p">,</span> <span class="nx">b</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">rootCertBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">rootCertFile</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nf">NewVerifiedKeyCertBundleFromPem</span><span class="p">(</span><span class="nx">certBytes</span><span class="p">,</span> <span class="nx">privKeyBytes</span><span class="p">,</span> <span class="nx">certChainBytes</span><span class="p">,</span> <span class="nx">rootCertBytes</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="secretmanagerclient">SecretManagerClient</h2>
<p>用来生成私钥和 CSR，并请求 pilot 的证书中心 Citadel 获取证书，会获取两个特定名称的证书：</p>
<ul>
<li>default：表示工作负载的 spiffe 证书，即本地 envoy 使用的证书</li>
<li>ROOTCA：集群根证书，用来校验其他服务证书</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// security/pkg/nodeagent/cache/secretcache.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SecretManagerClient</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// 用来请求 CA 的客户端
</span><span class="c1"></span>  <span class="nx">caClient</span> <span class="nx">security</span><span class="p">.</span><span class="nx">Client</span>

  <span class="nx">configOptions</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span>
  <span class="c1">// 当 secret 改变时的回调函数
</span><span class="c1"></span>  <span class="nx">secretHandler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">)</span>

  <span class="c1">// 工作证书和根证书缓存
</span><span class="c1"></span>  <span class="nx">cache</span> <span class="nx">secretCache</span>

  <span class="nx">generateMutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
  <span class="c1">// 存在证书链的位置，如果存在，则用这些文件指定的证书、私钥、根证书
</span><span class="c1"></span>  <span class="nx">existingCertificateFile</span> <span class="nx">security</span><span class="p">.</span><span class="nx">SdsCertificateConfig</span>
  <span class="c1">// 观测证书的变化，并触发通知给代理
</span><span class="c1"></span>  <span class="nx">certWatcher</span> <span class="o">*</span><span class="nx">fsnotify</span><span class="p">.</span><span class="nx">Watcher</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// 处理 secret 更新，secretHandler 实际是 sdsServer.OnSecretUpdate 函数
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretManagerClient</span><span class="p">)</span> <span class="nf">OnSecretUpdate</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sc</span><span class="p">.</span><span class="nx">certMutex</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">certMutex</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">secretHandler</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">sc</span><span class="p">.</span><span class="nf">secretHandler</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewSecretManagerClient</span><span class="p">(</span><span class="nx">caClient</span> <span class="nx">security</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">SecretManagerClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">watcher</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">fsnotify</span><span class="p">.</span><span class="nf">NewWatcher</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">ret</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">SecretManagerClient</span><span class="p">{</span>
    <span class="nx">queue</span><span class="p">:</span>         <span class="nx">queue</span><span class="p">.</span><span class="nf">NewDelayed</span><span class="p">(</span><span class="nx">queue</span><span class="p">.</span><span class="nf">DelayQueueBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
    <span class="nx">caClient</span><span class="p">:</span>      <span class="nx">caClient</span><span class="p">,</span>
    <span class="nx">configOptions</span><span class="p">:</span> <span class="nx">options</span><span class="p">,</span>
    <span class="nx">existingCertificateFile</span><span class="p">:</span> <span class="nx">security</span><span class="p">.</span><span class="nx">SdsCertificateConfig</span><span class="p">{</span>
      <span class="nx">CertificatePath</span><span class="p">:</span>   <span class="nx">options</span><span class="p">.</span><span class="nx">CertChainFilePath</span><span class="p">,</span>
      <span class="nx">PrivateKeyPath</span><span class="p">:</span>    <span class="nx">options</span><span class="p">.</span><span class="nx">KeyFilePath</span><span class="p">,</span>
      <span class="nx">CaCertificatePath</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">RootCertFilePath</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">certWatcher</span><span class="p">:</span> <span class="nx">watcher</span><span class="p">,</span>
    <span class="nx">fileCerts</span><span class="p">:</span>   <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">FileCert</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
    <span class="nx">stop</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="nx">caRootPath</span><span class="p">:</span>  <span class="nx">options</span><span class="p">.</span><span class="nx">CARootPath</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">go</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">stop</span><span class="p">)</span>
  <span class="k">go</span> <span class="nx">ret</span><span class="p">.</span><span class="nf">handleFileWatch</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">ret</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretManagerClient</span><span class="p">)</span> <span class="nf">GenerateSecret</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">secret</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">SecretItem</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;generate secret %q&#34;</span><span class="p">,</span> <span class="nx">resourceName</span><span class="p">)</span>
  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">secret</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">sc</span><span class="p">.</span><span class="nx">outputMutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
    <span class="c1">// 存储获取的证书和私钥到文件中
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">resourceName</span> <span class="o">==</span> <span class="nx">security</span><span class="p">.</span><span class="nx">RootCertReqResourceName</span> <span class="o">||</span> <span class="nx">resourceName</span> <span class="o">==</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadKeyCertResourceName</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">nodeagentutil</span><span class="p">.</span><span class="nf">OutputKeyCertToDir</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">OutputKeyCertToDir</span><span class="p">,</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">PrivateKey</span><span class="p">,</span>
        <span class="nx">secret</span><span class="p">.</span><span class="nx">CertificateChain</span><span class="p">,</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error when output the resource: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">resourceLog</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">).</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;output the resource to %v&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">OutputKeyCertToDir</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">sc</span><span class="p">.</span><span class="nx">outputMutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
  <span class="p">}()</span>

  <span class="c1">// 从文件生成密钥
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">sdsFromFile</span><span class="p">,</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">generateFileSecret</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">);</span> <span class="nx">sdsFromFile</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ns</span><span class="p">,</span> <span class="kc">nil</span>
  <span class="p">}</span>
  <span class="c1">// 获取缓存的证书
</span><span class="c1"></span>  <span class="nx">ns</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">getCachedSecret</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">ns</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ns</span><span class="p">,</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="nx">t0</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
  <span class="nx">sc</span><span class="p">.</span><span class="nx">generateMutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">generateMutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

  <span class="c1">// 获取锁后，再查询一次缓存的证书
</span><span class="c1"></span>  <span class="nx">ns</span> <span class="p">=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">getCachedSecret</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">ns</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ns</span><span class="p">,</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">ts</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">t0</span><span class="p">);</span> <span class="nx">ts</span> <span class="p">&gt;</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="p">{</span>
    <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;slow generate secret lock: %v&#34;</span><span class="p">,</span> <span class="nx">ts</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// 生成 CSR 和私钥，发送请求到 CA 获取工作负载的证书
</span><span class="c1"></span>  <span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">generateNewSecret</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to generate workload certificate: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// 存储 secret 到缓存中，触发工作负载证书的自动更新
</span><span class="c1"></span>  <span class="nx">sc</span><span class="p">.</span><span class="nf">registerSecret</span><span class="p">(</span><span class="o">*</span><span class="nx">ns</span><span class="p">)</span>

  <span class="k">if</span> <span class="nx">resourceName</span> <span class="o">==</span> <span class="nx">security</span><span class="p">.</span><span class="nx">RootCertReqResourceName</span> <span class="p">{</span>
    <span class="nx">ns</span><span class="p">.</span><span class="nx">RootCert</span> <span class="p">=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">mergeTrustAnchorBytes</span><span class="p">(</span><span class="nx">ns</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 假如定期刷新获取了新的根证书，触发根证书请求刷新信任锚
</span><span class="c1"></span>    <span class="nx">oldRoot</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nf">GetRoot</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">oldRoot</span><span class="p">,</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Root cert has changed, start rotating root cert&#34;</span><span class="p">)</span>
      <span class="c1">// We store the oldRoot only for comparison and not for serving
</span><span class="c1"></span>      <span class="nx">sc</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nf">SetRoot</span><span class="p">(</span><span class="nx">ns</span><span class="p">.</span><span class="nx">RootCert</span><span class="p">)</span>
      <span class="nx">sc</span><span class="p">.</span><span class="nf">OnSecretUpdate</span><span class="p">(</span><span class="nx">security</span><span class="p">.</span><span class="nx">RootCertReqResourceName</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">ns</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">SecretManagerClient</span><span class="p">)</span> <span class="nf">generateNewSecret</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">SecretItem</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">trustBundlePEM</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>
  <span class="kd">var</span> <span class="nx">rootCertPEM</span> <span class="p">[]</span><span class="kt">byte</span>

  <span class="k">if</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">caClient</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;attempted to fetch secret, but ca client is nil&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">t0</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
  <span class="nx">logPrefix</span> <span class="o">:=</span> <span class="nf">cacheLogPrefix</span><span class="p">(</span><span class="nx">resourceName</span><span class="p">)</span>
  <span class="c1">// spiffe 身份，spiffe 标准定义了以全自动方式获取和验证加密身份所需的接口和文档
</span><span class="c1"></span>  <span class="nx">csrHostName</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">spiffe</span><span class="p">.</span><span class="nx">Identity</span><span class="p">{</span>
    <span class="nx">TrustDomain</span><span class="p">:</span>    <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">TrustDomain</span><span class="p">,</span>
    <span class="nx">Namespace</span><span class="p">:</span>      <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">WorkloadNamespace</span><span class="p">,</span>
    <span class="nx">ServiceAccount</span><span class="p">:</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">ServiceAccount</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;constructed host name for CSR: %s&#34;</span><span class="p">,</span> <span class="nx">csrHostName</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
  <span class="c1">// CertOptions 用来生成新证书的配置
</span><span class="c1"></span>  <span class="nx">options</span> <span class="o">:=</span> <span class="nx">pkiutil</span><span class="p">.</span><span class="nx">CertOptions</span><span class="p">{</span>
    <span class="nx">Host</span><span class="p">:</span>       <span class="nx">csrHostName</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span>
    <span class="nx">RSAKeySize</span><span class="p">:</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">WorkloadRSAKeySize</span><span class="p">,</span>
    <span class="c1">// 是否是 PKCS#8 私钥
</span><span class="c1"></span>    <span class="nx">PKCS8Key</span><span class="p">:</span>   <span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">Pkcs8Keys</span><span class="p">,</span>
    <span class="c1">// 设置椭圆曲线签名算法，目前只支持 ECDSA
</span><span class="c1"></span>    <span class="nx">ECSigAlg</span><span class="p">:</span>   <span class="nx">pkiutil</span><span class="p">.</span><span class="nf">SupportedECSignatureAlgorithms</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">ECCSigAlg</span><span class="p">),</span>
  <span class="p">}</span>

  <span class="c1">// 生成 X509 证书签名请求和私钥
</span><span class="c1"></span>  <span class="nx">csrPEM</span><span class="p">,</span> <span class="nx">keyPEM</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pkiutil</span><span class="p">.</span><span class="nf">GenCSR</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s failed to generate key and certificate for CSR: %v&#34;</span><span class="p">,</span> <span class="nx">logPrefix</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">numOutgoingRequests</span><span class="p">.</span><span class="nf">With</span><span class="p">(</span><span class="nx">RequestType</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="nx">monitoring</span><span class="p">.</span><span class="nx">CSR</span><span class="p">)).</span><span class="nf">Increment</span><span class="p">()</span>
  <span class="nx">timeBeforeCSR</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
  <span class="c1">// 请求 pilot 的 CA 来签发证书
</span><span class="c1"></span>  <span class="nx">certChainPEM</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">caClient</span><span class="p">.</span><span class="nf">CSRSign</span><span class="p">(</span><span class="nx">csrPEM</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">configOptions</span><span class="p">.</span><span class="nx">SecretTTL</span><span class="p">.</span><span class="nf">Seconds</span><span class="p">()))</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// 获取 CA 根证书
</span><span class="c1"></span>    <span class="nx">trustBundlePEM</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sc</span><span class="p">.</span><span class="nx">caClient</span><span class="p">.</span><span class="nf">GetRootCertBundle</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">certChain</span> <span class="o">:=</span> <span class="nf">concatCerts</span><span class="p">(</span><span class="nx">certChainPEM</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">expireTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
  <span class="c1">// 获取证书过期时间，默认时 createTime+sc.configOptions.SecretTTL
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">expireTime</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">nodeagentutil</span><span class="p">.</span><span class="nf">ParseCertAndGetExpiryTimestamp</span><span class="p">(</span><span class="nx">certChain</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s failed to extract expire time from server certificate in CSR response %+v: %v&#34;</span><span class="p">,</span>
      <span class="nx">logPrefix</span><span class="p">,</span> <span class="nx">certChainPEM</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to extract expire time from server certificate in CSR response: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">cacheLog</span><span class="p">.</span><span class="nf">WithLabels</span><span class="p">(</span><span class="s">&#34;latency&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">t0</span><span class="p">),</span> <span class="s">&#34;ttl&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">expireTime</span><span class="p">)).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;generated new workload certificate&#34;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">trustBundlePEM</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">rootCertPEM</span> <span class="p">=</span> <span class="nf">concatCerts</span><span class="p">(</span><span class="nx">trustBundlePEM</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">rootCertPEM</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">certChainPEM</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">certChainPEM</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">security</span><span class="p">.</span><span class="nx">SecretItem</span><span class="p">{</span>
    <span class="nx">CertificateChain</span><span class="p">:</span> <span class="nx">certChain</span><span class="p">,</span>
    <span class="nx">PrivateKey</span><span class="p">:</span>       <span class="nx">keyPEM</span><span class="p">,</span>
    <span class="nx">ResourceName</span><span class="p">:</span>     <span class="nx">resourceName</span><span class="p">,</span>
    <span class="nx">CreatedTime</span><span class="p">:</span>      <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
    <span class="nx">ExpireTime</span><span class="p">:</span>       <span class="nx">expireTime</span><span class="p">,</span>
    <span class="nx">RootCert</span><span class="p">:</span>         <span class="nx">rootCertPEM</span><span class="p">,</span>
  <span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="sds-grpc-服务">SDS Grpc 服务</h2>
<p>上面的 sds.NewServer 是创建通过 UDS 暴露的 grpc SDS 服务器，其定义如下。其中 OnSecretUpdate 函数，在 secret 有更新时，在 SecretManagerClient.OnSecretUpdate 中调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// security/pkg/nodeagent/sds/server.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">workloadSds</span> <span class="o">*</span><span class="nx">sdsservice</span>
  <span class="nx">grpcWorkloadListener</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
  <span class="nx">grpcWorkloadServer</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span>
  <span class="nx">stopped</span>            <span class="o">*</span><span class="nx">atomic</span><span class="p">.</span><span class="nx">Bool</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">options</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">workloadSecretCache</span> <span class="nx">security</span><span class="p">.</span><span class="nx">SecretManager</span><span class="p">,</span> <span class="nx">pkpConf</span> <span class="o">*</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">PrivateKeyProvider</span><span class="p">)</span> <span class="o">*</span><span class="nx">Server</span> <span class="p">{</span>
  <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span><span class="nx">stopped</span><span class="p">:</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">NewBool</span><span class="p">(</span><span class="kc">false</span><span class="p">)}</span>
  <span class="c1">// 创建 SDS 服务，此服务实现了 envoy SDS API
</span><span class="c1"></span>  <span class="nx">s</span><span class="p">.</span><span class="nx">workloadSds</span> <span class="p">=</span> <span class="nf">newSDSService</span><span class="p">(</span><span class="nx">workloadSecretCache</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">pkpConf</span><span class="p">)</span>
  <span class="nx">s</span><span class="p">.</span><span class="nf">initWorkloadSdsService</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">s</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">initWorkloadSdsService</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span> <span class="p">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nf">grpcServerOptions</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
  <span class="c1">// 添加 SDS handle 到 grpc 服务器
</span><span class="c1"></span>  <span class="nx">s</span><span class="p">.</span><span class="nx">workloadSds</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="c1">// UDS 路径上（/var/run/secrets/workload-spiffe-uds/socket）进行监听，envoy 启动时会连接
</span><span class="c1"></span>  <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadListener</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">uds</span><span class="p">.</span><span class="nf">NewListener</span><span class="p">(</span><span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentitySocketPath</span><span class="p">)</span>
  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting SDS grpc server&#34;</span><span class="p">)</span>
    <span class="nx">waitTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
    <span class="nx">started</span> <span class="o">:=</span> <span class="kc">false</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">maxRetryTimes</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">stopped</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="nx">serverOk</span> <span class="o">:=</span> <span class="kc">true</span>
      <span class="nx">setUpUdsOK</span> <span class="o">:=</span> <span class="kc">true</span>
      <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadListener</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// 接收请求并处理
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadServer</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">grpcWorkloadListener</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;SDS grpc server for workload proxies failed to start: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
          <span class="nx">serverOk</span> <span class="p">=</span> <span class="kc">false</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">serverOk</span> <span class="o">&amp;&amp;</span> <span class="nx">setUpUdsOK</span> <span class="p">{</span>
        <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;SDS server for workload certificates started, listening on %q&#34;</span><span class="p">,</span> <span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadIdentitySocketPath</span><span class="p">)</span>
        <span class="nx">started</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="k">break</span>
      <span class="p">}</span>
      <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">waitTime</span><span class="p">)</span>
      <span class="nx">waitTime</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">started</span> <span class="p">{</span>
      <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;SDS grpc server could not be started&#34;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">OnSecretUpdate</span><span class="p">(</span><span class="nx">resourceName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">workloadSds</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="c1">// 使用 ADS 推送配置更新
</span><span class="c1"></span>  <span class="nx">s</span><span class="p">.</span><span class="nx">workloadSds</span><span class="p">.</span><span class="nx">XdsServer</span><span class="p">.</span><span class="nf">Push</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushRequest</span><span class="p">{</span>
    <span class="nx">Full</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">ConfigsUpdated</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">ConfigKey</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}{</span>
      <span class="p">{</span><span class="nx">Kind</span><span class="p">:</span> <span class="nx">kind</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="nx">Name</span><span class="p">:</span> <span class="nx">resourceName</span><span class="p">}:</span> <span class="p">{},</span>
    <span class="p">},</span>
    <span class="nx">Reason</span><span class="p">:</span> <span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">TriggerReason</span><span class="p">{</span><span class="nx">model</span><span class="p">.</span><span class="nx">SecretTrigger</span><span class="p">},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="sdsservice">sdsservice</h2>
<p>sdsservice 实现了 envoy SDS API。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// security/pkg/nodeagent/sds/sdsservice.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">sdsservice</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">st</span> <span class="nx">security</span><span class="p">.</span><span class="nx">SecretManager</span>

  <span class="nx">XdsServer</span>  <span class="o">*</span><span class="nx">xds</span><span class="p">.</span><span class="nx">DiscoveryServer</span>
  <span class="nx">stop</span>       <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
  <span class="nx">rootCaPath</span> <span class="kt">string</span>
  <span class="nx">pkpConf</span>    <span class="o">*</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">PrivateKeyProvider</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">newSDSService</span><span class="p">(</span><span class="nx">st</span> <span class="nx">security</span><span class="p">.</span><span class="nx">SecretManager</span><span class="p">,</span> <span class="nx">options</span> <span class="o">*</span><span class="nx">security</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">pkpConf</span> <span class="o">*</span><span class="nx">mesh</span><span class="p">.</span><span class="nx">PrivateKeyProvider</span><span class="p">)</span> <span class="o">*</span><span class="nx">sdsservice</span> <span class="p">{</span>
  <span class="nx">ret</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sdsservice</span><span class="p">{</span>
    <span class="nx">st</span><span class="p">:</span>      <span class="nx">st</span><span class="p">,</span>
    <span class="nx">stop</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="nx">pkpConf</span><span class="p">:</span> <span class="nx">pkpConf</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="c1">// pilot 的 grpc 实现，用于接收代理的 SDS 请求
</span><span class="c1"></span>  <span class="nx">ret</span><span class="p">.</span><span class="nx">XdsServer</span> <span class="p">=</span> <span class="nf">NewXdsServer</span><span class="p">(</span><span class="nx">ret</span><span class="p">.</span><span class="nx">stop</span><span class="p">,</span> <span class="nx">ret</span><span class="p">)</span>
  <span class="c1">// 根 CA，cm 配置挂载到目录中获取的
</span><span class="c1"></span>  <span class="nx">ret</span><span class="p">.</span><span class="nx">rootCaPath</span> <span class="p">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">CARootPath</span>

  <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">FileMountedCerts</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ret</span>
  <span class="p">}</span>
  <span class="c1">// 预生成工作负载证书
</span><span class="c1"></span>  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">backoff</span><span class="p">.</span><span class="nf">NewExponentialBackOff</span><span class="p">(</span><span class="nx">backoff</span><span class="p">.</span><span class="nf">DefaultOption</span><span class="p">())</span>
    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">select</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ret</span><span class="p">.</span><span class="nx">stop</span><span class="p">:</span>
        <span class="nf">cancel</span><span class="p">()</span>
      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
      <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
    <span class="nx">_</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">RetryWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="c1">// 获取工作负载证书，设置名称为 default，生成私钥和请求 CA 获取证书
</span><span class="c1"></span>      <span class="c1">// 实际调用的是 SecretManagerClient.GenerateSecret 函数
</span><span class="c1"></span>      <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">GenerateSecret</span><span class="p">(</span><span class="nx">security</span><span class="p">.</span><span class="nx">WorkloadKeyCertResourceName</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;failed to warm certificate: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="c1">// 获取根证书，设置名称为 ROOTCA
</span><span class="c1"></span>      <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">GenerateSecret</span><span class="p">(</span><span class="nx">security</span><span class="p">.</span><span class="nx">RootCertReqResourceName</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">sdsServiceLog</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;failed to warm root certificate: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
  <span class="p">}()</span>

  <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span>

<span class="c1">// 添加 SDS handler 到 grpc 服务器，即 StreamSecrets、DeltaSecrets、FetchSecrets 三个 handler，这里只实现了 StreamSecrets
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sdsservice</span><span class="p">)</span> <span class="nf">register</span><span class="p">(</span><span class="nx">rpcs</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 引用 github.com/envoyproxy/go-control-plane 库
</span><span class="c1"></span>  <span class="nx">sds</span><span class="p">.</span><span class="nf">RegisterSecretDiscoveryServiceServer</span><span class="p">(</span><span class="nx">rpcs</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sdsservice</span><span class="p">)</span> <span class="nf">StreamSecrets</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">sds</span><span class="p">.</span><span class="nx">SecretDiscoveryService_StreamSecretsServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">XdsServer</span><span class="p">.</span><span class="nf">Stream</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sdsservice</span><span class="p">)</span> <span class="nf">DeltaSecrets</span><span class="p">(</span><span class="nx">stream</span> <span class="nx">sds</span><span class="p">.</span><span class="nx">SecretDiscoveryService_DeltaSecretsServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="s">&#34;DeltaSecrets not implemented&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">sdsservice</span><span class="p">)</span> <span class="nf">FetchSecrets</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">discReq</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="s">&#34;FetchSecrets not implemented&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// xds 发现服务，用来接收代理的 SDS 请求
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewXdsServer</span><span class="p">(</span><span class="nx">stop</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="nx">gen</span> <span class="nx">model</span><span class="p">.</span><span class="nx">XdsResourceGenerator</span><span class="p">)</span> <span class="o">*</span><span class="nx">xds</span><span class="p">.</span><span class="nx">DiscoveryServer</span> <span class="p">{</span>
  <span class="c1">// 创建基本的，功能性的发现服务，使用和 istiod 一样的代码，但用的时内存配置和 endpoints 存储
</span><span class="c1"></span>  <span class="nx">s</span> <span class="o">:=</span> <span class="nx">xds</span><span class="p">.</span><span class="nf">NewXDS</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
  <span class="c1">// 设置不限流
</span><span class="c1"></span>  <span class="nx">s</span><span class="p">.</span><span class="nx">DiscoveryServer</span><span class="p">.</span><span class="nx">RequestRateLimit</span> <span class="p">=</span> <span class="nx">rate</span><span class="p">.</span><span class="nf">NewLimiter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">DiscoveryServer</span><span class="p">.</span><span class="nx">Generators</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">model</span><span class="p">.</span><span class="nx">XdsResourceGenerator</span><span class="p">{</span>
    <span class="nx">v3</span><span class="p">.</span><span class="nx">SecretType</span><span class="p">:</span> <span class="nx">gen</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="c1">// 决定是否需要推送给代理
</span><span class="c1"></span>  <span class="nx">s</span><span class="p">.</span><span class="nx">DiscoveryServer</span><span class="p">.</span><span class="nx">ProxyNeedsPush</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">proxy</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Proxy</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushRequest</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="nx">s</span><span class="p">.</span><span class="nx">DiscoveryServer</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">DiscoveryServer</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="registersecretdiscoveryserviceserver">RegisterSecretDiscoveryServiceServer</h2>
<p>主要是注册 grcp 的方法，具体方案名称如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// github.com/envoyproxy/go-control-plane/envoy/service/secret/v3/sds.pb.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">RegisterSecretDiscoveryServiceServer</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">srv</span> <span class="nx">SecretDiscoveryServiceServer</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">s</span><span class="p">.</span><span class="nf">RegisterService</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_SecretDiscoveryService_serviceDesc</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">_SecretDiscoveryService_serviceDesc</span> <span class="p">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ServiceDesc</span><span class="p">{</span>
  <span class="nx">ServiceName</span><span class="p">:</span> <span class="s">&#34;envoy.service.secret.v3.SecretDiscoveryService&#34;</span><span class="p">,</span>
  <span class="nx">HandlerType</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="nx">SecretDiscoveryServiceServer</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span>
  <span class="nx">Methods</span><span class="p">:</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">MethodDesc</span><span class="p">{</span>
    <span class="p">{</span>
      <span class="nx">MethodName</span><span class="p">:</span> <span class="s">&#34;FetchSecrets&#34;</span><span class="p">,</span>
      <span class="nx">Handler</span><span class="p">:</span>    <span class="nx">_SecretDiscoveryService_FetchSecrets_Handler</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">Streams</span><span class="p">:</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">StreamDesc</span><span class="p">{</span>
    <span class="p">{</span>
      <span class="nx">StreamName</span><span class="p">:</span>    <span class="s">&#34;DeltaSecrets&#34;</span><span class="p">,</span>
      <span class="nx">Handler</span><span class="p">:</span>       <span class="nx">_SecretDiscoveryService_DeltaSecrets_Handler</span><span class="p">,</span>
      <span class="nx">ServerStreams</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">ClientStreams</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">StreamName</span><span class="p">:</span>    <span class="s">&#34;StreamSecrets&#34;</span><span class="p">,</span>
      <span class="nx">Handler</span><span class="p">:</span>       <span class="nx">_SecretDiscoveryService_StreamSecrets_Handler</span><span class="p">,</span>
      <span class="nx">ServerStreams</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">ClientStreams</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">Metadata</span><span class="p">:</span> <span class="s">&#34;envoy/service/secret/v3/sds.proto&#34;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="xdsproxy">XdsProxy</h2>
<p>XdsProxy 代理所有 envoy 到 istiod 的 XDS 请求（为啥 envoy 不直接连接 istiod？？看启动配置中有 istiod 配置），即连接逻辑为 envoy&lt;-&gt;XDS Proxy&lt;-&gt;istiod，此外还允许 agent 内部的子系统可以和 istiod/envoy 通信。目的是将所有到 istiod 和 envoy 的 xds 相关连接，用多个 grpc 流统一到单个 tcp 连接中。</p>
<p>在 handleStream 函数中，涉及到背压流控，即 XdsProxy 充当了管道，连接 envoy 和 istiod，两端的处理速度不一样会导致阻塞，参考 <a href="https://lotabout.me/2020/Back-Pressure/">背压与流量控制</a> 了解。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/istio-agent/xds_proxy.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">XdsProxy</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">stopChan</span>             <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
  <span class="nx">clusterID</span>            <span class="kt">string</span>
  <span class="nx">downstreamListener</span>   <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
  <span class="nx">downstreamGrpcServer</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">Server</span>
  <span class="nx">istiodAddress</span>        <span class="kt">string</span>
  <span class="nx">istiodDialOptions</span>    <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">DialOption</span>
  <span class="nx">optsMutex</span>            <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
  <span class="nx">handlers</span>             <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">ResponseHandler</span>
  <span class="nx">healthChecker</span>        <span class="o">*</span><span class="nx">health</span><span class="p">.</span><span class="nx">WorkloadHealthChecker</span>
  <span class="nx">xdsHeaders</span>           <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
  <span class="nx">xdsUdsPath</span>           <span class="kt">string</span>
  <span class="nx">proxyAddresses</span>       <span class="p">[]</span><span class="kt">string</span>
  <span class="nx">ia</span>                   <span class="o">*</span><span class="nx">Agent</span>

  <span class="nx">httpTapServer</span>      <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span>
  <span class="nx">tapMutex</span>           <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
  <span class="nx">tapResponseChannel</span> <span class="kd">chan</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryResponse</span>

  <span class="nx">connected</span>                 <span class="o">*</span><span class="nx">ProxyConnection</span>
  <span class="nx">initialHealthRequest</span>      <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryRequest</span>
  <span class="nx">initialDeltaHealthRequest</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DeltaDiscoveryRequest</span>
  <span class="nx">connectedMutex</span>            <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>

  <span class="nx">wasmCache</span> <span class="nx">wasm</span><span class="p">.</span><span class="nx">Cache</span>
  <span class="nx">ecdsLastAckVersion</span>    <span class="nx">atomic</span><span class="p">.</span><span class="nx">String</span>
  <span class="nx">ecdsLastNonce</span>         <span class="nx">atomic</span><span class="p">.</span><span class="nx">String</span>
  <span class="nx">downstreamGrpcOptions</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerOption</span>
  <span class="nx">istiodSAN</span>             <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">initXdsProxy</span><span class="p">(</span><span class="nx">ia</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">XdsProxy</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="nx">localHostAddr</span> <span class="o">:=</span> <span class="nx">localHostIPv4</span>
  <span class="k">if</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">IsIPv6</span> <span class="p">{</span>
    <span class="nx">localHostAddr</span> <span class="p">=</span> <span class="nx">localHostIPv6</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">envoyProbe</span> <span class="nx">ready</span><span class="p">.</span><span class="nx">Prober</span>
  <span class="k">if</span> <span class="p">!</span><span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DisableEnvoy</span> <span class="p">{</span>
    <span class="nx">envoyProbe</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">ready</span><span class="p">.</span><span class="nx">Probe</span><span class="p">{</span>
      <span class="nx">AdminPort</span><span class="p">:</span>     <span class="nb">uint16</span><span class="p">(</span><span class="nx">ia</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">ProxyAdminPort</span><span class="p">),</span>
      <span class="nx">LocalHostAddr</span><span class="p">:</span> <span class="nx">localHostAddr</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 创建一个 wasm 缓存，用来在本地下载和存储 wasm 模块文件，见 [istio 扩展性](https://istio.io/latest/docs/concepts/wasm/)
</span><span class="c1"></span>  <span class="nx">cache</span> <span class="o">:=</span> <span class="nx">wasm</span><span class="p">.</span><span class="nf">NewLocalFileCache</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">IstioDataDir</span><span class="p">,</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">WASMOptions</span><span class="p">)</span>
  <span class="nx">proxy</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">XdsProxy</span><span class="p">{</span>
    <span class="nx">istiodAddress</span><span class="p">:</span>         <span class="nx">ia</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">DiscoveryAddress</span><span class="p">,</span>
    <span class="nx">istiodSAN</span><span class="p">:</span>             <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">IstiodSAN</span><span class="p">,</span>
    <span class="nx">clusterID</span><span class="p">:</span>             <span class="nx">ia</span><span class="p">.</span><span class="nx">secOpts</span><span class="p">.</span><span class="nx">ClusterID</span><span class="p">,</span>
    <span class="nx">handlers</span><span class="p">:</span>              <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">ResponseHandler</span><span class="p">{},</span>
    <span class="nx">stopChan</span><span class="p">:</span>              <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="nx">healthChecker</span><span class="p">:</span>         <span class="nx">health</span><span class="p">.</span><span class="nf">NewWorkloadHealthChecker</span><span class="p">(</span><span class="nx">ia</span><span class="p">.</span><span class="nx">proxyConfig</span><span class="p">.</span><span class="nx">ReadinessProbe</span><span class="p">,</span> <span class="nx">envoyProbe</span><span class="p">,</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyIPAddresses</span><span class="p">,</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">IsIPv6</span><span class="p">),</span>
    <span class="nx">xdsHeaders</span><span class="p">:</span>            <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">XDSHeaders</span><span class="p">,</span>
    <span class="nx">xdsUdsPath</span><span class="p">:</span>            <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">XdsUdsPath</span><span class="p">,</span>
    <span class="nx">wasmCache</span><span class="p">:</span>             <span class="nx">cache</span><span class="p">,</span>
    <span class="nx">proxyAddresses</span><span class="p">:</span>        <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyIPAddresses</span><span class="p">,</span>
    <span class="nx">ia</span><span class="p">:</span>                    <span class="nx">ia</span><span class="p">,</span>
    <span class="nx">downstreamGrpcOptions</span><span class="p">:</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DownstreamGrpcOptions</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">localDNSServer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// 设置 NameTable 的 handler，获取后需要更新 dns 服务
</span><span class="c1"></span>    <span class="nx">proxy</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">v3</span><span class="p">.</span><span class="nx">NameTableType</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">anypb</span><span class="p">.</span><span class="nx">Any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nt</span> <span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">UnmarshalTo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nt</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to unmarshal name table: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="nx">ia</span><span class="p">.</span><span class="nx">localDNSServer</span><span class="p">.</span><span class="nf">UpdateLookupTable</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nt</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 开启动态获取 proxy 配置
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">EnableDynamicProxyConfig</span> <span class="o">&amp;&amp;</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">secretCache</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// 获取代理配置的 handler，主要是更新信任包（包含信任域公钥的文件）
</span><span class="c1"></span>    <span class="nx">proxy</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">v3</span><span class="p">.</span><span class="nx">ProxyConfigType</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">anypb</span><span class="p">.</span><span class="nx">Any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="nx">pc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">meshconfig</span><span class="p">.</span><span class="nx">ProxyConfig</span><span class="p">{}</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">UnmarshalTo</span><span class="p">(</span><span class="nx">pc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to unmarshal proxy config: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="nx">caCerts</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">GetCaCertificatesPem</span><span class="p">()</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;received new certificates to add to mesh trust domain: %v&#34;</span><span class="p">,</span> <span class="nx">caCerts</span><span class="p">)</span>
      <span class="nx">trustBundle</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cert</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">caCerts</span> <span class="p">{</span>
        <span class="nx">trustBundle</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">AppendCertByte</span><span class="p">(</span><span class="nx">trustBundle</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cert</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">secretCache</span><span class="p">.</span><span class="nf">UpdateConfigTrustBundle</span><span class="p">(</span><span class="nx">trustBundle</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 日志示例：Initializing with upstream address &#34;istiod.istio-system.svc:15012&#34; and cluster &#34;cluster1&#34;
</span><span class="c1"></span>  <span class="nx">proxyLog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Initializing with upstream address %q and cluster %q&#34;</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">istiodAddress</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">clusterID</span><span class="p">)</span>
  <span class="c1">// 初始化下游服务器，即创建 grpc 服务，设置聚合发现服务 handler 为 XdsProxy
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">initDownstreamServer</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="c1">// 初始化上游客户端连接配置，即用证书信息出事 tls 连接
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nf">initIstiodDialOptions</span><span class="p">(</span><span class="nx">ia</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 开始接收下游连接
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">downstreamGrpcServer</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">downstreamListener</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to accept downstream gRPC connection %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}()</span>

  <span class="k">return</span> <span class="nx">proxy</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// XDS API 的实现，用来在 istiod 和 envoy 之间代理，envoy 每次请求 pilot-agent 时，就重建一个连接到上游的 xds，确保 istiod 和 pilot-agent 的新连接不会最终消耗待处理的消息，因为新连接可能不会连接到同一个 istiod。
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">XdsProxy</span><span class="p">)</span> <span class="nf">StreamAggregatedResources</span><span class="p">(</span><span class="nx">downstream</span> <span class="nx">xds</span><span class="p">.</span><span class="nx">DiscoveryStream</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">proxyLog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;accepted XDS connection from Envoy, forwarding to upstream XDS server&#34;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">handleStream</span><span class="p">(</span><span class="nx">downstream</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">XdsProxy</span><span class="p">)</span> <span class="nf">handleStream</span><span class="p">(</span><span class="nx">downstream</span> <span class="nx">adsStream</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">con</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ProxyConnection</span><span class="p">{</span>
    <span class="nx">conID</span><span class="p">:</span>           <span class="nx">connectionNumber</span><span class="p">.</span><span class="nf">Inc</span><span class="p">(),</span>
    <span class="nx">upstreamError</span><span class="p">:</span>   <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="c1">// can be produced by recv and send
</span><span class="c1"></span>    <span class="nx">downstreamError</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="c1">// can be produced by recv and send
</span><span class="c1"></span>    <span class="c1">// 请求 channel 无限大，envoy&lt;-&gt;XDS Proxy&lt;-&gt;istiod 系统产生了接收和发送天然循环。因为 grpc
</span><span class="c1"></span>    <span class="nx">requestsChan</span><span class="p">:</span> <span class="nx">channels</span><span class="p">.</span><span class="nx">NewUnbounded</span><span class="p">[</span><span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryRequest</span><span class="p">](),</span>
    <span class="c1">// Allow a buffer of 1. This ensures we queue up at most 2 (one in process, 1 pending) responses before forwarding.
</span><span class="c1"></span>    <span class="nx">responsesChan</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryResponse</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="nx">stopChan</span><span class="p">:</span>      <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
    <span class="nx">downstream</span><span class="p">:</span>    <span class="nx">downstream</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="c1">// 注册下游连接
</span><span class="c1"></span>  <span class="nx">p</span><span class="p">.</span><span class="nf">registerStream</span><span class="p">(</span><span class="nx">con</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nf">unregisterStream</span><span class="p">(</span><span class="nx">con</span><span class="p">)</span>

  <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
  <span class="c1">// 新创建到上游 istiod 的连接
</span><span class="c1"></span>  <span class="nx">upstreamConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">buildUpstreamConn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">defer</span> <span class="nx">upstreamConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
  <span class="c1">// 创建上游 ADS 的 client
</span><span class="c1"></span>  <span class="nx">xds</span> <span class="o">:=</span> <span class="nx">discovery</span><span class="p">.</span><span class="nf">NewAggregatedDiscoveryServiceClient</span><span class="p">(</span><span class="nx">upstreamConn</span><span class="p">)</span>
  <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">AppendToOutgoingContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;ClusterID&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">clusterID</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">p</span><span class="p">.</span><span class="nx">xdsHeaders</span> <span class="p">{</span>
    <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">AppendToOutgoingContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// s
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">handleUpstream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">con</span><span class="p">,</span> <span class="nx">xds</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">XdsProxy</span><span class="p">)</span> <span class="nf">handleUpstream</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">con</span> <span class="o">*</span><span class="nx">ProxyConnection</span><span class="p">,</span> <span class="nx">xds</span> <span class="nx">discovery</span><span class="p">.</span><span class="nx">AggregatedDiscoveryServiceClient</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">upstream</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">xds</span><span class="p">.</span><span class="nf">StreamAggregatedResources</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span>
    <span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallRecvMsgSize</span><span class="p">(</span><span class="nx">defaultClientMaxReceiveMessageSize</span><span class="p">))</span>
  <span class="c1">// ...
</span><span class="c1"></span>
  <span class="nx">con</span><span class="p">.</span><span class="nx">upstream</span> <span class="p">=</span> <span class="nx">upstream</span>

  <span class="c1">// 处理上游的 xds 推送
</span><span class="c1"></span>  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
      <span class="c1">// 获取推送内容
</span><span class="c1"></span>      <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">con</span><span class="p">.</span><span class="nx">upstream</span><span class="p">.</span><span class="nf">Recv</span><span class="p">()</span>
      <span class="c1">// ...
</span><span class="c1"></span>      <span class="k">select</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">con</span><span class="p">.</span><span class="nx">responsesChan</span> <span class="o">&lt;-</span> <span class="nx">resp</span><span class="p">:</span>
      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">con</span><span class="p">.</span><span class="nx">stopChan</span><span class="p">:</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}()</span>
  <span class="c1">// 处理对上游的请求，即获取 envoy 的 request，并转发给 istiod
</span><span class="c1"></span>  <span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">handleUpstreamRequest</span><span class="p">(</span><span class="nx">con</span><span class="p">)</span>
  <span class="c1">// 接收上游 istiod 的响应，转发给 envoy
</span><span class="c1"></span>  <span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">handleUpstreamResponse</span><span class="p">(</span><span class="nx">con</span><span class="p">)</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="k">select</span> <span class="p">{</span>
      <span class="c1">// ... 处理错误
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">XdsProxy</span><span class="p">)</span> <span class="nf">handleUpstreamResponse</span><span class="p">(</span><span class="nx">con</span> <span class="o">*</span><span class="nx">ProxyConnection</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">forwardEnvoyCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryResponse</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="k">select</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">resp</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">con</span><span class="p">.</span><span class="nx">responsesChan</span><span class="p">:</span>
      <span class="nx">proxyLog</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;response for type url %s&#34;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">TypeUrl</span><span class="p">)</span>
      <span class="nx">metrics</span><span class="p">.</span><span class="nx">XdsProxyResponses</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
      <span class="c1">// v3.NameTableType/v3.ProxyConfigType 更新是在 pilot-agent 处理，是在 initXdsProxy 函数中设置的
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">resp</span><span class="p">.</span><span class="nx">TypeUrl</span><span class="p">];</span> <span class="nx">f</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Resources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
          <span class="k">break</span>
        <span class="p">}</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nf">h</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Resources</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="kd">var</span> <span class="nx">errorResp</span> <span class="o">*</span><span class="nx">google_rpc</span><span class="p">.</span><span class="nx">Status</span>
        <span class="c1">// Send ACK/NACK
</span><span class="c1"></span>        <span class="nx">con</span><span class="p">.</span><span class="nf">sendRequest</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryRequest</span><span class="p">{</span>
          <span class="nx">VersionInfo</span><span class="p">:</span>   <span class="nx">resp</span><span class="p">.</span><span class="nx">VersionInfo</span><span class="p">,</span>
          <span class="nx">TypeUrl</span><span class="p">:</span>       <span class="nx">resp</span><span class="p">.</span><span class="nx">TypeUrl</span><span class="p">,</span>
          <span class="nx">ResponseNonce</span><span class="p">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Nonce</span><span class="p">,</span>
          <span class="nx">ErrorDetail</span><span class="p">:</span>   <span class="nx">errorResp</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">continue</span>
      <span class="p">}</span>
      <span class="c1">// 其他类型转发给 envoy
</span><span class="c1"></span>      <span class="k">switch</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">TypeUrl</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">ExtensionConfigurationType</span><span class="p">:</span>
        <span class="k">if</span> <span class="nx">features</span><span class="p">.</span><span class="nx">WasmRemoteLoadConversion</span> <span class="p">{</span>
          <span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">rewriteAndForward</span><span class="p">(</span><span class="nx">con</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">discovery</span><span class="p">.</span><span class="nx">DiscoveryResponse</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">forwardEnvoyCh</span> <span class="o">&lt;-</span> <span class="nx">resp</span><span class="p">:</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">con</span><span class="p">.</span><span class="nx">stopChan</span><span class="p">:</span>
            <span class="p">}</span>
          <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">forwardToEnvoy</span><span class="p">(</span><span class="nx">con</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="k">default</span><span class="p">:</span>
        <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">TypeUrl</span><span class="p">,</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">DebugType</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">p</span><span class="p">.</span><span class="nf">forwardToTap</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">forwardToEnvoy</span><span class="p">(</span><span class="nx">con</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="k">case</span> <span class="nx">resp</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">forwardEnvoyCh</span><span class="p">:</span>
      <span class="nf">forwardToEnvoy</span><span class="p">(</span><span class="nx">con</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">con</span><span class="p">.</span><span class="nx">stopChan</span><span class="p">:</span>
      <span class="k">return</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="envoy-agent">envoy agent</h2>
<p>envoy 目录下的 Agent 结构，用于管理运行 envoy 命令的结构 Proxy，负责 Proxy 的启动和清理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/envoy/agent.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Agent</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// proxy commands
</span><span class="c1"></span>  <span class="nx">proxy</span> <span class="nx">Proxy</span>

  <span class="c1">// channel for proxy exit notifications
</span><span class="c1"></span>  <span class="nx">statusCh</span> <span class="kd">chan</span> <span class="nx">exitStatus</span>

  <span class="nx">abortCh</span> <span class="kd">chan</span> <span class="kt">error</span>

  <span class="c1">// time to allow for the proxy to drain before terminating all remaining proxy processes
</span><span class="c1"></span>  <span class="nx">terminationDrainDuration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
  <span class="nx">minDrainDuration</span>         <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

  <span class="nx">adminPort</span> <span class="kt">int</span>
  <span class="nx">localhost</span> <span class="kt">string</span>

  <span class="nx">knownIstioListeners</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">String</span>

  <span class="nx">exitOnZeroActiveConnections</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// 创建一个 proxy agent，用于 envoy 的启动和清理功能
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewAgent</span><span class="p">(</span><span class="nx">proxy</span> <span class="nx">Proxy</span><span class="p">,</span> <span class="nx">terminationDrainDuration</span><span class="p">,</span> <span class="nx">minDrainDuration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">localhost</span> <span class="kt">string</span><span class="p">,</span>
  <span class="nx">adminPort</span><span class="p">,</span> <span class="nx">statusPort</span><span class="p">,</span> <span class="nx">prometheusPort</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">exitOnZeroActiveConnections</span> <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="nx">Agent</span> <span class="p">{</span>
  <span class="nx">knownIstioListeners</span> <span class="o">:=</span> <span class="nx">sets</span><span class="p">.</span><span class="nx">New</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;listener.0.0.0.0_%d.downstream_cx_active&#34;</span><span class="p">,</span> <span class="nx">statusPort</span><span class="p">),</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;listener.0.0.0.0_%d.downstream_cx_active&#34;</span><span class="p">,</span> <span class="nx">prometheusPort</span><span class="p">),</span>
    <span class="s">&#34;listener.admin.downstream_cx_active&#34;</span><span class="p">,</span>
    <span class="s">&#34;listener.admin.main_thread.downstream_cx_active&#34;</span><span class="p">,</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Agent</span><span class="p">{</span>
    <span class="nx">proxy</span><span class="p">:</span>                       <span class="nx">proxy</span><span class="p">,</span>
    <span class="nx">statusCh</span><span class="p">:</span>                    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">exitStatus</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="c1">// context might stop drainage
</span><span class="c1"></span>    <span class="nx">abortCh</span><span class="p">:</span>                     <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="nx">terminationDrainDuration</span><span class="p">:</span>    <span class="nx">terminationDrainDuration</span><span class="p">,</span>
    <span class="nx">minDrainDuration</span><span class="p">:</span>            <span class="nx">minDrainDuration</span><span class="p">,</span>
    <span class="nx">exitOnZeroActiveConnections</span><span class="p">:</span> <span class="nx">exitOnZeroActiveConnections</span><span class="p">,</span>
    <span class="nx">adminPort</span><span class="p">:</span>                   <span class="nx">adminPort</span><span class="p">,</span>
    <span class="nx">localhost</span><span class="p">:</span>                   <span class="nx">localhost</span><span class="p">,</span>
    <span class="nx">knownIstioListeners</span><span class="p">:</span>         <span class="nx">knownIstioListeners</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 启动 envoy 并一直等待 envoy 终止
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting proxy agent&#34;</span><span class="p">)</span>
  <span class="c1">// 用 go routine 启动命令，等待完成
</span><span class="c1"></span>  <span class="k">go</span> <span class="nx">a</span><span class="p">.</span><span class="nf">runWait</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">abortCh</span><span class="p">)</span>

  <span class="k">select</span> <span class="p">{</span>
  <span class="k">case</span> <span class="nx">status</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">a</span><span class="p">.</span><span class="nx">statusCh</span><span class="p">:</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
    <span class="nx">a</span><span class="p">.</span><span class="nf">terminate</span><span class="p">()</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">runWait</span><span class="p">(</span><span class="nx">abortCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;starting&#34;</span><span class="p">)</span>
  <span class="c1">// 启动 proxy
</span><span class="c1"></span>  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">abortCh</span><span class="p">)</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nf">Cleanup</span><span class="p">()</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">statusCh</span> <span class="o">&lt;-</span> <span class="nx">exitStatus</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="envoy-proxy">envoy proxy</h2>
<p>envoy 目录下 envoy 结构体实现了 Proxy 接口，用于组装参数，启动 envoy 命令。在上面的 Agent 结构中会调用 envoy 结构的 Run 和 Cleanup 函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/envoy/proxy.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">envoy</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ProxyConfig</span>
  <span class="nx">extraArgs</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">ProxyConfig</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">LogLevel</span>          <span class="kt">string</span>
  <span class="nx">ComponentLogLevel</span> <span class="kt">string</span>
  <span class="nx">NodeIPs</span>           <span class="p">[]</span><span class="kt">string</span>
  <span class="nx">Sidecar</span>           <span class="kt">bool</span>
  <span class="nx">LogAsJSON</span>         <span class="kt">bool</span>
  <span class="nx">OutlierLogPath</span> <span class="kt">string</span>

  <span class="nx">BinaryPath</span>             <span class="kt">string</span>
  <span class="nx">ConfigPath</span>             <span class="kt">string</span>
  <span class="nx">ConfigCleanup</span>          <span class="kt">bool</span>
  <span class="nx">AdminPort</span>              <span class="kt">int32</span>
  <span class="nx">DrainDuration</span>          <span class="o">*</span><span class="nx">durationpb</span><span class="p">.</span><span class="nx">Duration</span>
  <span class="nx">ParentShutdownDuration</span> <span class="o">*</span><span class="nx">durationpb</span><span class="p">.</span><span class="nx">Duration</span>
  <span class="nx">Concurrency</span>            <span class="kt">int32</span>

  <span class="nx">TestOnly</span>    <span class="kt">bool</span>
  <span class="nx">AgentIsRoot</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// 代理控制命令实例
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewProxy</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">ProxyConfig</span><span class="p">)</span> <span class="nx">Proxy</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span>
  <span class="nx">logLevel</span><span class="p">,</span> <span class="nx">componentLogs</span> <span class="o">:=</span> <span class="nf">splitComponentLog</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">LogLevel</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">logLevel</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34;-l&#34;</span><span class="p">,</span> <span class="nx">logLevel</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">componentLogs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34;--component-log-level&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">componentLogs</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ComponentLogLevel</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="c1">// Use the old setting if we don&#39;t set any component log levels in LogLevel
</span><span class="c1"></span>    <span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34;--component-log-level&#34;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ComponentLogLevel</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">envoy</span><span class="p">{</span>
    <span class="nx">ProxyConfig</span><span class="p">:</span> <span class="nx">cfg</span><span class="p">,</span>
    <span class="nx">extraArgs</span><span class="p">:</span>   <span class="nx">args</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">envoy</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">abort</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="c1">// 启动一个新的 envoy 进程
</span><span class="c1"></span>  <span class="nx">args</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">args</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ConfigPath</span><span class="p">,</span> <span class="nx">istioBootstrapOverrideVar</span><span class="p">.</span><span class="nf">Get</span><span class="p">())</span>
  <span class="c1">// 日志示例：Envoy command: [-c etc/istio/proxy/envoy-rev.json --drain-time-s 45 --drain-strategy immediate --parent-shutdown-time-s 60 --local-address-ip-version v4 --file-flush-interval-msec 1000 --disable-hot-restart --log-format %Y-%m-%dT%T.%fZ     %l      envoy %n        %v -l warning --component-log-level misc:error --concurrency 2]
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Envoy command: %v&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
  <span class="c1">// 组装启动 Cmd
</span><span class="c1"></span>  <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">BinaryPath</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
  <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
  <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>
  <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">AgentIsRoot</span> <span class="p">{</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{}</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">.</span><span class="nx">Credential</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
      <span class="nx">Uid</span><span class="p">:</span> <span class="mi">1337</span><span class="p">,</span>
      <span class="nx">Gid</span><span class="p">:</span> <span class="mi">1337</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// 启动 envoy 命令
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">done</span> <span class="o">&lt;-</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
  <span class="p">}()</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">envoy</span><span class="p">)</span> <span class="nf">Cleanup</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ConfigCleanup</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ConfigPath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;Failed to delete config file %s: %v&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ConfigPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="istio-证书逻辑">istio 证书逻辑</h1>
<p>pilot-agent 代码中主要涉及到证书和 XDS，这里再根据实际的配置实例说明下 istio 的证书逻辑。Istio 使用 X.509 证书安全地为每个工作负载提供强身份，应用 sidecar 容器中的 istio-agent 会负责密钥和证书的自动更新，流程图如下：
<img src="https://istio.io/latest/docs/concepts/security/id-prov.svg" alt="identify_provision_workflow" title="身份发放流程：图片来自网络"></p>
<p>Istio 通过下面流程来提供密钥和证书：</p>
<ul>
<li>istiod 提供一个用于接收 CSRs（证书签名请求）的 grpc 服务</li>
<li>当 istio-agent 启动时，创建私钥和 CSR，将带有证书的 CSR 发送给 istiod</li>
<li>istiod 中的 CA（认证中心）校验 CSR 中的证书，成功后就签署 CSR 以生成证书</li>
<li>当工作负载启动后，envoy 通过 SDS（secret 服务发现）API 来请求证书和密钥</li>
<li>istio-agent 发送私钥和从 istiod 中收到的证书给 envoy</li>
<li>istio-agent 监视负载的证书过期时间，一旦过期则重复上面的流程</li>
</ul>
<p>istio 提供了两种类型的认证器：</p>
<ul>
<li>对等认证：用于服务对服务身份验证，基于 mTLS</li>
<li>请求认证：用于终端用户认证，校验请求的证书，基于 JWT token</li>
</ul>
<p>在认证中会多次提到主题备用名称（Subject Alternative Name，缩写 SAN），允许在安全证书中使用 subjectAltName 字段将多种值与证书关联，即为单个 SSL 证书指定其他主机名。</p>
<p>需要注意的是，这里使用的是 mTLS，即双向 TLS。对 Web 服务的访问一般使用单向 TLS，只需要服务端提供身份证明，如果服务端需要验证客户身份时，可以在代码中使用密码、token、双因子认证等方式认证。而双向 TLS 需要同时校验服务端和客户端的身份，运行在应用程序之外，不需要修改应用程序。</p>
<h2 id="sidecar-证书配置">sidecar 证书配置</h2>
<p>通过下面的命令导出 envoy 的完整配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">istioctl proxy-config all sleep-78ff5975c6-4xpv4 -nsample -o json &gt; sleep.json
</code></pre></td></tr></table>
</div>
</div><p>envoy 配置的 SDS 服务发现地址配置如下，其中 pipe 设置的是 unix domain socket 地址，这是 pilot-agent 提供的 grpc 服务，两个服务在同一个容器中，因此使用的 socket。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span><span class="p">,</span>
    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;STATIC&#34;</span><span class="p">,</span>
    <span class="nt">&#34;connect_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;1s&#34;</span><span class="p">,</span>
    <span class="nt">&#34;load_assignment&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span><span class="p">,</span>
     <span class="nt">&#34;endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
       <span class="nt">&#34;lb_endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
         <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;pipe&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;./var/run/secrets/workload-spiffe-uds/socket&#34;</span>
           <span class="p">}</span>
          <span class="p">}</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">]</span>
      <span class="p">}</span>
     <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&#34;typed_extension_protocol_options&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;</span><span class="p">,</span>
      <span class="nt">&#34;explicit_http_config&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;http2_protocol_options&#34;</span><span class="p">:</span> <span class="p">{}</span>
      <span class="p">}</span>
     <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 enovy 边车配置中，有两处需要通过 SDS 来配置证书</p>
<ul>
<li>Inbound Listener，用于接收下游的请求对外提供服务，设置了类型为 DownstreamTlsContext 的 tls 传输协议，里面指定了通过 SDS API 获取的 tls 证书。本地做服务器使用证书逻辑为：
<ul>
<li>default 证书：客户端连接时，向请求方发送 default 证书公钥，自己用 default 证书私钥，来进行 TLS 的认证</li>
<li>ROOTCA 证书：客户端连接时，用 ROOTCA 证书校验客户端的证书，并校验客户端证书中的 SAN（安装 Istio 时通过参数 values.global.trustDomain 指定了信任域）</li>
</ul>
</li>
<li>Outbound Cluster：用于请求上游服务器，设置了 upstreamTlsContext 中的配置，里面设置了客户端证书、私钥，以及验证上游服务器端的 CA 根证书。本地做客户端使用证书逻辑为：
<ul>
<li>default 证书：连接服务端时，向服务端发送 default 证书公钥，用来证明自己的身份</li>
<li>ROOTCA 证书：连接服务端时，用 ROOTCA 证书校验服务端的证书，并校验服务端证书中的 SAN</li>
</ul>
</li>
</ul>
<p>先来看下 Inbound Listener 相关配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;virtualInbound&#34;</span><span class="p">,</span>
    <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-17T04:44:27Z/14&#34;</span><span class="p">,</span>
     <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// listener 配置
</span><span class="c1"></span>      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;virtualInbound&#34;</span><span class="p">,</span>
      <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span>
        <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">15006</span>     <span class="c1">// 15006 端口监听请求
</span><span class="c1"></span>       <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;filter_chains&#34;</span><span class="p">:</span> <span class="p">[</span>
       <span class="p">{</span>
        <span class="nt">&#34;filter_chain_match&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;destination_port&#34;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>    <span class="c1">// 向 sleep 服务的 80 端口请求
</span><span class="c1"></span>         <span class="nt">&#34;transport_protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;tls&#34;</span><span class="p">,</span>   <span class="c1">// tls 协议
</span><span class="c1"></span>         <span class="nt">&#34;application_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&#34;istio&#34;</span><span class="p">,</span>
          <span class="s2">&#34;istio-peer-exchange&#34;</span><span class="p">,</span>
          <span class="s2">&#34;istio-http/1.0&#34;</span><span class="p">,</span>
          <span class="s2">&#34;istio-http/1.1&#34;</span><span class="p">,</span>
          <span class="s2">&#34;istio-h2&#34;</span>
         <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;istio.metadata_exchange&#34;</span>
         <span class="p">},</span>
         <span class="p">{</span>
          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.http_connection_manager&#34;</span><span class="p">,</span>
          <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class="p">,</span>
           <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_0.0.0.0_80&#34;</span><span class="p">,</span>
          <span class="p">}</span>
         <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span> <span class="c1">// 见 [tls 传输 socket](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/tls.proto.html)
</span><span class="c1"></span>         <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 配置为下游 tls
</span><span class="c1"></span>          <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext&#34;</span><span class="p">,</span>
          <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;tls_minimum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_2&#34;</span><span class="p">,</span>
            <span class="nt">&#34;tls_maximum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span><span class="p">,</span>
            <span class="nt">&#34;cipher_suites&#34;</span><span class="p">:</span> <span class="p">[</span>  <span class="c1">// 加密套件
</span><span class="c1"></span>             <span class="s2">&#34;ECDHE-ECDSA-AES256-GCM-SHA384&#34;</span><span class="p">,</span>
             <span class="s2">&#34;ECDHE-RSA-AES256-GCM-SHA384&#34;</span><span class="p">,</span>
             <span class="s2">&#34;ECDHE-ECDSA-AES128-GCM-SHA256&#34;</span><span class="p">,</span>
             <span class="s2">&#34;ECDHE-RSA-AES128-GCM-SHA256&#34;</span><span class="p">,</span>
             <span class="s2">&#34;AES256-GCM-SHA384&#34;</span><span class="p">,</span>
             <span class="s2">&#34;AES128-GCM-SHA256&#34;</span>
            <span class="p">]</span>
           <span class="p">},</span>
           <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&#34;h2&#34;</span><span class="p">,</span>
            <span class="s2">&#34;http/1.1&#34;</span>
           <span class="p">],</span>
           <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">// 用来通过 SDS API 获取 tls 证书的配置
</span><span class="c1"></span>            <span class="p">{</span>
             <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>          <span class="c1">// 本地使用的证书名称
</span><span class="c1"></span>             <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>                    <span class="c1">// SDS 服务器配置
</span><span class="c1"></span>              <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
               <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
               <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                 <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>    <span class="c1">// SDS 服务器的 cluster 名称
</span><span class="c1"></span>                 <span class="p">}</span>
                <span class="p">}</span>
               <span class="p">],</span>
               <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
               <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
              <span class="p">},</span>
              <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
              <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
             <span class="p">}</span>
            <span class="p">}</span>
           <span class="p">],</span>
           <span class="nt">&#34;combined_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 联合的证书验证上下文，包含 default_validation_context 和 validation_context_sds_secret_config 两个教育上下文
</span><span class="c1"></span>            <span class="nt">&#34;default_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 验证对等证书
</span><span class="c1"></span>             <span class="nt">&#34;match_subject_alt_names&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">// 主题备用名称（SAN）匹配器的列表，假如设置了，envoy 将会校验所提交证书的主题替代名称是否与指定的匹配器之一相匹配
</span><span class="c1"></span>              <span class="p">{</span>
               <span class="nt">&#34;prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/&#34;</span>
              <span class="p">}</span>
             <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">&#34;validation_context_sds_secret_config&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 通过 SDS API 验证证书
</span><span class="c1"></span>             <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>
             <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
               <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
               <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                 <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>    <span class="c1">// SDS 服务器 cluster 名称
</span><span class="c1"></span>                 <span class="p">}</span>
                <span class="p">}</span>
               <span class="p">],</span>
               <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
               <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
              <span class="p">},</span>
              <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
              <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
             <span class="p">}</span>
            <span class="p">}</span>
           <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&#34;require_client_certificate&#34;</span><span class="p">:</span> <span class="kc">true</span>
         <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0_80&#34;</span>
       <span class="p">},</span>
       <span class="p">{</span>
        <span class="nt">&#34;filter_chain_match&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;destination_port&#34;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
         <span class="nt">&#34;transport_protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;raw_buffer&#34;</span> <span class="c1">// 默认值，没有传输协议时使用
</span><span class="c1"></span>        <span class="p">},</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0_80&#34;</span>
       <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;listener_filters&#34;</span><span class="p">:</span> <span class="p">[</span>
       <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.original_dst&#34;</span><span class="p">,</span>
        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.original_dst.v3.OriginalDst&#34;</span>
        <span class="p">}</span>
       <span class="p">},</span>
       <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.tls_inspector&#34;</span><span class="p">,</span> <span class="c1">// tls 检测监听过滤器，检测传输是 tls 还是纯文本
</span><span class="c1"></span>        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.tls_inspector.v3.TlsInspector&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;filter_disabled&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;destination_port_range&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;start&#34;</span><span class="p">:</span> <span class="mi">15006</span><span class="p">,</span>
          <span class="nt">&#34;end&#34;</span><span class="p">:</span> <span class="mi">15007</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">},</span>
       <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.listener.http_inspector&#34;</span><span class="p">,</span>  <span class="c1">// http 检测监听过滤器
</span><span class="c1"></span>        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.listener.http_inspector.v3.HttpInspector&#34;</span>
        <span class="p">},</span>
       <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;listener_filters_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
      <span class="nt">&#34;traffic_direction&#34;</span><span class="p">:</span> <span class="s2">&#34;INBOUND&#34;</span><span class="p">,</span>
      <span class="nt">&#34;continue_on_listener_filters_timeout&#34;</span><span class="p">:</span> <span class="kc">true</span>
     <span class="p">},</span>
     <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-17T04:44:32.331Z&#34;</span>
    <span class="p">}</span>
   <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再来看下 Outbound Cluster 相关配置如下所示，sleep pods 的 enovy 通过名为“outbound|5000||helloworld.sample.svc.cluster.local”的 cluster 访问上游 helloworld 服务，因此需要在该 cluster 上配置客户端证书以及验证服务器端证书的 CA 根证书。在这里我们需要注意的是，Envoy 在验证服务器端证书时会同时验证证书中的 主题备用名称（Subject Alternative Name） 字段。该字段中设置的是 helloworld 服务 Pod 关联的 Service Account 名称。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-17T04:44:27Z/14&#34;</span><span class="p">,</span>
    <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|5000||helloworld.sample.svc.cluster.local&#34;</span><span class="p">,</span>
     <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;EDS&#34;</span><span class="p">,</span> <span class="c1">// 使用 EDS 服务发现从 pilot 获取的
</span><span class="c1"></span>     <span class="nt">&#34;eds_cluster_config&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;eds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;ads&#34;</span><span class="p">:</span> <span class="p">{},</span>
       <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
       <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;service_name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|5000||helloworld.sample.svc.cluster.local&#34;</span>
     <span class="p">},</span>
     <span class="nt">&#34;connect_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;10s&#34;</span><span class="p">,</span>
     <span class="nt">&#34;lb_policy&#34;</span><span class="p">:</span> <span class="s2">&#34;LEAST_REQUEST&#34;</span><span class="p">,</span>
     <span class="nt">&#34;circuit_breakers&#34;</span><span class="p">:</span> <span class="p">{},</span>
      <span class="c1">// 访问 helloworld 服务的 5000 端口的出向流量
</span><span class="c1"></span>     <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;filter_metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;istio&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;services&#34;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
          <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;sample&#34;</span><span class="p">,</span>
          <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;helloworld.sample.svc.cluster.local&#34;</span><span class="p">,</span>
          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;helloworld&#34;</span>
         <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">&#34;default_original_port&#34;</span><span class="p">:</span> <span class="mi">5000</span>
       <span class="p">}</span>
      <span class="p">}</span>
     <span class="p">},</span>
     <span class="nt">&#34;common_lb_config&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;locality_weighted_lb_config&#34;</span><span class="p">:</span> <span class="p">{}</span>
     <span class="p">},</span>
     <span class="nt">&#34;transport_socket_matches&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">// 为不同的 endpoints 使用不同的传输 socket，见 [envoy cluster 配置](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto.html)
</span><span class="c1"></span>      <span class="p">{</span>
       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-istio&#34;</span><span class="p">,</span>
       <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;tlsMode&#34;</span><span class="p">:</span> <span class="s2">&#34;istio&#34;</span>
       <span class="p">},</span>
       <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// 可选的自定义传输 socket 实现，用于上游连接
</span><span class="c1"></span>        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>  <span class="c1">// tls 传输 socket 协议
</span><span class="c1"></span>        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>   <span class="c1">// UpstreamTlsContext 表示上游连接
</span><span class="c1"></span>         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext&#34;</span><span class="p">,</span>
         <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;tls_minimum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_2&#34;</span><span class="p">,</span>
           <span class="nt">&#34;tls_maximum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span>
          <span class="p">},</span>
          <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
           <span class="s2">&#34;istio-peer-exchange&#34;</span><span class="p">,</span>
           <span class="s2">&#34;istio&#34;</span>
          <span class="p">],</span>
          <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">// 用来通过 SDS API 获取 tls 证书的配置
</span><span class="c1"></span>           <span class="p">{</span>
            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
            <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
             <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
              <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
               <span class="p">{</span>
                <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>  <span class="c1">// SDS 服务器的 cluster 名称
</span><span class="c1"></span>                <span class="p">}</span>
               <span class="p">}</span>
              <span class="p">],</span>
              <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
              <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
             <span class="p">},</span>
             <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
             <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
            <span class="p">}</span>
           <span class="p">}</span>
          <span class="p">],</span>
          <span class="nt">&#34;combined_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;default_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// 验证对等证书
</span><span class="c1"></span>            <span class="nt">&#34;match_subject_alt_names&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">// SAN 匹配器的列表，假如设置了，envoy 会检验上游服务器的 SAN 是否一致
</span><span class="c1"></span>             <span class="p">{</span>
              <span class="nt">&#34;exact&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/default&#34;</span> <span class="c1">// 上游服务器 service account 名称应该为 default
</span><span class="c1"></span>             <span class="p">}</span>
            <span class="p">]</span>
           <span class="p">},</span>
           <span class="nt">&#34;validation_context_sds_secret_config&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// 通过 SDS API 验证证书
</span><span class="c1"></span>            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>
            <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
             <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
              <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
               <span class="p">{</span>
                <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>
                <span class="p">}</span>
               <span class="p">}</span>
              <span class="p">],</span>
              <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
              <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
             <span class="p">},</span>
             <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
             <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
            <span class="p">}</span>
           <span class="p">}</span>
          <span class="p">}</span>
         <span class="p">},</span>
         <span class="nt">&#34;sni&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_.5000_._.helloworld.sample.svc.cluster.local&#34;</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-disabled&#34;</span><span class="p">,</span>
       <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{},</span>
       <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.raw_buffer&#34;</span><span class="p">,</span>
        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer&#34;</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">}</span>
     <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-17T04:44:32.227Z&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因为这里的 helloworld 服务的 deploy 中没有设置 serviceAccount，因此默认为 false，可以查看环境的 serviceAccount 有 default 和 sleep：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@cluster1:~/zt/istio# kubectl get serviceAccount -nsample
NAME      SECRETS   AGE
default   <span class="m">0</span>         15d
sleep     <span class="m">0</span>         15d
</code></pre></td></tr></table>
</div>
</div><p>在配置中可以看到通过 SDS 服务器获取到的证书，配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="c1">// 通过 SDS 动态获取的 secret 信息
</span><span class="c1"></span>   <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.admin.v3.SecretsConfigDump&#34;</span><span class="p">,</span>
   <span class="nt">&#34;dynamic_active_secrets&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
     <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-31T16:44:32.716Z&#34;</span><span class="p">,</span>
     <span class="nt">&#34;secret&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 见 [secret 配置协议](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/secret.proto.html)
</span><span class="c1"></span>      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span><span class="p">,</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
      <span class="nt">&#34;tls_certificate&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;certificate_chain&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// tls 证书链
</span><span class="c1"></span>        <span class="nt">&#34;inline_bytes&#34;</span><span class="p">:</span> <span class="s2">&#34;xxx&#34;</span>
       <span class="p">},</span>
       <span class="nt">&#34;private_key&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// tls 私钥
</span><span class="c1"></span>        <span class="nt">&#34;inline_bytes&#34;</span><span class="p">:</span> <span class="s2">&#34;W3JlZGFjdGVkXQ==&#34;</span>
       <span class="p">}</span>
      <span class="p">}</span>
     <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>
     <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-17T04:44:32.235Z&#34;</span><span class="p">,</span>
     <span class="nt">&#34;secret&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.Secret&#34;</span><span class="p">,</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>
      <span class="nt">&#34;validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>   <span class="c1">// 包含认证中心的证书数据，用来验证一个给定对等证书（peer certificate）
</span><span class="c1"></span>       <span class="nt">&#34;trusted_ca&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;inline_bytes&#34;</span><span class="p">:</span> <span class="s2">&#34;xxx&#34;</span>
       <span class="p">}</span>
      <span class="p">}</span>
     <span class="p">}</span>
    <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面配置中，名为 default 的证书是当前服务的证书，证书中的 SAN 使用了该服务对应的命名空间下的 serviceaccount；名为 ROOTCA 的证书是集群的根证书，可以用于认证各个服务的证书。不同的服务使用的 default 证书不同，但使用的 ROOTCA 证书是相同的。(<strong>如何导出 default 和 ROOTCA 证书，分别对应下面的 pod.crt 和 root-cat.crt</strong>)</p>
<h2 id="gateway-证书配置">Gateway 证书配置</h2>
<p>Gateway 中使用的容器和 sidecar 一样，也是 pilot-agent 和 envoy 进程组成。Gateway 分为 Ingress Gateway 和 Egress Gateway，分别负责集群入向和出向流量，其证书配置逻辑和 sidecar 的差别如下：</p>
<ul>
<li>Ingress：做为服务端和 sidecar 有差异，使用的服务器端证书和私钥，一般是由一个权威 CA 或者第三方 CA 签发</li>
<li>Egress：做为客户端和 sizecar 有差异，外部服务器采用了 TLS，需要配置 CA 根证书来进行验证，这个 CA 根证书一般由权威 CA 或者第三方 CA 签发</li>
</ul>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://www.zhaohuabing.com/post/2020-05-25-istio-certificate/">Isito 中的证书工作机制</a></li>
<li><a href="https://istio.io/latest/docs/concepts/security">Isito 安全性</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/440612523">HTTPS 原理和 TLS 认证流程全解析</a></li>
<li><a href="https://www.cnblogs.com/charlieroro/p/13644368.html">Istio 中的流量配置</a></li>
<li><a href="https://atbug.com/what-is-spiffe-and-spire/">零信任安全：SPIFFE 和 SPIRE 通用身份验证的标准和实现</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">yefengzhichen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-02-03
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="../../tags/kubernetes/">kubernetes</a>
          <a href="../../tags/istio/">istio</a>
          <a href="../../tags/pilot-agent/">pilot-agent</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="../../post/dubbo_demo/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">dubbo 多种部署场景测试</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="../../post/istio_multicluster/">
            <span class="next-text nav-default">Istio 多集群模型和部署示例</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="yefengzhichen/yefengzhichen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="zhutao_hust@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/yefengzhichen" class="iconfont icon-github" title="github"></a>
  <a href="https://yefengzhichen.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2022 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>yefengzhichen</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="../../js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
