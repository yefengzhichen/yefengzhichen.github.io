<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Istio dns 原理详解 - yefengzhichen&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="yefengzhichen" /><meta name="description" content="问题背景 在之前使用 ServiceEntry 和 EnvoyFilter 来接入 dubbo 服务到 istio 中时，最开始一直疑惑，当 consumer 端使用 ServiceEntry 中的 host 去访问，但 EnvoyFilter 中直接使用的是 addresses 和端口来进行过滤器匹配的，下发的" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.92.1 with theme even" />


<link rel="canonical" href="https://yefengzhichen.github.io/post/istio_dns/" />
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../manifest.json">
<link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="../../sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Istio dns 原理详解" />
<meta property="og:description" content="问题背景 在之前使用 ServiceEntry 和 EnvoyFilter 来接入 dubbo 服务到 istio 中时，最开始一直疑惑，当 consumer 端使用 ServiceEntry 中的 host 去访问，但 EnvoyFilter 中直接使用的是 addresses 和端口来进行过滤器匹配的，下发的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yefengzhichen.github.io/post/istio_dns/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-03-29T09:55:25+08:00" />
<meta property="article:modified_time" content="2023-03-29T09:55:25+08:00" />

<meta itemprop="name" content="Istio dns 原理详解">
<meta itemprop="description" content="问题背景 在之前使用 ServiceEntry 和 EnvoyFilter 来接入 dubbo 服务到 istio 中时，最开始一直疑惑，当 consumer 端使用 ServiceEntry 中的 host 去访问，但 EnvoyFilter 中直接使用的是 addresses 和端口来进行过滤器匹配的，下发的"><meta itemprop="datePublished" content="2023-03-29T09:55:25+08:00" />
<meta itemprop="dateModified" content="2023-03-29T09:55:25+08:00" />
<meta itemprop="wordCount" content="4487">
<meta itemprop="keywords" content="istio,kubernetes,dns," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Istio dns 原理详解"/>
<meta name="twitter:description" content="问题背景 在之前使用 ServiceEntry 和 EnvoyFilter 来接入 dubbo 服务到 istio 中时，最开始一直疑惑，当 consumer 端使用 ServiceEntry 中的 host 去访问，但 EnvoyFilter 中直接使用的是 addresses 和端口来进行过滤器匹配的，下发的"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../../">
        <li class="mobile-menu-item">首页</li>
      </a><a href="../../post/">
        <li class="mobile-menu-item">列表</li>
      </a><a href="../../tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="../../categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../../">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../post/">列表</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../categories/">分类</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Istio dns 原理详解</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-03-29 </span>
        <div class="post-category">
            <a href="../../categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"> 云原生 </a>
            </div>
          <span class="more-meta"> 约 4487 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#问题背景">问题背景</a></li>
    <li><a href="#dns-逻辑">DNS 逻辑</a>
      <ul>
        <li><a href="#kubernetes-中-dns-逻辑">Kubernetes 中 DNS 逻辑</a></li>
        <li><a href="#istio-中-dns-测试">Istio 中 DNS 测试</a></li>
        <li><a href="#istio_meta_dns_capture-配置">ISTIO_META_DNS_CAPTURE 配置</a></li>
      </ul>
    </li>
    <li><a href="#源码分析">源码分析</a>
      <ul>
        <li><a href="#istio-iptables-dns-源码">istio-iptables dns 源码</a></li>
        <li><a href="#istio-agent-dns-源码">istio-agent dns 源码</a></li>
        <li><a href="#istio-discovery-dns-源码">istio-discovery dns 源码</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="问题背景">问题背景</h1>
<p>在之前使用 ServiceEntry 和 EnvoyFilter 来接入 dubbo 服务到 istio 中时，最开始一直疑惑，当 consumer 端使用 ServiceEntry 中的 host 去访问，但 EnvoyFilter
中直接使用的是 addresses 和端口来进行过滤器匹配的，下发的 envoy 配置中也是用的 ip+port，ServiceEntry 并不会生成 service，那 host 到 ip 是如何转换的呢？</p>
<p>具体的例子参考 <a href="https://yefengzhichen.github.io/post/istio_dubbo_manual/">手动接入 dubbo 到 istio</a>，设置的 ServiceEntry 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceEntry</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-demoservice</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">meta-dubbo</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.api.GreetingService</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">addresses</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="m">240.240.0.20</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">org.apache.dubbo.samples.api.greetingservice</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>envoy 端收到的配置中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json">    <span class="p">{</span>
     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;240.240.0.3_20880&#34;</span><span class="p">,</span>
     <span class="nt">&#34;active_state&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;listener&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;</span><span class="p">,</span>
       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;240.240.0.3_20880&#34;</span><span class="p">,</span>
       <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;socket_address&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;240.240.0.3&#34;</span><span class="p">,</span>
         <span class="nt">&#34;port_value&#34;</span><span class="p">:</span> <span class="mi">20880</span>
        <span class="p">}</span>
       <span class="p">},</span>
       <span class="c1">// ...
</span><span class="c1"></span>      <span class="p">},</span>
      <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-03-16T06:50:22.529Z&#34;</span>
     <span class="p">}</span>
    <span class="p">}</span><span class="err">,</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="dns-逻辑">DNS 逻辑</h1>
<h2 id="kubernetes-中-dns-逻辑">Kubernetes 中 DNS 逻辑</h2>
<p>Kubernetes 的 DNS 实现基于 CoreDNS，是一种轻量级的 DNS 服务器。Kubernetes 中每个 service 会配置一个 DNS 名称和 cluster ip，DNS 名称格式为：<service-name>.<namespace>.svc.cluster.local。DNS 相关 pods 和 service 为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@dev:~# kubectl get -nkube-system svc kube-dns
NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                  AGE
kube-dns   ClusterIP   10.43.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   36d
root@dev:~# kubectl get -nkube-system pods <span class="p">|</span>grep dns
coredns-597584b69b-ctbcv                    1/1     Running     <span class="m">0</span>          36d
</code></pre></td></tr></table>
</div>
</div><p>在 pods 中查 DNS 服务器的配置/etc/resolv.conf 为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">search meta-dubbo.svc.cluster.local svc.cluster.local cluster.local openstacklocal
nameserver 10.43.0.10
options ndots:5
</code></pre></td></tr></table>
</div>
</div><p>nameserver 指向 kube-dns 的 cluster ip，即 pod 先通过请求 dns 文件中配置 dns 服务器，由 dns 服务器做域名解析转换成对应的 cluster ip，然后通过 cluster ip 去访问。</p>
<h2 id="istio-中-dns-测试">Istio 中 DNS 测试</h2>
<p>当在 Istio 设置了前面提到的 ServiceEntry 后，用 nslookup 测试解析过程，发现仍然是去 dns 文件中的服务器请求的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@dubbo-sample-provider-6c84cbc484-6nq4r:/# nslookup org.apache.dubbo.samples.api.greetingservice
Server:    10.43.0.10
Address:  10.43.0.10#53

Name:  org.apache.dubbo.samples.api.greetingservice
Address: 240.240.0.20
</code></pre></td></tr></table>
</div>
</div><p>ServiceEntry 没有生成对应的 service，在 kubernetes 的 coredns 中应该是没有信息的，为啥还是会去 coredns 请求的呢？istio 中 envoy 会劫持流量，难道是被 envoy 转到 istio 去获取的？
为了验证此想法，在 pods 外面也测试了下 dns 解析结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@dev:~# nslookup kube-dns.kube-system.svc.cluster.local 10.42.0.4
Server:    10.42.0.4
Address:  10.42.0.4#53

Name:  kube-dns.kube-system.svc.cluster.local
Address: 10.43.0.10

root@dev:~# nslookup org.apache.dubbo.samples.api.greetingservice 10.42.0.4
Server:    10.42.0.4
Address:  10.42.0.4#53

** server can<span class="err">&#39;</span>t find org.apache.dubbo.samples.api.greetingservice: NXDOMAIN
</code></pre></td></tr></table>
</div>
</div><p>可以发现，kubernetes 原生的 service 可以找到，ServiceEntry 中的 host 没有找到，因此确定不是去 coredns 解析的。</p>
<h2 id="istio_meta_dns_capture-配置">ISTIO_META_DNS_CAPTURE 配置</h2>
<p>Istio 可以捕获 DNS 请求，以提高网格的性能和可用性。 当 Istio 代理 DNS 时，所有来自应用程序的 DNS 请求将会被重定向到 Sidecar，因为 Sidecar 存储了域名到 IP 地址的映射。如果请求被 Sidecar 处理，它将直接给应用返回响应，避免了对上游 DNS 服务器的往返。反之，请求将按照标准的/etc/resolv.conf DNS 配置向上游转发。Istio 的 DNS 有以下两个作用：</p>
<ul>
<li>ServiceEntry 地址可以被解析，而不需要自定义 DNS 服务配置</li>
<li>减少了 kube-dns 的负载，并且提高了性能</li>
</ul>
<p>Istio 是通过“ISTIO_META_DNS_CAPTURE”配置来开启 DNS 代理的，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ cat <span class="s">&lt;&lt;EOF | istioctl install -y -f -
</span><span class="s">apiVersion: install.istio.io/v1alpha1
</span><span class="s">kind: IstioOperator
</span><span class="s">spec:
</span><span class="s">  meshConfig:
</span><span class="s">    defaultConfig:
</span><span class="s">      proxyMetadata:
</span><span class="s">        # Enable basic DNS proxying
</span><span class="s">        ISTIO_META_DNS_CAPTURE: &#34;true&#34;
</span><span class="s">        # Enable automatic address allocation, optional
</span><span class="s">        ISTIO_META_DNS_AUTO_ALLOCATE: &#34;true&#34;
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>在 consumer 的 pod 描述中可以看到，在 init 容器 istio-init 和 sidecar 容器 istio-proxy 中都设置了 ISTIO_META_DNS_CAPTURE 环境变量，通过这两个容器来使 dns 生效的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">proxy</span><span class="w">
</span><span class="w">    </span>- <span class="l">sidecar</span><span class="w">
</span><span class="w">    </span>- --<span class="l">domain</span><span class="w">
</span><span class="w">    </span>- <span class="l">$(POD_NAMESPACE).svc.cluster.local</span><span class="w">
</span><span class="w">    </span>- --<span class="l">proxyLogLevel=debug</span><span class="w">
</span><span class="w">    </span>- --<span class="l">proxyComponentLogLevel=misc:error</span><span class="w">
</span><span class="w">    </span>- --<span class="l">log_output_level=default:debug</span><span class="w">
</span><span class="w">    </span>- --<span class="l">concurrency</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;2&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">JWT_POLICY</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">third-party-jwt</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ISTIO_META_DNS_CAPTURE</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/istio/proxyv2:1.16.1</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-proxy</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">istio-iptables</span><span class="w">
</span><span class="w">    </span>- -<span class="l">p</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;15001&#34;</span><span class="w">
</span><span class="w">    </span>- -<span class="l">z</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;15006&#34;</span><span class="w">
</span><span class="w">    </span>- -<span class="l">u</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;1337&#34;</span><span class="w">
</span><span class="w">    </span>- -<span class="l">m</span><span class="w">
</span><span class="w">    </span>- <span class="l">REDIRECT</span><span class="w">
</span><span class="w">    </span>- -<span class="l">i</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span><span class="w">    </span>- -<span class="l">x</span><span class="w">
</span><span class="w">    </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">    </span>- -<span class="l">b</span><span class="w">
</span><span class="w">    </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span><span class="w">    </span>- -<span class="l">d</span><span class="w">
</span><span class="w">    </span>- <span class="m">15090</span><span class="p">,</span><span class="m">15021</span><span class="p">,</span><span class="m">15020</span><span class="w">
</span><span class="w">    </span>- --<span class="l">log_output_level=default:debug</span><span class="w">
</span><span class="w">    </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ISTIO_META_DNS_CAPTURE</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/istio/proxyv2:1.16.1</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-init</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>查看 iptables 规则：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@dev:~# ctr containers list <span class="p">|</span> grep consumer
12a5e7f5939159d2d1c7b66d673234387724d22efe42ad87160aa40d4c46c4c6    127.0.0.1/consumer:v0.0.1                              io.containerd.runc.v2
9df1e53b97a2f6ae2725e9d8c9c7fa0d7f93c59c54cb4adafd65f671c5cedc86    127.0.0.1/consumer:v0.0.1                              io.containerd.runc.v2
root@dev:~# ctr task list <span class="p">|</span> grep 12a5e7f5939159d2d1c7b66d673234387724d22efe42ad87160aa40d4c46c4c6
12a5e7f5939159d2d1c7b66d673234387724d22efe42ad87160aa40d4c46c4c6    <span class="m">3777207</span>    RUNNING

root@dev:~# nsenter -n --target <span class="m">3777207</span>
<span class="c1"># -n：用数字形式显示输出结果，如显示主机的 IP 地址而不是主机名</span>
root@dev:~# iptables -t nat -nL --line-number
Chain PREROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination
<span class="m">1</span>    ISTIO_INBOUND  tcp  --  0.0.0.0/0            0.0.0.0/0

Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination
<span class="m">1</span>    ISTIO_OUTPUT  tcp  --  0.0.0.0/0            0.0.0.0/0
<span class="m">2</span>    RETURN     udp  --  0.0.0.0/0            0.0.0.0/0            udp dpt:53 owner UID match <span class="m">1337</span>
<span class="m">3</span>    RETURN     udp  --  0.0.0.0/0            0.0.0.0/0            udp dpt:53 owner GID match <span class="m">1337</span>
<span class="m">4</span>    REDIRECT   udp  --  0.0.0.0/0            10.43.0.10           udp dpt:53 redir ports <span class="m">15053</span>

Chain POSTROUTING <span class="o">(</span>policy ACCEPT<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination

Chain ISTIO_INBOUND <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination
<span class="m">1</span>    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:15008
<span class="m">2</span>    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:15090
<span class="m">3</span>    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:15021
<span class="m">4</span>    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:15020
<span class="m">5</span>    ISTIO_IN_REDIRECT  tcp  --  0.0.0.0/0            0.0.0.0/0

Chain ISTIO_IN_REDIRECT <span class="o">(</span><span class="m">3</span> references<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination
<span class="m">1</span>    REDIRECT   tcp  --  0.0.0.0/0            0.0.0.0/0            redir ports <span class="m">15006</span>

Chain ISTIO_OUTPUT <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination
<span class="m">1</span>    RETURN     all  --  127.0.0.6            0.0.0.0/0
<span class="m">2</span>    ISTIO_IN_REDIRECT  tcp  --  0.0.0.0/0           !127.0.0.1            tcp dpt:!53 owner UID match <span class="m">1337</span>
<span class="m">3</span>    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:!53 ! owner UID match <span class="m">1337</span>
<span class="m">4</span>    RETURN     all  --  0.0.0.0/0            0.0.0.0/0            owner UID match <span class="m">1337</span>
<span class="m">5</span>    ISTIO_IN_REDIRECT  all  --  0.0.0.0/0           !127.0.0.1            owner GID match <span class="m">1337</span>
<span class="m">6</span>    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:!53 ! owner GID match <span class="m">1337</span>
<span class="m">7</span>    RETURN     all  --  0.0.0.0/0            0.0.0.0/0            owner GID match <span class="m">1337</span>
<span class="m">8</span>    REDIRECT   tcp  --  0.0.0.0/0            10.43.0.10           tcp dpt:53 redir ports <span class="m">15053</span>
<span class="m">9</span>    RETURN     all  --  0.0.0.0/0            127.0.0.1
<span class="m">10</span>   ISTIO_REDIRECT  all  --  0.0.0.0/0            0.0.0.0/0

Chain ISTIO_REDIRECT <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
num  target     prot opt <span class="nb">source</span>               destination
<span class="m">1</span>    REDIRECT   tcp  --  0.0.0.0/0            0.0.0.0/0            redir ports <span class="m">15001</span>
</code></pre></td></tr></table>
</div>
</div><p>其中有涉及到 dns 规则或者端口的有：</p>
<ul>
<li>OUTPUT 链中的第 2 条：udp 协议，端口为 53，且 UID 为 1337（Envoy 代理用户），表示 envoy 发出的 dns 流量，则直接返回，把流量发送到任意目的地址。</li>
<li>OUTPUT 链中的第 3 条：udp 协议，端口为 53，且 GID 为 1337（Envoy 代理组），表示 envoy 发出的 dns 流量，则直接返回，把流量发送到任意目的地址。</li>
<li>OUTPUT 链中的第 4 条：udp 协议，端口为 53，目的 ip 为 kube-dns 的地址，表示应用容器发出的 dns 请求，则转发到本地 15053。</li>
<li>ISTIO_OUTPUT 链中的第 8 条：tcp 协议，端口为 53，目的 ip 为 kube-dns 的地址，表示应用容器发出的 dns 请求，则转发到本地 15053。</li>
</ul>
<h1 id="源码分析">源码分析</h1>
<h2 id="istio-iptables-dns-源码">istio-iptables dns 源码</h2>
<p>istio-iptables 是 istio 用在代理的 init 容器中，用来初始化 iptables 规则。对于 dns 捕获来说，也就是设置规则捕获 dns 相关的流量。
下面代码中获取了环境变量中 dns 捕获标识，初始化启动配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/tools/istio-iptables/pkg/cmd/root.go
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
  <span class="c1">// 开启 dns 拦截
</span><span class="c1"></span>  <span class="nx">dnsCaptureByAgent</span> <span class="p">=</span> <span class="nx">env</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="s">&#34;ISTIO_META_DNS_CAPTURE&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s">&#34;If set to true, enable the capture of outgoing DNS packets on port 53, redirecting to istio-agent on :15053&#34;</span><span class="p">).</span><span class="nf">Get</span><span class="p">()</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">bindFlags</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 获取所有环境变量
</span><span class="c1"></span>  <span class="nx">viper</span><span class="p">.</span><span class="nf">AutomaticEnv</span><span class="p">()</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">SetEnvKeyReplacer</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">NewReplacer</span><span class="p">(</span><span class="s">&#34;-&#34;</span><span class="p">,</span> <span class="s">&#34;_&#34;</span><span class="p">))</span>

  <span class="nx">envoyPort</span> <span class="o">:=</span> <span class="s">&#34;15001&#34;</span>
  <span class="nx">inboundPort</span> <span class="o">:=</span> <span class="s">&#34;15006&#34;</span>
  <span class="nx">inboundTunnelPort</span> <span class="o">:=</span> <span class="s">&#34;15008&#34;</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">viper</span><span class="p">.</span><span class="nf">BindPFlag</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RedirectDNS</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">Lookup</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RedirectDNS</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nf">handleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">SetDefault</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RedirectDNS</span><span class="p">,</span> <span class="nx">dnsCaptureByAgent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">constructConfig</span><span class="p">()</span> <span class="o">*</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span> <span class="p">{</span>
  <span class="nx">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
    <span class="nx">RedirectDNS</span><span class="p">:</span>             <span class="nx">viper</span><span class="p">.</span><span class="nf">GetBool</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">RedirectDNS</span><span class="p">),</span>
    <span class="nx">CaptureAllDNS</span><span class="p">:</span>           <span class="nx">viper</span><span class="p">.</span><span class="nf">GetBool</span><span class="p">(</span><span class="nx">constants</span><span class="p">.</span><span class="nx">CaptureAllDNS</span><span class="p">),</span>
        <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
    <span class="c1">// 查找 DNS 的域名服务器。只会在 dns 开启情况下，且出现一些理论上的隐蔽问题，比如读取/etc/resolv.conf 文件失败
</span><span class="c1"></span>    <span class="c1">// 加入开启了捕获所有的 dns 请求，不需要读 dns 配置文件，所有到 53 端口的流量都会被捕获
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">RedirectDNS</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">CaptureAllDNS</span> <span class="p">{</span>
    <span class="nx">dnsConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dns</span><span class="p">.</span><span class="nf">ClientConfigFromFile</span><span class="p">(</span><span class="s">&#34;/etc/resolv.conf&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;failed to load /etc/resolv.conf: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSServersV4</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSServersV6</span> <span class="p">=</span> <span class="nx">netutil</span><span class="p">.</span><span class="nf">IPsSplitV4V6</span><span class="p">(</span><span class="nx">dnsConfig</span><span class="p">.</span><span class="nx">Servers</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">cfg</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 Run 函数中，如果设置了 dns 代理，则设置为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/tools/istio-iptables/pkg/capture/run.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cfg</span> <span class="o">*</span><span class="nx">IptablesConfigurator</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">redirectDNS</span> <span class="o">:=</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">RedirectDNS</span>
  <span class="nx">cfg</span><span class="p">.</span><span class="nf">logConfig</span><span class="p">()</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">uid</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">split</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyUID</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 在使用 VIP 时，通过 Envoy 将应用程序的调用重定向到自身
</span><span class="c1"></span>        <span class="c1">// 比如：appN =&gt; Envoy (client) =&gt; Envoy (server) =&gt; appN.
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">redirectDNS</span> <span class="p">{</span>
            <span class="c1">// 当 dns 捕获开启时，跳过端口 53，这可以保证不出现：app =&gt; istio-agent =&gt; Envoy inbound =&gt; dns server
</span><span class="c1"></span>            <span class="c1">// 而保证流程为：app =&gt; istio-agent =&gt; dns server
</span><span class="c1"></span>      <span class="c1">// 选择从本地 lo 网络接口发起的，且目的地址不为“127.0.0.1”
</span><span class="c1"></span>      <span class="c1">// 指定是 tcp 规则，且目的端口不为 53
</span><span class="c1"></span>      <span class="c1">// 匹配发起者用户为 uid，则转发到 ISTIOINREDIRECT 规则
</span><span class="c1"></span>      <span class="c1">// 这条规则匹配 ISTIO_OUTPUT 中的第 2 条
</span><span class="c1"></span>      <span class="c1">// 2    ISTIO_IN_REDIRECT  tcp  --  0.0.0.0/0           !127.0.0.1            tcp dpt:!53 owner UID match 1337
</span><span class="c1"></span>      <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">.</span><span class="nf">AppendVersionedRule</span><span class="p">(</span><span class="s">&#34;127.0.0.1/32&#34;</span><span class="p">,</span> <span class="s">&#34;::1/128&#34;</span><span class="p">,</span> <span class="nx">iptableslog</span><span class="p">.</span><span class="nx">UndefinedCommand</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOOUTPUT</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span>
        <span class="s">&#34;-o&#34;</span><span class="p">,</span> <span class="s">&#34;lo&#34;</span><span class="p">,</span> <span class="s">&#34;!&#34;</span><span class="p">,</span> <span class="s">&#34;-d&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">IPVersionSpecific</span><span class="p">,</span>
        <span class="s">&#34;-p&#34;</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="s">&#34;!&#34;</span><span class="p">,</span> <span class="s">&#34;--dport&#34;</span><span class="p">,</span> <span class="s">&#34;53&#34;</span><span class="p">,</span>
        <span class="s">&#34;-m&#34;</span><span class="p">,</span> <span class="s">&#34;owner&#34;</span><span class="p">,</span> <span class="s">&#34;--uid-owner&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOINREDIRECT</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">.</span><span class="nf">AppendVersionedRule</span><span class="p">(</span><span class="s">&#34;127.0.0.1/32&#34;</span><span class="p">,</span> <span class="s">&#34;::1/128&#34;</span><span class="p">,</span> <span class="nx">iptableslog</span><span class="p">.</span><span class="nx">UndefinedCommand</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOOUTPUT</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span>
        <span class="s">&#34;-o&#34;</span><span class="p">,</span> <span class="s">&#34;lo&#34;</span><span class="p">,</span> <span class="s">&#34;!&#34;</span><span class="p">,</span> <span class="s">&#34;-d&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">IPVersionSpecific</span><span class="p">,</span>
        <span class="s">&#34;-m&#34;</span><span class="p">,</span> <span class="s">&#34;owner&#34;</span><span class="p">,</span> <span class="s">&#34;--uid-owner&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOINREDIRECT</span><span class="p">)</span>
    <span class="p">}</span>
        <span class="c1">// 在使用 endpoint 地址时，不会通过 Envoy 将应用程序的调用重定向到自身
</span><span class="c1"></span>    <span class="c1">// 比如：appN =&gt; appN by lo
</span><span class="c1"></span>        <span class="c1">// 如果通过 OutboundIPRangesInclude 明确设置了回环，那么就不要返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">ipv4RangesInclude</span><span class="p">.</span><span class="nx">HasLoopBackIP</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">ipv6RangesInclude</span><span class="p">.</span><span class="nx">HasLoopBackIP</span> <span class="p">{</span>
      <span class="k">if</span> <span class="nx">redirectDNS</span> <span class="p">{</span>
                <span class="c1">// 用户可能在本地有一个 DNS 服务器，为了处理这种情况，从这条规则中排除了端口 53
</span><span class="c1"></span>        <span class="c1">// 从本地接口请求，目的端口不为 53，且不是 uid 的用户发起的
</span><span class="c1"></span>        <span class="c1">// 这条规则匹配 ISTIO_OUTPUT 中的第 3 条
</span><span class="c1"></span>        <span class="c1">// 3    RETURN     tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:!53 ! owner UID match 1337
</span><span class="c1"></span>        <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">.</span><span class="nf">AppendRule</span><span class="p">(</span><span class="nx">iptableslog</span><span class="p">.</span><span class="nx">UndefinedCommand</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOOUTPUT</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span> <span class="s">&#34;-o&#34;</span><span class="p">,</span> <span class="s">&#34;lo&#34;</span><span class="p">,</span> <span class="s">&#34;-p&#34;</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
          <span class="s">&#34;!&#34;</span><span class="p">,</span> <span class="s">&#34;--dport&#34;</span><span class="p">,</span> <span class="s">&#34;53&#34;</span><span class="p">,</span>
          <span class="s">&#34;-m&#34;</span><span class="p">,</span> <span class="s">&#34;owner&#34;</span><span class="p">,</span> <span class="s">&#34;!&#34;</span><span class="p">,</span> <span class="s">&#34;--uid-owner&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">RETURN</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">.</span><span class="nf">AppendRule</span><span class="p">(</span><span class="nx">iptableslog</span><span class="p">.</span><span class="nx">UndefinedCommand</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOOUTPUT</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span>
          <span class="s">&#34;-o&#34;</span><span class="p">,</span> <span class="s">&#34;lo&#34;</span><span class="p">,</span> <span class="s">&#34;-m&#34;</span><span class="p">,</span> <span class="s">&#34;owner&#34;</span><span class="p">,</span> <span class="s">&#34;!&#34;</span><span class="p">,</span> <span class="s">&#34;--uid-owner&#34;</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">RETURN</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">redirectDNS</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">CaptureAllDNS</span> <span class="p">{</span>
            <span class="c1">// 重定向所有 53 端口上的 TCP dns 流量到 agent 的端口 15053 上，这在 CNI 场景下很有用，因为 pod 的 dns 服务器地址还不能确定
</span><span class="c1"></span>      <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">.</span><span class="nf">AppendRule</span><span class="p">(</span><span class="nx">iptableslog</span><span class="p">.</span><span class="nx">UndefinedCommand</span><span class="p">,</span>
        <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOOUTPUT</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span>
        <span class="s">&#34;-p&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">TCP</span><span class="p">,</span>
        <span class="s">&#34;--dport&#34;</span><span class="p">,</span> <span class="s">&#34;53&#34;</span><span class="p">,</span>
        <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">REDIRECT</span><span class="p">,</span>
        <span class="s">&#34;--to-ports&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">IstioAgentDNSListenerPort</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSServersV4</span> <span class="p">{</span>
                <span class="c1">// 将在端口 53 上请求/etc/resolv.conf 中所有服务器的 TCP dns 流量重定向到 agent 的 15053 端口
</span><span class="c1"></span>                <span class="c1">// 避免重定向所有 IP 范围，来避免当有本地 dns 服务器时出现无限循环，比如：app -&gt; istio dns server -&gt; dnsmasq -&gt; upstream
</span><span class="c1"></span>                <span class="c1">// 这保证了不会从 dnsmasq 获取请求，并发送回 agent 的 dns 服务器
</span><span class="c1"></span>        <span class="c1">// 这条匹配 ISTIO_OUTPUT 的第 8 条，重定向到 agent 监听的 15053 端口
</span><span class="c1"></span>        <span class="c1">// 8    REDIRECT   tcp  --  0.0.0.0/0            10.43.0.10           tcp dpt:53 redir ports 15053
</span><span class="c1"></span>        <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">.</span><span class="nf">AppendRuleV4</span><span class="p">(</span><span class="nx">iptableslog</span><span class="p">.</span><span class="nx">UndefinedCommand</span><span class="p">,</span>
          <span class="nx">constants</span><span class="p">.</span><span class="nx">ISTIOOUTPUT</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">NAT</span><span class="p">,</span>
          <span class="s">&#34;-p&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">TCP</span><span class="p">,</span>
          <span class="s">&#34;--dport&#34;</span><span class="p">,</span> <span class="s">&#34;53&#34;</span><span class="p">,</span>
          <span class="s">&#34;-d&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="o">+</span><span class="s">&#34;/32&#34;</span><span class="p">,</span>
          <span class="s">&#34;-j&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">REDIRECT</span><span class="p">,</span>
          <span class="s">&#34;--to-ports&#34;</span><span class="p">,</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">IstioAgentDNSListenerPort</span><span class="p">)</span>
      <span class="p">}</span>
            <span class="c1">// ...
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">redirectDNS</span> <span class="p">{</span>
    <span class="nf">HandleDNSUDP</span><span class="p">(</span>
      <span class="nx">AppendOps</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">iptables</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ext</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span>
      <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyUID</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyGID</span><span class="p">,</span>
      <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSServersV4</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSServersV6</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">CaptureAllDNS</span><span class="p">,</span>
      <span class="nx">ownerGroupsFilter</span><span class="p">)</span>
  <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">cfg</span><span class="p">.</span><span class="nf">executeCommands</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里只展示了部分 dns 相关代码，其他涉及 dns iptables 规则的代码和上面类似，比如像 udp 的 dns 规则、针对用户组的 dns 规则。</p>
<h2 id="istio-agent-dns-源码">istio-agent dns 源码</h2>
<p>istio-agent 跟上面一样，也是从环境变量获取值，然后写到 Agent 的配置结构体里：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/pilot/cmd/pilot-agent/options/agent.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewAgentOptions</span><span class="p">(</span><span class="nx">proxy</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Proxy</span><span class="p">,</span> <span class="nx">cfg</span> <span class="o">*</span><span class="nx">meshconfig</span><span class="p">.</span><span class="nx">ProxyConfig</span><span class="p">)</span> <span class="o">*</span><span class="nx">istioagent</span><span class="p">.</span><span class="nx">AgentOptions</span> <span class="p">{</span>
  <span class="nx">o</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">istioagent</span><span class="p">.</span><span class="nx">AgentOptions</span><span class="p">{</span>
    <span class="nx">XDSRootCerts</span><span class="p">:</span>             <span class="nx">xdsRootCA</span><span class="p">,</span>
    <span class="nx">CARootCerts</span><span class="p">:</span>              <span class="nx">caRootCA</span><span class="p">,</span>
        <span class="c1">// ...
</span><span class="c1"></span>    <span class="nx">DNSCapture</span><span class="p">:</span>                  <span class="nx">DNSCaptureByAgent</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="c1">// DNSCaptureByAgent 值是从环境变量“ISTIO_META_DNS_CAPTURE”获取的
</span><span class="c1"></span>    <span class="nx">DNSForwardParallel</span><span class="p">:</span>          <span class="nx">DNSForwardParallel</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span> <span class="c1">// 是否并行转发 dns 请求
</span><span class="c1"></span>    <span class="nx">DNSAddr</span><span class="p">:</span>                     <span class="nx">DNSCaptureAddr</span><span class="p">.</span><span class="nf">Get</span><span class="p">(),</span>  <span class="c1">// DNSCaptureAddr 值是从环境变量获取的，默认为“localhost:15053”
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">o</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 Agent 的启动函数 Run 里面，调用 initLocalDNSServer 来开启 dns 服务器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/pkg/istio-agent/agent.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kd">func</span><span class="p">(),</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">initLocalDNSServer</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start local DNS server: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="nf">initLocalDNSServer</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 如果开启 dns 捕获，且是 sidecar 代理时，则启动本地 dns 服务器
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSCapture</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyType</span> <span class="o">==</span> <span class="nx">model</span><span class="p">.</span><span class="nx">SidecarProxy</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">localDNSServer</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">dnsClient</span><span class="p">.</span><span class="nf">NewLocalDNSServer</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyNamespace</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ProxyDomain</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSAddr</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DNSForwardParallel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">localDNSServer</span><span class="p">.</span><span class="nf">StartDNS</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过 NewLocalDNSServer 创建 dns 服务器，里面持有 dns 下游服务器配置，通过 StartDNS 启动 tcp 和 udp 的 dns 代理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/pkg/dns/client/dns.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewLocalDNSServer</span><span class="p">(</span><span class="nx">proxyNamespace</span><span class="p">,</span> <span class="nx">proxyDomain</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">forwardToUpstreamParallel</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">LocalDNSServer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">h</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">LocalDNSServer</span><span class="p">{</span>
    <span class="nx">proxyNamespace</span><span class="p">:</span>            <span class="nx">proxyNamespace</span><span class="p">,</span>
    <span class="nx">forwardToUpstreamParallel</span><span class="p">:</span> <span class="nx">forwardToUpstreamParallel</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nx">resolvConf</span> <span class="o">:=</span> <span class="s">&#34;/etc/resolv.conf&#34;</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">// 使用 resolv.conf 中的服务器解析不知道的域名
</span><span class="c1"></span>  <span class="nx">dnsConfig</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dns</span><span class="p">.</span><span class="nf">ClientConfigFromFile</span><span class="p">(</span><span class="nx">resolvConf</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Warnf</span><span class="p">(</span><span class="s">&#34;failed to load /etc/resolv.conf: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>

    <span class="c1">// 不像传统的 dns 解析器，不需要附加搜索命名空间，因为 agent 是一个 dns 拦截器
</span><span class="c1"></span>    <span class="c1">// 只需要检查域名在本地域名表中是否存在，如果没有，就将查询转发给上游解析器
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">dnsConfig</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dnsConfig</span><span class="p">.</span><span class="nx">Servers</span> <span class="p">{</span>
      <span class="nx">h</span><span class="p">.</span><span class="nx">resolvConfServers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">resolvConfServers</span><span class="p">,</span> <span class="nx">net</span><span class="p">.</span><span class="nf">JoinHostPort</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">dnsConfig</span><span class="p">.</span><span class="nx">Port</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nx">h</span><span class="p">.</span><span class="nx">searchNamespaces</span> <span class="p">=</span> <span class="nx">dnsConfig</span><span class="p">.</span><span class="nx">Search</span>
  <span class="p">}</span>
  <span class="nx">addresses</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">addr</span><span class="p">}</span>
  <span class="c1">// 分别启动 udp 和 tcp 的代理
</span><span class="c1"></span>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ipAddr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">addresses</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">proto</span> <span class="o">:=</span> <span class="k">range</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="s">&#34;tcp&#34;</span><span class="p">}</span> <span class="p">{</span>
      <span class="nx">proxy</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newDNSProxy</span><span class="p">(</span><span class="nx">proto</span><span class="p">,</span> <span class="nx">ipAddr</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="nx">h</span><span class="p">.</span><span class="nx">dnsProxies</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">dnsProxies</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">)</span>

    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">h</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 启动 dns 代理
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">LocalDNSServer</span><span class="p">)</span> <span class="nf">StartDNS</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">h</span><span class="p">.</span><span class="nx">dnsProxies</span> <span class="p">{</span>
    <span class="k">go</span> <span class="nx">p</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 使用的“github.com/miekg/dns”库，需实现 ServeDNS 这个 Handler 接口
</span><span class="c1">// 里面会 dnsProxies.ServeDNS 函数，然后调用到 LocalDNSServer.ServeDNS 函数
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">LocalDNSServer</span><span class="p">)</span> <span class="nf">ServeDNS</span><span class="p">(</span><span class="nx">proxy</span> <span class="o">*</span><span class="nx">dnsProxy</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">requests</span><span class="p">.</span><span class="nf">Increment</span><span class="p">()</span>
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span>
  <span class="c1">// dns 查询表
</span><span class="c1"></span>  <span class="nx">lp</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">lookupTable</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>
  <span class="nx">hostname</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Question</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Name</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">lookupTable</span> <span class="o">:=</span> <span class="nx">lp</span><span class="p">.(</span><span class="o">*</span><span class="nx">LookupTable</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">answers</span> <span class="p">[]</span><span class="nx">dns</span><span class="p">.</span><span class="nx">RR</span>
  <span class="c1">// 名称总会以“.”结束，期望每个请求只有一个域名
</span><span class="c1"></span>  <span class="nx">answers</span><span class="p">,</span> <span class="nx">hostFound</span> <span class="o">:=</span> <span class="nx">lookupTable</span><span class="p">.</span><span class="nf">lookupHost</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Question</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Qtype</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">hostFound</span> <span class="p">{</span>
    <span class="nx">response</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nf">SetReply</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">Authoritative</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">Answer</span> <span class="p">=</span> <span class="nx">answers</span>
    <span class="c1">// 打乱回复，保证能做到 DNS 负载均衡，比如 headless 服务需要，也和 kube-dns 的行为一致
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">answers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nf">roundRobinResponse</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;response for hostname %q (found=true): %v&#34;</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 缓存没找到，去上游 dns 服务器请求
</span><span class="c1"></span>    <span class="nx">response</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">upstream</span><span class="p">(</span><span class="nx">proxy</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">hostname</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">response</span><span class="p">.</span><span class="nf">Truncate</span><span class="p">(</span><span class="nf">size</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">protocol</span><span class="p">,</span> <span class="nx">req</span><span class="p">))</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">WriteMsg</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面 lookupTable 是本地的域名缓存，从 initXdsProxy 函数中可以看到域名信息是通过 xds 获取的，然后更新到 lookupTable 的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">initXdsProxy</span> <span class="nx">函数</span> <span class="p">(</span><span class="nx">ia</span> <span class="o">*</span><span class="nx">Agent</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">XdsProxy</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">ia</span><span class="p">.</span><span class="nx">localDNSServer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">proxy</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">v3</span><span class="p">.</span><span class="nx">NameTableType</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">anypb</span><span class="p">.</span><span class="nx">Any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nt</span> <span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nf">UnmarshalTo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nt</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to unmarshal name table: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
      <span class="p">}</span>
      <span class="nx">ia</span><span class="p">.</span><span class="nx">localDNSServer</span><span class="p">.</span><span class="nf">UpdateLookupTable</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nt</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="istio-discovery-dns-源码">istio-discovery dns 源码</h2>
<p>获取域名信息的服务发现类型是 nds，nds 在 istio-discovery 中对应的 Generate 实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/pilot/pkg/xds/nds.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="nx">NdsGenerator</span><span class="p">)</span> <span class="nf">Generate</span><span class="p">(</span><span class="nx">proxy</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Proxy</span><span class="p">,</span> <span class="nx">push</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushContext</span><span class="p">,</span> <span class="nx">w</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">WatchedResource</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">PushRequest</span><span class="p">)</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Resources</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">!</span><span class="nf">ndsNeedsPush</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">nt</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">ConfigGenerator</span><span class="p">.</span><span class="nf">BuildNameTable</span><span class="p">(</span><span class="nx">proxy</span><span class="p">,</span> <span class="nx">push</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">nt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="nx">resources</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Resources</span><span class="p">{</span><span class="nx">util</span><span class="p">.</span><span class="nf">MessageToAny</span><span class="p">(</span><span class="nx">nt</span><span class="p">)}</span>
    <span class="k">return</span> <span class="nx">resources</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的 Generate 最终会调用到 BuildNameTable 函数，生成一个域名和关联 ip 的表格，提供给代理解析 dns 使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// istio/pkg/dns/server/name_table.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">BuildNameTable</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">Config</span><span class="p">)</span> <span class="o">*</span><span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">Type</span> <span class="o">!=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">SidecarProxy</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="nx">out</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable</span><span class="p">{</span>
    <span class="nx">Table</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable_NameInfo</span><span class="p">),</span>
  <span class="p">}</span>
  <span class="c1">// 将 sidecar 可见的所有 service 返回
</span><span class="c1"></span>  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">svc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nx">SidecarScope</span><span class="p">.</span><span class="nf">Services</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 返回服务器地址，具体到该节点所在的集群
</span><span class="c1"></span>    <span class="nx">svcAddress</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">GetAddressForProxy</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Node</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">addressList</span> <span class="p">[]</span><span class="kt">string</span>
    <span class="nx">hostName</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Hostname</span>
    <span class="k">if</span> <span class="nx">svcAddress</span> <span class="o">!=</span> <span class="nx">constants</span><span class="p">.</span><span class="nx">UnspecifiedIP</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">!</span><span class="nx">netutil</span><span class="p">.</span><span class="nf">IsValidIPAddress</span><span class="p">(</span><span class="nx">svcAddress</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span>
      <span class="p">}</span>
      <span class="nx">addressList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">addressList</span><span class="p">,</span> <span class="nx">svcAddress</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 两种情况会走这，headless 服务，或者 ServiceEntry 自动分配 ip 逻辑无法分配 ip
</span><span class="c1"></span>      <span class="k">if</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Resolution</span> <span class="o">==</span> <span class="nx">model</span><span class="p">.</span><span class="nx">Passthrough</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">svc</span><span class="p">.</span><span class="nx">Ports</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">instance</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">Push</span><span class="p">.</span><span class="nf">ServiceInstancesByPort</span><span class="p">(</span><span class="nx">svc</span><span class="p">,</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Ports</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Port</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">sameNetwork</span> <span class="o">:=</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nf">InNetwork</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">Network</span><span class="p">)</span>
          <span class="nx">sameCluster</span> <span class="o">:=</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">Node</span><span class="p">.</span><span class="nf">InCluster</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">Locality</span><span class="p">.</span><span class="nx">ClusterID</span><span class="p">)</span>
          <span class="c1">// 对于 headless 服务，用 pods ip 填充 dns 表
</span><span class="c1"></span>          <span class="k">if</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">SubDomain</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">sameNetwork</span> <span class="p">{</span>
            <span class="c1">// 示例：mysql-0.mysql.default.svc.cluster.local
</span><span class="c1"></span>            <span class="nx">parts</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">SplitN</span><span class="p">(</span><span class="nx">hostName</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="s">&#34;.&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
              <span class="k">continue</span>
            <span class="p">}</span>
            <span class="nx">address</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">Address</span><span class="p">}</span>
            <span class="nx">shortName</span> <span class="o">:=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">HostName</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">SubDomain</span>
            <span class="nx">host</span> <span class="o">:=</span> <span class="nx">shortName</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">// Add cluster domain.
</span><span class="c1"></span>            <span class="nx">nameInfo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable_NameInfo</span><span class="p">{</span>
              <span class="nx">Ips</span><span class="p">:</span>       <span class="nx">address</span><span class="p">,</span>
              <span class="nx">Registry</span><span class="p">:</span>  <span class="nb">string</span><span class="p">(</span><span class="nx">svc</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nx">ServiceRegistry</span><span class="p">),</span>
              <span class="nx">Namespace</span><span class="p">:</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span>
              <span class="nx">Shortname</span><span class="p">:</span> <span class="nx">shortName</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">Table</span><span class="p">[</span><span class="nx">host</span><span class="p">];</span> <span class="p">!</span><span class="nx">f</span> <span class="o">||</span> <span class="nx">sameCluster</span> <span class="p">{</span>
              <span class="nx">out</span><span class="p">.</span><span class="nx">Table</span><span class="p">[</span><span class="nx">host</span><span class="p">]</span> <span class="p">=</span> <span class="nx">nameInfo</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">skipForMulticluster</span> <span class="o">:=</span> <span class="p">!</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">MulticlusterHeadlessEnabled</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">sameCluster</span>
          <span class="k">if</span> <span class="nx">skipForMulticluster</span> <span class="o">||</span> <span class="p">!</span><span class="nx">sameNetwork</span> <span class="p">{</span>
            <span class="c1">// 只处理本地集群的 endpoints，因为如果返回跨集群的 pods ip 了，就绕过网关
</span><span class="c1"></span>            <span class="k">continue</span>
          <span class="p">}</span>
          <span class="nx">addressList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">addressList</span><span class="p">,</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">addressList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">continue</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">nameInfo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">dnsProto</span><span class="p">.</span><span class="nx">NameTable_NameInfo</span><span class="p">{</span>
      <span class="nx">Ips</span><span class="p">:</span>      <span class="nx">addressList</span><span class="p">,</span>
      <span class="nx">Registry</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">svc</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nx">ServiceRegistry</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nx">ServiceRegistry</span> <span class="o">==</span> <span class="nx">provider</span><span class="p">.</span><span class="nx">Kubernetes</span> <span class="o">&amp;&amp;</span>
      <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasSuffix</span><span class="p">(</span><span class="nx">hostName</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span> <span class="s">&#34;.&#34;</span><span class="o">+</span><span class="nx">constants</span><span class="p">.</span><span class="nx">DefaultClusterSetLocalDomain</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">nameInfo</span><span class="p">.</span><span class="nx">Namespace</span> <span class="p">=</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nx">Namespace</span>
      <span class="nx">nameInfo</span><span class="p">.</span><span class="nx">Shortname</span> <span class="p">=</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Attributes</span><span class="p">.</span><span class="nx">Name</span>
    <span class="p">}</span>
    <span class="nx">out</span><span class="p">.</span><span class="nx">Table</span><span class="p">[</span><span class="nx">hostName</span><span class="p">.</span><span class="nf">String</span><span class="p">()]</span> <span class="p">=</span> <span class="nx">nameInfo</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">out</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="参考">参考</h1>
<ul>
<li><a href="https://istio.io/latest/zh/docs/ops/configuration/traffic-management/dns-proxy/">DNS 代理</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">yefengzhichen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-03-29
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="../../tags/istio/">istio</a>
          <a href="../../tags/kubernetes/">kubernetes</a>
          <a href="../../tags/dns/">dns</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="../../post/istio_gateway/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Istio Ingress/Egress 详解</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="../../post/istio_dubbo_manual/">
            <span class="next-text nav-default">手动接入 dubbo 到 istio</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="yefengzhichen/yefengzhichen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="zhutao_hust@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/yefengzhichen" class="iconfont icon-github" title="github"></a>
  <a href="https://yefengzhichen.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2022 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>yefengzhichen</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="../../js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
