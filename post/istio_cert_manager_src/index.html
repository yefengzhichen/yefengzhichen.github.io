<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>istio é›†æˆ cert-manager ä½¿ç”¨å’Œæºç åˆ†æ - yefengzhichen&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="yefengzhichen" /><meta name="description" content="cert-manager å’Œ mTLS ä»‹ç» cert-manager å°†è¯ä¹¦å’Œè¯ä¹¦é¢å‘è€…æ·»åŠ ä¸º Kubernetes é›†ç¾¤ä¸­çš„èµ„æºç±»å‹ï¼Œå¹¶ç®€åŒ–äº†è·å–ã€æ›´æ–°å’Œä½¿ç”¨è¿™äº›è¯ä¹¦çš„è¿‡ç¨‹ã€‚ç›¸æ¯” istio è‡ªå¸¦çš„ CA ç®¡ç†ï¼Œcert-manager" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.92.1 with theme even" />


<link rel="canonical" href="https://yefengzhichen.github.io/post/istio_cert_manager_src/" />
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../manifest.json">
<link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="../../sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="istio é›†æˆ cert-manager ä½¿ç”¨å’Œæºç åˆ†æ" />
<meta property="og:description" content="cert-manager å’Œ mTLS ä»‹ç» cert-manager å°†è¯ä¹¦å’Œè¯ä¹¦é¢å‘è€…æ·»åŠ ä¸º Kubernetes é›†ç¾¤ä¸­çš„èµ„æºç±»å‹ï¼Œå¹¶ç®€åŒ–äº†è·å–ã€æ›´æ–°å’Œä½¿ç”¨è¿™äº›è¯ä¹¦çš„è¿‡ç¨‹ã€‚ç›¸æ¯” istio è‡ªå¸¦çš„ CA ç®¡ç†ï¼Œcert-manager" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yefengzhichen.github.io/post/istio_cert_manager_src/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-10-26T14:11:10+08:00" />
<meta property="article:modified_time" content="2023-10-26T14:11:10+08:00" />

<meta itemprop="name" content="istio é›†æˆ cert-manager ä½¿ç”¨å’Œæºç åˆ†æ">
<meta itemprop="description" content="cert-manager å’Œ mTLS ä»‹ç» cert-manager å°†è¯ä¹¦å’Œè¯ä¹¦é¢å‘è€…æ·»åŠ ä¸º Kubernetes é›†ç¾¤ä¸­çš„èµ„æºç±»å‹ï¼Œå¹¶ç®€åŒ–äº†è·å–ã€æ›´æ–°å’Œä½¿ç”¨è¿™äº›è¯ä¹¦çš„è¿‡ç¨‹ã€‚ç›¸æ¯” istio è‡ªå¸¦çš„ CA ç®¡ç†ï¼Œcert-manager"><meta itemprop="datePublished" content="2023-10-26T14:11:10+08:00" />
<meta itemprop="dateModified" content="2023-10-26T14:11:10+08:00" />
<meta itemprop="wordCount" content="7466">
<meta itemprop="keywords" content="kubernetes,istio,cert-manager," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="istio é›†æˆ cert-manager ä½¿ç”¨å’Œæºç åˆ†æ"/>
<meta name="twitter:description" content="cert-manager å’Œ mTLS ä»‹ç» cert-manager å°†è¯ä¹¦å’Œè¯ä¹¦é¢å‘è€…æ·»åŠ ä¸º Kubernetes é›†ç¾¤ä¸­çš„èµ„æºç±»å‹ï¼Œå¹¶ç®€åŒ–äº†è·å–ã€æ›´æ–°å’Œä½¿ç”¨è¿™äº›è¯ä¹¦çš„è¿‡ç¨‹ã€‚ç›¸æ¯” istio è‡ªå¸¦çš„ CA ç®¡ç†ï¼Œcert-manager"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../../">
        <li class="mobile-menu-item">é¦–é¡µ</li>
      </a><a href="../../post/">
        <li class="mobile-menu-item">åˆ—è¡¨</li>
      </a><a href="../../tags/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="../../categories/">
        <li class="mobile-menu-item">åˆ†ç±»</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../../">é¦–é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../post/">åˆ—è¡¨</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../tags/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../categories/">åˆ†ç±»</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">istio é›†æˆ cert-manager ä½¿ç”¨å’Œæºç åˆ†æ</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-10-26 </span>
        <div class="post-category">
            <a href="../../categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"> äº‘åŸç”Ÿ </a>
            </div>
          <span class="more-meta"> çº¦ 7466 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 15 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#cert-manager-å’Œ-mtls-ä»‹ç»">cert-manager å’Œ mTLS ä»‹ç»</a>
          <ul>
            <li><a href="#ä»€ä¹ˆæ˜¯tls">ä»€ä¹ˆæ˜¯TLS</a></li>
            <li><a href="#mtlsæ˜¯å¦‚ä½•è¿ä½œçš„">mTLSæ˜¯å¦‚ä½•è¿ä½œçš„</a></li>
          </ul>
        </li>
        <li><a href="#openssl-æ¨¡æ‹Ÿè¯ä¹¦æµç¨‹">openssl æ¨¡æ‹Ÿè¯ä¹¦æµç¨‹</a>
          <ul>
            <li><a href="#åˆ›å»º-ca-ç«¯çš„ç§é’¥å’Œè¯ä¹¦">åˆ›å»º CA ç«¯çš„ç§é’¥å’Œè¯ä¹¦</a></li>
            <li><a href="#æ¨¡æ‹ŸæœåŠ¡ç«¯è¯ä¹¦ç­¾å‘">æ¨¡æ‹ŸæœåŠ¡ç«¯è¯ä¹¦ç­¾å‘</a></li>
          </ul>
        </li>
        <li><a href="#istio-é›†æˆ-cert-manager">istio é›†æˆ cert-manager</a>
          <ul>
            <li><a href="#å®‰è£…å’Œé›†æˆ">å®‰è£…å’Œé›†æˆ</a></li>
            <li><a href="#æŸ¥çœ‹-envoy-ä¸­è·å–çš„è¯ä¹¦">æŸ¥çœ‹ envoy ä¸­è·å–çš„è¯ä¹¦</a></li>
          </ul>
        </li>
        <li><a href="#cert-manager-é€»è¾‘åˆ†æ">cert-manager é€»è¾‘åˆ†æ</a>
          <ul>
            <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
            <li><a href="#åˆ›å»º-pods-æ—¶çš„æ—¥å¿—">åˆ›å»º pods æ—¶çš„æ—¥å¿—</a></li>
            <li><a href="#istio-csr-æºç ">istio-csr æºç </a></li>
            <li><a href="#cert-manager-ç›¸å…³æºç ">cert-manager ç›¸å…³æºç </a></li>
          </ul>
        </li>
        <li><a href="#sidecar-é€»è¾‘åˆ†æ">sidecar é€»è¾‘åˆ†æ</a></li>
        <li><a href="#å‚è€ƒ">å‚è€ƒ</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="cert-manager-å’Œ-mtls-ä»‹ç»">cert-manager å’Œ mTLS ä»‹ç»</h2>
<p>cert-manager å°†è¯ä¹¦å’Œè¯ä¹¦é¢å‘è€…æ·»åŠ ä¸º Kubernetes é›†ç¾¤ä¸­çš„èµ„æºç±»å‹ï¼Œå¹¶ç®€åŒ–äº†è·å–ã€æ›´æ–°å’Œä½¿ç”¨è¿™äº›è¯ä¹¦çš„è¿‡ç¨‹ã€‚ç›¸æ¯” istio è‡ªå¸¦çš„ CA ç®¡ç†ï¼Œcert-manager å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼šæ”¯æŒå¤šç§è¯ä¹¦é¢å‘æœºæ„ï¼Œæ–¹é¢å®ç°ä¸­é—´ CA è¯ä¹¦çš„è½®æ¢ç­‰ã€‚</p>
<p>istio ç½‘æ ¼çš„ä¸€å¤§ç‰¹ç‚¹ï¼Œå°±æ˜¯å¯å®ç°è‡ªåŠ¨ mTLSï¼ˆMutual Transport Layer Securityï¼‰ï¼Œå®Œæˆç½‘æ ¼å†…çš„æµé‡åŠ å¯†ï¼Œæœ‰åŠ©äºç¼©å°äº‘åŸç”Ÿéƒ¨ç½²çš„æ”»å‡»é¢ã€‚istioå¼€å¯mTLSçš„è®¾ç½®æ–¹å¼æœ‰ï¼š</p>
<ul>
<li>é€šè¿‡åˆå§‹åŒ–é…ç½®â€œenableAutoMtlsâ€é€‰é¡¹è®¾ç½®ï¼Œé»˜è®¤ä¸º trueï¼Œç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">apiVersion: v1
kind: ConfigMap
metadata:
  name: istio
  namespace: istio-system
data:
  mesh: |-
    enableAutoMtls: true  # å¼€å¯è‡ªåŠ¨mTLS
</code></pre></td></tr></table>
</div>
</div><ul>
<li>PeerAuthenticationï¼šæŒ‡å®šæŸä¸ªå‘½åç©ºé—´æˆ–è€…æŸä¸ªå·¥ä½œè´Ÿè½½æ˜¯å¦å¼€å¯ mTLSï¼Œmodeå€¼å¯ä¸ºSTRICTã€PERMISSIVEã€DISABLEã€UNSET</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># fooå‘½åç©ºé—´å¯ä»¥æ¥å—mTLSå’Œçº¯æ–‡æœ¬æµé‡
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: foo
spec:
  mtls:
    mode: PERMISSIVE  
---
# fooç©ºé—´ä¸‹financeæœåŠ¡åªæ¥å—mTLSæµé‡
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: finance
  namespace: foo
spec:
  selector:
    matchLabels:
      app: finance
  mtls:
    mode: STRICT
</code></pre></td></tr></table>
</div>
</div><ul>
<li>DestinationRuleï¼šæŒ‡å®šæŸä¸ªå·¥ä½œè´Ÿè½½æ˜¯å¦å¼€å¯ mTLSï¼Œmodeå€¼å¯ä¸ºISTIO_MUTUALã€MUTUALã€SIMPLEã€DISABLE</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"># è¯·æ±‚ratingsæœåŠ¡æ—¶ï¼Œéœ€è¦ä½¿ç”¨istio mTLS
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: ratings-istio-mtls
spec:
  host: ratings.prod.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
</code></pre></td></tr></table>
</div>
</div><h3 id="ä»€ä¹ˆæ˜¯tls">ä»€ä¹ˆæ˜¯TLS</h3>
<p>ä¼ è¾“å±‚å®‰å…¨ (TLS) æ˜¯äº’è”ç½‘ä¸Šå¹¿æ³›ä½¿ç”¨çš„ä¸€ç§åŠ å¯†åè®®ã€‚TLS çš„å‰èº«æ˜¯ SSLï¼Œåœ¨å®¢æˆ·ç«¯-æœåŠ¡å™¨è¿æ¥ä¸­å¯¹æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¹¶å¯¹å®¢æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œä»¥ä¾¿å¤–éƒ¨å„æ–¹æ— æ³•çª¥è§†é€šä¿¡ã€‚TLSåè®®ä¸»è¦ç»„æˆï¼š</p>
<ul>
<li>å…¬é’¥å’Œç§é’¥</li>
<li>TLS è¯ä¹¦</li>
</ul>
<h3 id="mtlsæ˜¯å¦‚ä½•è¿ä½œçš„">mTLSæ˜¯å¦‚ä½•è¿ä½œçš„</h3>
<p>é€šå¸¸åœ¨ TLS ä¸­ï¼ŒæœåŠ¡å™¨æœ‰ä¸€ä¸ª TLS è¯ä¹¦å’Œä¸€ä¸ªå…¬é’¥/ç§é’¥å¯¹ï¼Œè€Œå®¢æˆ·ç«¯æ²¡æœ‰ã€‚å…¸å‹çš„ TLS æµç¨‹æ˜¯è¿™æ ·è¿ä½œçš„ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨</li>
<li>æœåŠ¡å™¨å‡ºç¤ºå…¶ TLS è¯ä¹¦</li>
<li>å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦</li>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡åŠ å¯†çš„ TLS è¿æ¥äº¤æ¢ä¿¡æ¯
<img src="../../image/istio_cert_manager_src/tls_arch.png" alt="TLSæµç¨‹"></li>
</ul>
<p>åœ¨ mTLS ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æœ‰ä¸€ä¸ªè¯ä¹¦ï¼Œå¹¶ä¸”åŒæ–¹éƒ½ä½¿ç”¨å®ƒä»¬çš„å…¬é’¥/ç§é’¥å¯¹è¿›è¡Œèº«ä»½éªŒè¯ã€‚ä¸å¸¸è§„ TLS ç›¸æ¯”ï¼ŒmTLS ä¸­æœ‰ä¸€äº›é¢å¤–æ­¥éª¤æ¥éªŒè¯åŒæ–¹ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨</li>
<li>æœåŠ¡å™¨å‡ºç¤ºå…¶ TLS è¯ä¹¦</li>
<li>å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦</li>
<li><strong>å®¢æˆ·ç«¯å‡ºç¤ºå…¶ TLS è¯ä¹¦</strong></li>
<li><strong>æœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦</strong></li>
<li><strong>æœåŠ¡å™¨æˆäºˆè®¿é—®æƒé™</strong></li>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡åŠ å¯†çš„ TLS è¿æ¥äº¤æ¢ä¿¡æ¯
<img src="../../image/istio_cert_manager_src/mtls_arch.png" alt="mTLSæµç¨‹"></li>
</ul>
<h2 id="openssl-æ¨¡æ‹Ÿè¯ä¹¦æµç¨‹">openssl æ¨¡æ‹Ÿè¯ä¹¦æµç¨‹</h2>
<p>è¿™é‡Œä½¿ç”¨ openssl æ¨¡æ‹Ÿä¸€ä¸ª CA è¯ä¹¦æœºæ„ï¼Œç”Ÿæˆ CA ç«¯çš„ç§é’¥å’Œè¯ä¹¦ï¼Œä»¥åŠç­¾å‘æœåŠ¡ç«¯è¯ä¹¦ã€‚</p>
<h3 id="åˆ›å»º-ca-ç«¯çš„ç§é’¥å’Œè¯ä¹¦">åˆ›å»º CA ç«¯çš„ç§é’¥å’Œè¯ä¹¦</h3>
<p>åˆ›å»ºè¯ä¹¦éœ€è¦æ—¶éœ€è¦ä¸€ä¸ªé…ç½®ï¼ŒåŒ…å«è¯ä¹¦çš„å…¨å±€è®¾ç½®ã€ä¸»é¢˜ä¿¡æ¯ã€æ‰©å±•å­—æ®µç­‰ï¼Œç¤ºä¾‹é…ç½® ca.confï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">[ req ]
default_bits = 2048 #å…¬é’¥é•¿åº¦
prompt = no # ä¸æç¤ºè¾“å…¥
utf8 = yes  # ä»¥ utf8 æ ¼å¼ç¼–ç 
encrypt_key = no # ç§é’¥ä¸åŠ å¯†
distinguished_name  = req_dn # è¯ä¹¦ä¸»é¢˜ä¿¡æ¯
req_extensions = req_ext    # è¯ä¹¦æ‰©å±•å­—æ®µ
x509_extensions = req_ext   # x509 è¯ä¹¦æ‰©å±•å­—æ®µ

[ req_dn ]
O = Istio      # ç»„ç»‡
CN = Root CA    # é€šç”¨åç§°

[ req_ext ]
subjectKeyIdentifier = hash # è¯ä¹¦æ ‡è¯†ç¬¦
basicConstraints = critical, CA:true    # åŸºæœ¬çº¦æŸï¼Œæ˜¯å¦æ˜¯ CA è¯ä¹¦
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign # å¯†é’¥ç”¨æ³•
</code></pre></td></tr></table>
</div>
</div><p>å‚è€ƒ<a href="https://superuser.com/questions/738612/openssl-ca-keyusage-extension">openssl-ca-keyusage</a>ä¸­çš„è¯´æ˜ï¼Œåˆ—ä¸¾äº†å‡ ä¸ªä½¿ç”¨åœºæ™¯ä¸‹keyUsageå¦‚ä½•è®¾ç½®ï¼š</p>
<ul>
<li>è‡ªç­¾å CAï¼šå€¼è®¾ç½®ä¸ºâ€œcritical, cRLSign, digitalSignature, keyCertSignâ€</li>
<li>ä¸­é—´CAï¼šå€¼è®¾ç½®ä¸ºâ€œcritical, cRLSign, digitalSignature, keyCertSignâ€</li>
<li>VPN/Web ServeréCAè¯ä¹¦ï¼šå€¼è®¾ç½®ä¸ºâ€œcritical, nonRepudiation, digitalSignature, keyEncipherment, keyAgreementâ€</li>
<li>VPN ClientéCAè¯ä¹¦ï¼šå€¼è®¾ç½®ä¸ºâ€œcritical, nonRepudiation, digitalSignature, keyEnciphermentâ€</li>
</ul>
<p>keyUsageä¸­éƒ¨åˆ†å€¼è¯´æ˜ï¼š</p>
<ul>
<li>criticalï¼šè¡¨ç¤ºå­—æ®µæ˜¯å¦ä¸ºé‡è¦å­—æ®µï¼Œå¦‚æœä¸€ä¸ªæ‰©å±•è¢«æ ‡è®°ä¸º criticalï¼Œé‚£ä¹ˆä»»ä½•ä¸ç†è§£è¯¥æ‰©å±•çš„å®ä½“éƒ½å¿…é¡»æ‹’ç»è¯¥è¯ä¹¦</li>
<li>keyCertSignï¼šç”¨äºéªŒè¯è¯ä¹¦ä¸Šçš„ç­¾å</li>
<li>digitalSignatureï¼šè¯ä¹¦å¯ç”¨äºåº”ç”¨æ•°å­—ç­¾åï¼Œæ•°å­—ç­¾åé€šå¸¸ç”¨äºå…·æœ‰å®Œæ•´æ€§çš„å®ä½“è®¤è¯å’Œæ•°æ®æºè®¤è¯</li>
<li>nonRepudiationï¼šè¯ä¹¦å¯ç”¨äºç­¾ç½²ä¸Šè¿°æ•°æ®ï¼Œä½†è¯ä¹¦å…¬é’¥å¯ç”¨äºæä¾›ä¸å¯å¦è®¤æœåŠ¡ï¼›è¿™å¯ä»¥é˜²æ­¢ç­¾åå®ä½“é”™è¯¯åœ°æ‹’ç»æŸäº›æ“ä½œ</li>
<li>keyEnciphermentï¼šè¯ä¹¦å¯ç”¨äºåŠ å¯†å¯¹ç§°å¯†é’¥ï¼Œç„¶åå°†è¯¥å¯†é’¥ä¼ è¾“åˆ°ç›®æ ‡ï¼›ç›®æ ‡è§£å¯†å¯†é’¥ï¼Œä½¿ç”¨å®ƒæ¥åŠ å¯†å’Œè§£å¯†å®ä½“ä¹‹é—´çš„æ•°æ®</li>
<li>cRLSignï¼šè¯ä¹¦å¯ç”¨äºéªŒè¯æ’¤é”€ä¿¡æ¯(å¦‚CRL)ä¸Šçš„ç­¾å</li>
<li>keyAgreementï¼šè¯ä¹¦å…è®¸ä½¿ç”¨å¯†é’¥åè®®æ¥å»ºç«‹å…·æœ‰ç›®æ ‡çš„å¯¹ç§°å¯†é’¥ï¼Œå¯ä»¥ä½¿ç”¨å¯¹ç§°å¯†é’¥å¯¹å®ä½“ä¹‹é—´å‘é€çš„æ•°æ®è¿›è¡ŒåŠ å¯†å’Œè§£å¯†</li>
</ul>
<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ç”Ÿæˆç§é’¥</span>
openssl genrsa -out ca.key
<span class="c1"># ç”Ÿæˆè‡ªç­¾åè¯ä¹¦</span>
openssl req -x509 -new -nodes -key ca.key -days <span class="m">365</span> -out ca.pem -config ca.conf
<span class="c1"># æŸ¥çœ‹è¯ä¹¦å†…å®¹ï¼Œ -noout ä¸ç”¨è¾“å‡ºè¯ä¹¦åŸå†…å®¹</span>
openssl x509 -noout -in ca.pem -text
<span class="c1"># ca.pem</span>
Certificate:
    Data:
        Version: <span class="m">3</span> <span class="o">(</span>0x2<span class="o">)</span>
        Serial Number:
            59:50:54:0d:75:87:7f:b0:fa:29:ff:56:6b:2d:ca:c7:97:b5:ef:a7
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: <span class="nv">O</span> <span class="o">=</span> Istio, <span class="nv">CN</span> <span class="o">=</span> Root CA
        Validity
            Not Before: Oct <span class="m">26</span> 06:22:02 <span class="m">2023</span> GMT
            Not After : Oct <span class="m">25</span> 06:22:02 <span class="m">2024</span> GMT
        Subject: <span class="nv">O</span> <span class="o">=</span> Istio, <span class="nv">CN</span> <span class="o">=</span> Root CA
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: <span class="o">(</span><span class="m">2048</span> bit<span class="o">)</span>
                Modulus:
                    00:b2:62:ea:81:76:70:f8:6b:1b:b6:da:14:f3:df:
                    0f:00:25:05:c3:b3:dd:07:de:86:01:0f:9a:32:ea:
                    b0:8b:86:9c:20:d9:f5:cf:cb:91:ff:9c:0d:24:4b:
                    5e:e1:a2:83:f0:f2:2a:95:f1:33:b9:be:d2:f0:08:
                    4a:2b:76:33:af:d7:3c:4e:ef:00:9a:43:bf:51:44:
                    e0:54:a1:6b:3f:bd:95:62:0c:95:fe:83:4a:51:62:
                    5a:39:c9:70:3b:a1:5d:19:cd:f6:25:8f:d9:99:e2:
                    8f:98:3d:99:ba:6b:92:1a:59:25:ea:7f:72:06:b7:
                    11:fe:b2:0a:ee:a3:25:99:29:ba:91:3c:77:94:54:
                    3b:6e:17:81:9d:e6:37:99:fd:f9:d6:7d:1f:a4:a6:
                    39:f7:88:c0:63:d2:fb:0b:6a:cf:e9:6c:6b:1b:63:
                    8e:8e:66:95:f5:ec:b7:28:b2:4e:76:e4:94:bb:57:
                    ed:43:c2:52:4e:b3:07:0b:ba:7f:b9:8a:bf:08:02:
                    97:f3:09:b6:9d:6a:ed:ca:42:70:f4:e2:dc:86:5c:
                    9b:82:28:d7:8b:01:19:26:1b:82:58:cf:e4:00:1f:
                    c8:5c:db:85:28:f5:ef:11:34:a1:58:53:48:be:f2:
                    c9:c6:01:88:60:3d:e3:70:d0:29:ba:fb:e4:d2:e9:
                    f5:3d
                Exponent: <span class="m">65537</span> <span class="o">(</span>0x10001<span class="o">)</span>
        X509v3 extensions:
            X509v3 Subject Key Identifier:
                57:B0:DA:BD:B4:4A:AB:F0:7E:82:80:04:16:EA:AF:BC:6A:A9:A2:7D
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Key Usage: critical
                Digital Signature, Non Repudiation, Key Encipherment, Certificate Sign
    Signature Algorithm: sha256WithRSAEncryption
         37:f9:ba:09:40:80:6d:3c:35:d5:07:01:4c:b8:74:bf:80:16:
         e6:0e:98:ee:28:36:0c:97:c6:74:99:25:07:a8:e3:f3:5e:51:
         0b:e7:68:39:58:99:5c:24:be:2e:a7:b6:1f:d7:b6:95:99:0e:
         70:1b:15ğŸ’¿ec:0e:c5:00:57:12:17:16:c0:85:16:97:05:f3:
         3a:ad:fd:c1:83:d3:26:0e:a8:db:67:35:22:43:00:dc:64:e3:
         50:e0:46:64:63:1b:0b:33:bd:79:36:0c:d0:e9:5a:36:1a:b4:
         80:8f:fb:c7:11:2a:ff:be:67:45:f8:70:40:c8:5a:39:69:df:
         8c:6b:11:f5:19:aa:a1:23:59:1c:5b:81:c0:f4:f9:18:aa:7b:
         5e:01:3b:f7:41:32:83:63:37:eb:0b:e3:0d:c7:72:e3:4f:5a:
         ff:66:ad:3a:eb:9f:58:2c:08:26:c4:84:ee:b0:7e:bd:0dğŸ‡©ğŸ‡ª
         b0:21:d3:75:56:2d:f6:df:4d:64:67:50:de:1b:2c:b6:71:0e:
         cd:cb:82:8d:2e:01:4e:30:ab:9c:3b:a6:24:76:96:cc:e7:ca:
         94:05:bd:ea:ab:65:ad:9b:94:46:98:1c:70:f8:d7:78:16:8f:
         67:7e:ba:bd:5f:0d:1f:46:62:8b:4c:b0:47:23:6e:f7:37:37:
         c7:ac:80:2b
</code></pre></td></tr></table>
</div>
</div><p>è¯ä¹¦å†…å®¹ä¸­åŒ…å«äº†è¯ä¹¦ç‰ˆæœ¬ã€åºåˆ—å·ã€ç­¾åç®—æ³•å’Œå…¬é’¥ç­‰ä¿¡æ¯ã€‚</p>
<h3 id="æ¨¡æ‹ŸæœåŠ¡ç«¯è¯ä¹¦ç­¾å‘">æ¨¡æ‹ŸæœåŠ¡ç«¯è¯ä¹¦ç­¾å‘</h3>
<p>ä¸‹é¢ä½¿ç”¨ CA æ¨¡æ‹Ÿ istio ä¸­è¯ä¹¦çš„ç­¾å‘è¿‡ç¨‹ï¼Œç­¾å‘æ—¶ sidecar ä¸­ istio-agent ä¸­ä¼šç”Ÿæˆç§é’¥å’Œè¯ä¹¦ç­¾åè¯·æ±‚ï¼Œè¯ä¹¦ç­¾åè¯·æ±‚é…ç½®è·Ÿä¸Šé¢ç±»ä¼¼ï¼Œç¤ºä¾‹é…ç½® csr.confï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">[ req ]
default_bits = 2048
prompt = no
utf8 = yes
encrypt_key = no
distinguished_name  = req_dn
req_extensions = req_ext
x509_extensions = req_ext

[ req_dn ]
O = Istio
CN = productpage

[ req_ext ]
subjectKeyIdentifier = hash
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, keyCertSign
</code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œå‘½ä»¤ç­¾å‘ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ç”Ÿæˆç§é’¥</span>
openssl genrsa -out workload.key
<span class="c1"># ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚</span>
openssl req -new -key workload.key -out workload.csr -config csr.conf
<span class="c1"># æŸ¥çœ‹è¯ä¹¦ç­¾åè¯·æ±‚å†…å®¹</span>
openssl req -noout -text -in workload.csr
<span class="c1"># workload.csr</span>
Certificate Request:
    Data:
        Version: <span class="m">1</span> <span class="o">(</span>0x0<span class="o">)</span>
        Subject: <span class="nv">O</span> <span class="o">=</span> Istio, <span class="nv">CN</span> <span class="o">=</span> productpage
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: <span class="o">(</span><span class="m">2048</span> bit<span class="o">)</span>
                Modulus:
                    00:a7:9d:ad:93:cc:ee:88:aa:f6:8a:c6:c5:c7:76:
                    9b:43:2f:2c:d7:7c:f7:ac:ee:16:20:a4:8f:68:03:
                    79:d4:f5ğŸ‡©ğŸ‡ªf9:d7:ee:e2:c1:4d:91:88:8e:23:8a:
                    fd:61:b6:0b:a8:51:69:14:af:14:df:17:b1:fd:e4:
                    ba:56:4b:51:3e:10:6f:e3:1d:ea:c9:23:80:72:bd:
                    80:1a:bc:06:76:1b:28:e1:72:2f:aa:bb:fa:41:fe:
                    8f:33:65:1a:46:e0:b2:1d:6a:07:7e:6c:a6:3b:bc:
                    ac:d1:b1:5c:8f:bd:a3:02:7c:78:f4:5d:19:80:1c:
                    cc:15:13:43:bb:46:a8:f1:e8:74:e4:11:1c:6a:40:
                    fb:8d:11:ea:3a:73:d9:0e:af:54:81:4d:b4:22:3f:
                    45:7d:ee:1b:66:16:d0:e6:fd:15:55:79:d8:26:d4:
                    54:fc:41:27:6c:7b:89:7d:51:f6:0b:ee:ff:7d:38:
                    12:a6:3d:5e:f8:36:a3:bd:34:b0:2a:0c:31:62:f7:
                    68:0b:fb:3d:96:7f:54ğŸ’¿92:75:18:c6:22:fb:22:
                    d9:94:d6:27:1a:ac:cb:f4:4f:e6:8d:7d:2e:c9:9f:
                    37:84:aa:19:40:1d:89:04:94:91:c5:b1:e8:d2:36:
                    de:c5:81:c9:92:ac:f3:a9:37:22:99:93:cd:2d:be:
                    8b:c1
                Exponent: <span class="m">65537</span> <span class="o">(</span>0x10001<span class="o">)</span>
        Attributes:
        Requested Extensions:
            X509v3 Subject Key Identifier:
                8F:B8:8B:0F:B8:27:B0:25:CB:0B:D5:BF:21:CB:3E:E2:6A:B1:99:08
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Key Usage: critical
                Digital Signature, Non Repudiation, Key Encipherment, Certificate Sign
    Signature Algorithm: sha256WithRSAEncryption
         55:3d:4f:5a:7b:4a:af:22:ec:c1:1d:0c:58:d1:76:8a:ae:c7:
         2b:f7:42:0e:42:2a:47:f5:9e:e7:97:58:20:22:75:28:e9:0e:
         8ağŸ’¿74:3c:5e:3b:20:fd:c2:f6:f7:d9:34:7f:57:69:87:22:
         d4:77:70:e6:70:e4:40:eb:88:72:3f:f7:cd:e0:71:19:be:f2:
         d4:6a:89:8b:d9:e7:63:32:0c:1b:04:e2:65:6e:f2:cb:4a:25:
         88:35:02:9b:aa:13:61:a4:45:bd:c6:62:13:26:56:89:7b:46:
         31:33:53:47:df:63:dc:97:79:70:62:c1:59:66:e5:02:bc:98:
         c7:43:12:c3:ad:04:45:ce:cd:79:0b:0e:d9:3f:e6:1a:00:5c:
         67:f6:01:05:7a:c2:6b:58:03:ce:80:51:6d:0b:08:64:af:72:
         e7:8b:a7:0a:18:21:f8:6f:5d:a2:c2:6d:de:1e:b0:39:a1:18:
         16:80:e7:72:d8:2e:71:06:38:16:d9:b8:fa:fb:99:77:4a:f1:
         b9:17:df:a0:39:9d:b8:53:19:34:8b:ac:60:27:a4:79:50:75:
         f7:51:29:d1:d2:3b:87ğŸ’¿b3:08:2d:33:90:d6:a7:87:73:aa:
         8f:09:3c:68:4a:09:3e:dd:a7:8f:98:b3:d3:b7:d7:61:5d:bc:
         c5:55:b9:98

<span class="c1"># ç­¾å‘æœåŠ¡ç«¯è¯ä¹¦</span>
openssl x509 -req -in workload.csr -CA ca.pem -CAkey ca.key <span class="se">\
</span><span class="se"></span>    -CAcreateserial -out workload.pem -days <span class="m">365</span> <span class="se">\
</span><span class="se"></span>    -extensions req_ext -extfile csr.conf -sha256
<span class="c1"># æŸ¥çœ‹è¯ä¹¦å†…å®¹ï¼Œè·Ÿ ca.pem çš„å†…å®¹ç±»ä¼¼ï¼Œè¯ä¹¦ä¸­çš„å…¬é’¥ä¸º workload.csr ä¸­çš„å…¬é’¥</span>
openssl x509 -noout -text -in workload.pem
<span class="c1"># éªŒè¯è¯ä¹¦</span>
openssl verify -CAfile ca.pem workload.pem
</code></pre></td></tr></table>
</div>
</div><h2 id="istio-é›†æˆ-cert-manager">istio é›†æˆ cert-manager</h2>
<p>é›†æˆcert-manageråï¼Œé›†ç¾¤è·å–è¯ä¹¦æ•´ä½“é€»è¾‘å¦‚ä¸‹å›¾ï¼š
<img src="../../image/istio_cert_manager_src/cert_manager_arch.png" alt="è¯·æ±‚cert-managerè·å–è¯ä¹¦æµç¨‹å›¾"></p>
<h3 id="å®‰è£…å’Œé›†æˆ">å®‰è£…å’Œé›†æˆ</h3>
<p>å‚è€ƒ <a href="https://cert-manager.io/docs/tutorials/istio-csr/istio-csr/">ä½¿ç”¨ cert-manager åŠ å¯†æœåŠ¡ç½‘æ ¼</a> å³å¯ï¼Œè¿™é‡Œä½¿ç”¨çš„ istio ç¤ºä¾‹ <a href="https://istio.io/latest/zh/docs/tasks/security/cert-management/plugin-ca-cert/">æ’å…¥ CA è¯ä¹¦</a> ä¸­ç”Ÿæˆçš„ç§é’¥å’Œè¯ä¹¦ï¼Œç„¶ååˆ›å»º secretï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create namespace istio-system 
kubectl -nistio-system create secret tls ca-key-pair --cert<span class="o">=</span>certs/root-cert.pem --key<span class="o">=</span>certs/root-key.pem
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œä½¿ç”¨çš„ root æ ¹è¯ä¹¦ï¼Œå¦‚æœéœ€è¦å¤šé›†ç¾¤éƒ¨ç½²ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸­é—´è¯ä¹¦ã€‚æ¥ç€åˆ›å»º istio-csr éœ€è¦çš„ Issuer å’Œ Certificateï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># issuer ä¼šè¢« Certificate çš„ issuerRef å¼•ç”¨</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istiod-tls</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ca</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">ca-key-pair</span><span class="w"> </span><span class="c"># æä¾›çš„ç§é’¥å’Œè¯ä¹¦</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istiod-tls</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">commonName</span><span class="p">:</span><span class="w"> </span><span class="l">istiod.istio-system.svc</span><span class="w">
</span><span class="w">  </span><span class="nt">dnsNames</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">istiod</span><span class="w">
</span><span class="w">  </span>- <span class="l">istiod.istio-system</span><span class="w">
</span><span class="w">  </span>- <span class="l">istiod.istio-system.svc</span><span class="w">
</span><span class="w">  </span>- <span class="l">istiod.istio-system.svc.cluster</span><span class="w">
</span><span class="w">  </span>- <span class="l">istiod.istio-system.svc.cluster.local</span><span class="w">
</span><span class="w">  </span><span class="nt">uris</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">spiffe://cluster.local/ns/istio-system/sa/istiod-service-account</span><span class="w">
</span><span class="w">  </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">istiod-tls</span><span class="w">
</span><span class="w">  </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">43200h </span><span class="w"> </span><span class="c">#5y</span><span class="w">
</span><span class="w">  </span><span class="nt">renewBefore</span><span class="p">:</span><span class="w"> </span><span class="l">12h</span><span class="w">
</span><span class="w">  </span><span class="nt">privateKey</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rotationPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">    </span><span class="nt">algorithm</span><span class="p">:</span><span class="w"> </span><span class="l">RSA</span><span class="w">
</span><span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="m">2048</span><span class="w">
</span><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istiod-tls</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œåç§°æ²¡ç”¨ istio-ca é»˜è®¤åç§°ï¼Œéœ€è¦åœ¨ istio-csr deployment ä¸­ä¿®æ”¹è®¾ç½®ä¸ºâ€œ&ndash;issuer-name=istiod-tlsâ€ã€‚</p>
<h3 id="æŸ¥çœ‹-envoy-ä¸­è·å–çš„è¯ä¹¦">æŸ¥çœ‹ envoy ä¸­è·å–çš„è¯ä¹¦</h3>
<p>sidecar ä¸­ envoy æ˜¯é€šè¿‡ sds åè®®ä» istio-agent ä¸­è·å–çš„è¯ä¹¦ï¼Œè€Œ istio-agent æ˜¯ä» cert-manager ä¸­è·å–çš„ï¼Œä¸‹é¢ä» envoy æŸ¥çœ‹è·å–åˆ°è¯ä¹¦ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods -nsample
NAME                             READY   STATUS    RESTARTS   AGE
sleep-9454cc476-2qxzs            2/2     Running   <span class="m">0</span>          23h
helloworld-v2-79d5467d55-9hdk7   2/2     Running   <span class="m">0</span>          22h
<span class="c1"># è·å–è¯ä¹¦é“¾</span>
istioctl proxy-config secret helloworld-v2-79d5467d55-9hdk7.sample -o json <span class="p">|</span> jq -r <span class="se">\
</span><span class="se"></span><span class="s1">&#39;.dynamicActiveSecrets[0].secret.tlsCertificate.certificateChain.inlineBytes&#39;</span> <span class="p">|</span> base64 --decode &gt; chain.pem
<span class="c1"># é‡Œé¢æœ‰ä¸¤ä¸ªè¯ä¹¦ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªæ˜¯æ ¹è¯ä¹¦ï¼Œæ­¤å‘½ä»¤åªä¼šè¾“å‡ºç¬¬ä¸€ä¸ªè¯ä¹¦å†…å®¹</span>
openssl x509 -noout -text -in chain.pem
<span class="c1"># è·å–æ ¹è¯ä¹¦ï¼Œè·Ÿ chain.pem ä¸­ç¬¬äºŒä¸ªè¯ä¹¦ä¸€æ ·</span>
istioctl proxy-config secret helloworld-v2-79d5467d55-9hdk7.sample -o json <span class="p">|</span> jq -r <span class="se">\
</span><span class="se"></span><span class="s1">&#39;.dynamicActiveSecrets[1].secret.validationContext.trustedCa.inlineBytes&#39;</span> <span class="p">|</span> base64 --decode &gt; root.pem
<span class="c1"># æŸ¥çœ‹æ ¹è¯ä¹¦å†…å®¹</span>
openssl x509 -noout -text -in root.pem
</code></pre></td></tr></table>
</div>
</div><p>ä»è¿™é‡Œå¯ä»¥çœ‹åˆ° envoy è·å–æ ¹è¯ä¹¦å†…å®¹ï¼Œå³æ˜¯åˆ›å»º ca-key-pair secret æ—¶ä¼ å…¥çš„ root-key.pemã€‚</p>
<h2 id="cert-manager-é€»è¾‘åˆ†æ">cert-manager é€»è¾‘åˆ†æ</h2>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<ul>
<li>pods çš„ sidecar ä¸­ istio-agentï¼Œè°ƒç”¨ caAddress é…ç½®çš„ istio-csr çš„ grpc æœåŠ¡ï¼Œè¯·æ±‚ç­¾åè¯ä¹¦</li>
<li>istio-csr ä¸­çš„ grpc æœåŠ¡ï¼Œä¼šè°ƒç”¨ cert-manager çš„æä¾›çš„ clientï¼Œåˆ›å»ºä¸€ä¸ª CertificateRequest crï¼Œç­‰å¾…å…¶è¢«ç­¾å</li>
<li>cert-manager ä¸­çš„ controller ä¼šç›‘å¬ CertificateRequest åˆ›å»ºäº‹ä»¶ï¼Œè·å–ç›¸åº”çš„issuerå¹¶ç­¾åï¼Œç„¶åå°†ç­¾ååçš„è¯ä¹¦å†™å…¥åˆ° CertificateRequest çš„ status ä¸­ï¼Œå³è®¾ç½® status.ca ä¸º CA çš„è¯ä¹¦ï¼Œstatus.certificate ä¸ºç­¾å‘çš„è¯ä¹¦ã€‚</li>
<li>istio-csr ä¸­çš„ grpc æœåŠ¡ä¸­é€šè¿‡ç›‘å¬æ­¤ CertificateRequestï¼Œä¼šå°†ç­¾ååçš„è¯ä¹¦è¿”å›ç»™ istio-agentã€‚</li>
<li>sidecar ä¸­çš„æœåŠ¡ istio-agent ä¼šæä¾›ä¸€ä¸ª xds åè®®çš„ grpc serverï¼Œç”¨æ¥æä¾›è¯ä¹¦å’Œ ca è¯ä¹¦ç»™ envoy</li>
<li>sidecar ä¸­ envoy é€šè¿‡ socket åœ°å€â€œ./var/run/secrets/workload-spiffe-uds/socketâ€è¿æ¥ istio-agentï¼Œç”¨ xds åè®®è·å– CA è¯ä¹¦å’Œæœ¬åœ°è¯ä¹¦ã€‚</li>
<li>podsä¸­å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡å™¨æ—¶ï¼ŒåŸå§‹httpè¯·æ±‚ç»è¿‡envoyï¼Œä¼š</li>
</ul>
<h3 id="åˆ›å»º-pods-æ—¶çš„æ—¥å¿—">åˆ›å»º pods æ—¶çš„æ—¥å¿—</h3>
<p>cert-manager æœ‰ä»¥ä¸‹å‡ ä¸ªæ¨¡å—ï¼Œè¿™é‡Œä¸»è¦åˆ†æ cert-manager å’Œ cert-manager-istio-csr é€»è¾‘ï¼š</p>
<ul>
<li>cert-manager</li>
<li>cert-manager-istio-csr</li>
<li>cert-manager-webhook</li>
<li>cert-manager-cainjector</li>
</ul>
<p>åœ¨æ–°å»ºä¸€ä¸ª pods æ—¶ï¼ŒæŸ¥çœ‹ cert-manager-istio-csr çš„æ—¥å¿—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">2023-10-23T06:58:52.327281Z  info  klog  cert-manager <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;created CertificateRequest&#34;</span> <span class="s2">&#34;identity&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span>
2023-10-23T06:58:52.335491Z  info  klog  cert-manager <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;waiting for CertificateRequest to become ready&#34;</span> <span class="s2">&#34;identity&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span>
2023-10-23T06:58:52.335529Z  info  klog  cert-manager <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;waiting for CertificateRequest to become ready&#34;</span> <span class="s2">&#34;identity&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span>
2023-10-23T06:58:52.346034Z  info  klog  cert-manager <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;waiting for CertificateRequest to become ready&#34;</span> <span class="s2">&#34;identity&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span>
2023-10-23T06:58:52.384642Z  info  klog  cert-manager <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;signed CertificateRequest&#34;</span> <span class="s2">&#34;identity&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span>
2023-10-23T06:58:52.385999Z  info  klog  grpc-server <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;workload CertificateRequest signed&#34;</span> <span class="s2">&#34;identities&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;serving-addr&#34;</span><span class="o">=</span><span class="s2">&#34;0.0.0.0:6443&#34;</span>
2023-10-23T06:58:52.393159Z  info  klog  cert-manager <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;deleted CertificateRequest&#34;</span> <span class="s2">&#34;identity&#34;</span><span class="o">=</span><span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span> <span class="s2">&#34;name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>æŸ¥çœ‹ cert-manager çš„æ—¥å¿—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">I1023 06:58:52.346517       <span class="m">1</span> controller.go:154<span class="o">]</span> cert-manager/certificaterequests-issuer-ca <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;syncing item&#34;</span> <span class="s2">&#34;key&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system/istio-csr-mjvpt&#34;</span>
I1023 06:58:52.346571       <span class="m">1</span> sync.go:83<span class="o">]</span> cert-manager/certificaterequests-issuer-ca <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;fetching issuer object referenced by CertificateRequest&#34;</span> <span class="s2">&#34;resource_kind&#34;</span><span class="o">=</span><span class="s2">&#34;CertificateRequest&#34;</span> <span class="s2">&#34;resource_name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;resource_namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span> <span class="s2">&#34;resource_version&#34;</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
I1023 06:58:52.346595       <span class="m">1</span> sync.go:98<span class="o">]</span> cert-manager/certificaterequests-issuer-ca <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;ensuring issuer type matches this controller&#34;</span> <span class="s2">&#34;resource_kind&#34;</span><span class="o">=</span><span class="s2">&#34;CertificateRequest&#34;</span> <span class="s2">&#34;resource_name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;resource_namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span> <span class="s2">&#34;resource_version&#34;</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
I1023 06:58:52.346615       <span class="m">1</span> sync.go:125<span class="o">]</span> cert-manager/certificaterequests-issuer-ca <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;validating CertificateRequest resource object&#34;</span> <span class="s2">&#34;resource_kind&#34;</span><span class="o">=</span><span class="s2">&#34;CertificateRequest&#34;</span> <span class="s2">&#34;resource_name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;resource_namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span> <span class="s2">&#34;resource_version&#34;</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
I1023 06:58:52.346634       <span class="m">1</span> sync.go:132<span class="o">]</span> cert-manager/certificaterequests-issuer-ca <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;invoking sign function as existing certificate does not exist&#34;</span> <span class="s2">&#34;resource_kind&#34;</span><span class="o">=</span><span class="s2">&#34;CertificateRequest&#34;</span> <span class="s2">&#34;resource_name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;resource_namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span> <span class="s2">&#34;resource_version&#34;</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
I1023 06:58:52.371870       <span class="m">1</span> ca.go:132<span class="o">]</span> cert-manager/certificaterequests-issuer-ca/sign <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;certificate issued&#34;</span> <span class="s2">&#34;resource_kind&#34;</span><span class="o">=</span><span class="s2">&#34;CertificateRequest&#34;</span> <span class="s2">&#34;resource_name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;resource_namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span> <span class="s2">&#34;resource_version&#34;</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
I1023 06:58:52.372022       <span class="m">1</span> sync.go:178<span class="o">]</span> cert-manager/certificaterequests-issuer-ca/updateStatus <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;updating resource due to change in status&#34;</span> <span class="s2">&#34;diff&#34;</span><span class="o">=[</span><span class="s2">&#34;Conditions: []v1.CertificateRequestCondition[1] != []v1.CertificateRequestCondition[2]&#34;</span>,<span class="s2">&#34;Certificate: []uint8[0] != []uint8[1533]&#34;</span>,<span class="s2">&#34;CA: []uint8[0] != []uint8[1805]&#34;</span><span class="o">]</span> <span class="s2">&#34;resource_kind&#34;</span><span class="o">=</span><span class="s2">&#34;CertificateRequest&#34;</span> <span class="s2">&#34;resource_name&#34;</span><span class="o">=</span><span class="s2">&#34;istio-csr-mjvpt&#34;</span> <span class="s2">&#34;resource_namespace&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system&#34;</span> <span class="s2">&#34;resource_version&#34;</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
I1023 06:58:52.383236       <span class="m">1</span> controller.go:174<span class="o">]</span> cert-manager/certificaterequests-issuer-ca <span class="s2">&#34;msg&#34;</span><span class="o">=</span><span class="s2">&#34;finished processing work item&#34;</span> <span class="s2">&#34;key&#34;</span><span class="o">=</span><span class="s2">&#34;istio-system/istio-csr-mjvpt&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»ºåä¸ºâ€œistio-csr-mjvptâ€çš„ CertificateRequest crï¼Œå¹¶ä¸”å®Œæˆä¹‹åé»˜è®¤ä¼šåˆ é™¤æ­¤ crï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CertificateRequest</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">duration</span><span class="p">:</span><span class="w"> </span><span class="l">24h0m0s</span><span class="w">
</span><span class="w">  </span><span class="nt">extra</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">authentication.kubernetes.io/pod-name</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">cert-manager-istio-csr-75b7d4bd76-d6lvz</span><span class="w">
</span><span class="w">    </span><span class="nt">authentication.kubernetes.io/pod-uid</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">3e93c68d-af2d-4c65-8509-972085974bd1</span><span class="w">
</span><span class="w">  </span><span class="nt">issuerRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Issuer</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istiod-tls</span><span class="w">
</span><span class="w">  </span><span class="nt">request</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">ca</span><span class="p">:</span><span class="w"> </span><span class="l">... </span><span class="w">
</span><span class="w">  </span><span class="nt">certificate</span><span class="p">:</span><span class="w"> </span><span class="l">...</span><span class="w">
</span><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-10-28T19:08:57Z&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate request has been approved by cert-manager.io</span><span class="w">
</span><span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">cert-manager.io</span><span class="w">
</span><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Approved</span><span class="w">
</span><span class="w">  </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2023-10-28T19:08:57Z&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">Certificate fetched from issuer successfully</span><span class="w">
</span><span class="w">    </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">Issued</span><span class="w">
</span><span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Ready</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="istio-csr-æºç ">istio-csr æºç </h3>
<p>istio-csr æœ‰ 3 ä¸ªä¸»è¦ç»„ä»¶ï¼šTLS è¯ä¹¦è·å–å™¨ã€gRPC æœåŠ¡å™¨å’Œ CA åŒ…åˆ†å‘å™¨ã€‚</p>
<ul>
<li>TLS è¯ä¹¦è·å–å™¨ï¼šè´Ÿè´£è·å– gRPC æœåŠ¡å™¨çš„ TLS è¯ä¹¦ã€‚å®ƒä½¿ç”¨ cert-manager API åˆ›å»ºä¸€ä¸ª csrï¼Œè¯¥èµ„æºå°†ç”± cert-manager è·å–ï¼Œå¹¶ç”±é…ç½®çš„ issuer ç­¾åã€‚</li>
<li>gRPC æœåŠ¡å™¨ï¼šè´Ÿè´£æ¥æ”¶æ¥è‡ª istiod çš„è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œå¹¶å°†ç­¾ååçš„è¯ä¹¦å‘é€å›ã€‚å› æ­¤ï¼Œå®ƒä½¿ç”¨ cert-manager CertificateRequest API æ¥è·å–å·²ç­¾åçš„è¯ä¹¦ã€‚</li>
<li>CA åŒ…åˆ†å‘å™¨ï¼šè´Ÿè´£åœ¨æ‰€æœ‰åç§°ç©ºé—´ï¼ˆä½¿ç”¨ namespaceSelector è¿›è¡Œç­›é€‰ï¼‰ä¸­åˆ›å»ºå’Œæ›´æ–° istio-ca-root-cert ConfigMapsã€‚</li>
</ul>
<p>istio-csr ä¸­ç›¸å…³ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/certmanager/certmanager.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">Sign</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">identities</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">csrPEM</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">,</span> <span class="nx">usages</span> <span class="p">[]</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">KeyUsage</span><span class="p">)</span> <span class="p">(</span><span class="nx">Bundle</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">cr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">{</span>
    <span class="nx">ObjectMeta</span><span class="p">:</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">{</span>
      <span class="nx">GenerateName</span><span class="p">:</span> <span class="s">&#34;istio-csr-&#34;</span><span class="p">,</span>
      <span class="nx">Annotations</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
        <span class="nx">identityAnnotation</span><span class="p">:</span> <span class="nx">identities</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
    <span class="nx">Spec</span><span class="p">:</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequestSpec</span><span class="p">{</span>
      <span class="nx">Duration</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">Duration</span><span class="p">{</span>
        <span class="nx">Duration</span><span class="p">:</span> <span class="nx">duration</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">IsCA</span><span class="p">:</span>      <span class="kc">false</span><span class="p">,</span>
      <span class="nx">Request</span><span class="p">:</span>   <span class="nx">csrPEM</span><span class="p">,</span>
      <span class="nx">Usages</span><span class="p">:</span>    <span class="nx">usages</span><span class="p">,</span>
      <span class="nx">IssuerRef</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">IssuerRef</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">AdditionalAnnotations</span> <span class="p">{</span>
    <span class="nx">cr</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
  <span class="p">}</span>
  <span class="c1">// åˆ›å»º CertificateRequestï¼Œè¿™é‡Œçš„ clent æ˜¯ é€šè¿‡ client.CertmanagerV1().CertificateRequests(opts.Namespace) åˆå§‹åŒ–çš„
</span><span class="c1"></span>  <span class="nx">cr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cr</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">{})</span>

  <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;created CertificateRequest&#34;</span><span class="p">)</span>

  <span class="c1">// æ˜¯å¦ä¿ç•™ crï¼Œå¦‚æœä¸ä¿ç•™ï¼Œåˆ™åœ¨è¿”å›æ—¶åˆ é™¤
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">!</span><span class="nx">m</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">PreserveCertificateRequests</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Use go routine to prevent blocking on Delete call.
</span><span class="c1"></span>      <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Use the Background context so that this call is not cancelled by the
</span><span class="c1"></span>        <span class="c1">// gRPC context closing.
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">DeleteOptions</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to delete CertificateRequest&#34;</span><span class="p">)</span>
          <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;deleted CertificateRequest&#34;</span><span class="p">)</span>
      <span class="p">}()</span>
    <span class="p">}()</span>
  <span class="p">}</span>
  <span class="c1">// è®¾ç½® watc ç›‘å¬ certificaterequestï¼Œç­‰å¾…å…¶è¢«ç­¾å
</span><span class="c1"></span>  <span class="nx">signedCR</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">waitForCertificateRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">cr</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Bundle</span><span class="p">{},</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to wait for CertificateRequest %s/%s to be signed: %w&#34;</span><span class="p">,</span>
      <span class="nx">cr</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;signed CertificateRequest&#34;</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">Bundle</span><span class="p">{</span><span class="nx">Certificate</span><span class="p">:</span> <span class="nx">signedCR</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">,</span> <span class="nx">CA</span><span class="p">:</span> <span class="nx">signedCR</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">CA</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ pods çš„ sidecar åˆ›å»ºæ—¶ï¼Œä¼šè¯·æ±‚åˆ° istio-csr çš„ grpc æœåŠ¡ï¼Œä¼šæ‰§è¡Œ grpc server çš„ CreateCertificateï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/server/server.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">CreateCertificate</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">icr</span> <span class="o">*</span><span class="nx">securityapi</span><span class="p">.</span><span class="nx">IstioCertificateRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">securityapi</span><span class="p">.</span><span class="nx">IstioCertificateResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// authn incoming requests, and build concatenated identities for labelling
</span><span class="c1"></span>  <span class="nx">identities</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">authRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">icr</span><span class="p">.</span><span class="nx">Csr</span><span class="p">))</span>
  <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unauthenticated</span><span class="p">,</span> <span class="s">&#34;request authenticate failure&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">log</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">WithValues</span><span class="p">(</span><span class="s">&#34;identities&#34;</span><span class="p">,</span> <span class="nx">identities</span><span class="p">)</span>

  <span class="c1">// If requested duration is larger than the maximum value, override with the
</span><span class="c1"></span>  <span class="c1">// maxiumum value.
</span><span class="c1"></span>  <span class="nx">duration</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">icr</span><span class="p">.</span><span class="nx">ValidityDuration</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
  <span class="k">if</span> <span class="nx">duration</span> <span class="p">&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">MaximumClientCertificateDuration</span> <span class="p">{</span>
    <span class="nx">duration</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">MaximumClientCertificateDuration</span>
  <span class="p">}</span>

  <span class="nx">bundle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">cm</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">identities</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">icr</span><span class="p">.</span><span class="nx">Csr</span><span class="p">),</span> <span class="nx">duration</span><span class="p">,</span> <span class="p">[]</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">KeyUsage</span><span class="p">{</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">UsageClientAuth</span><span class="p">,</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">UsageServerAuth</span><span class="p">})</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to sign incoming client certificate signing request&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">,</span> <span class="s">&#34;failed to sign certificate request&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">certChain</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">parseCertificateBundle</span><span class="p">(</span><span class="nx">bundle</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;failed to parse and verify signed certificate chain from issuer&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">,</span> <span class="s">&#34;failed to parse and verify signed certificate from issuer&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// Build client response object
</span><span class="c1"></span>  <span class="nx">response</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">securityapi</span><span class="p">.</span><span class="nx">IstioCertificateResponse</span><span class="p">{</span>
    <span class="nx">CertChain</span><span class="p">:</span> <span class="nx">certChain</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;workload CertificateRequest signed&#34;</span><span class="p">)</span>

  <span class="c1">// Return response to the client
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">response</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªå‡½æ•°æ³¨å†Œçš„æ¥å£ä¿¡æ¯æè¿°ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// grpc.ServiceDesc ç”¨æ¥æè¿° istio çš„è¯ä¹¦æœåŠ¡
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">IstioCertificateService_ServiceDesc</span> <span class="p">=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ServiceDesc</span><span class="p">{</span>
  <span class="nx">ServiceName</span><span class="p">:</span> <span class="s">&#34;istio.v1.auth.IstioCertificateService&#34;</span><span class="p">,</span>
  <span class="nx">HandlerType</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span><span class="nx">IstioCertificateServiceServer</span><span class="p">)(</span><span class="kc">nil</span><span class="p">),</span>
  <span class="nx">Methods</span><span class="p">:</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">MethodDesc</span><span class="p">{</span>
    <span class="p">{</span>
      <span class="nx">MethodName</span><span class="p">:</span> <span class="s">&#34;CreateCertificate&#34;</span><span class="p">,</span>
      <span class="nx">Handler</span><span class="p">:</span>    <span class="nx">_IstioCertificateService_CreateCertificate_Handler</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
  <span class="nx">Streams</span><span class="p">:</span>  <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">StreamDesc</span><span class="p">{},</span>
  <span class="nx">Metadata</span><span class="p">:</span> <span class="s">&#34;security/v1alpha1/ca.proto&#34;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢ä¼šè°ƒç”¨ cert-manager ä¸­çš„å®¢æˆ·ç«¯ï¼Œå³ CertmanagerV1Client çš„ CertificateRequests å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">// pkg/client/clientset/versioned/typed/certmanager/v1/certmanager_client.go
// istio-csr ä¸­è°ƒç”¨ <span class="s2">&#34;client.CertmanagerV1().CertificateRequests(opts.Namespace)&#34;</span>
func NewForConfigAndClient<span class="o">(</span>c *rest.Config, h *http.Client<span class="o">)</span> <span class="o">(</span>*CertmanagerV1Client, error<span class="o">)</span> <span class="o">{</span>
  config :<span class="o">=</span> *c
  <span class="k">if</span> err :<span class="o">=</span> setConfigDefaults<span class="o">(</span><span class="p">&amp;</span>config<span class="o">)</span><span class="p">;</span> err !<span class="o">=</span> nil <span class="o">{</span>
    <span class="k">return</span> nil, err
  <span class="o">}</span>
  client, err :<span class="o">=</span> rest.RESTClientForConfigAndClient<span class="o">(</span><span class="p">&amp;</span>config, h<span class="o">)</span>
  <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
    <span class="k">return</span> nil, err
  <span class="o">}</span>
  <span class="k">return</span> <span class="p">&amp;</span>CertmanagerV1Client<span class="o">{</span>client<span class="o">}</span>, nil
<span class="o">}</span>

func <span class="o">(</span>c *CertmanagerV1Client<span class="o">)</span> CertificateRequests<span class="o">(</span>namespace string<span class="o">)</span> CertificateRequestInterface <span class="o">{</span>
  <span class="k">return</span> newCertificateRequests<span class="o">(</span>c, namespace<span class="o">)</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æœ€åè°ƒç”¨ç”Ÿæˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/client/clientset/versioned/typed/certmanager/v1/certificaterequest.go
</span><span class="c1">// newCertificateRequests returns a CertificateRequests
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newCertificateRequests</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">CertmanagerV1Client</span><span class="p">,</span> <span class="nx">namespace</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">certificateRequests</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">certificateRequests</span><span class="p">{</span>
    <span class="nx">client</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nf">RESTClient</span><span class="p">(),</span>
    <span class="nx">ns</span><span class="p">:</span>     <span class="nx">namespace</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ¥å—ä¸€ä¸ª certificateRequest çš„èµ„æºå¹¶åˆ›å»º
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">certificateRequests</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">certificateRequest</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">metav1</span><span class="p">.</span><span class="nx">CreateOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">result</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">{}</span>
  <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Post</span><span class="p">().</span>
    <span class="nf">Namespace</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ns</span><span class="p">).</span>
    <span class="nf">Resource</span><span class="p">(</span><span class="s">&#34;certificaterequests&#34;</span><span class="p">).</span>
    <span class="nf">VersionedParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">.</span><span class="nx">ParameterCodec</span><span class="p">).</span>
    <span class="nf">Body</span><span class="p">(</span><span class="nx">certificateRequest</span><span class="p">).</span>
    <span class="nf">Do</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span>
    <span class="nf">Into</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
  <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="cert-manager-ç›¸å…³æºç ">cert-manager ç›¸å…³æºç </h3>
<p>cert-manager ä¸­çš„ controller ä¼šç›‘å¬ CertificateRequest åˆ›å»ºäº‹ä»¶ï¼Œè·å–ç›¸åº”çš„issuerå¹¶ç­¾åï¼Œç„¶åå°†ç­¾ååçš„è¯ä¹¦å†™å…¥åˆ° CertificateRequest çš„ status ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// è¿™ä¸ªæ§åˆ¶å™¨åœ¨ run å‡½æ•°è°ƒç”¨ worker ä» queueingController è·å–çš„ queue ä¸­å¾ªç¯æ‹¿åˆ° objï¼Œç„¶åè°ƒç”¨ queueingController çš„ ProcessItem è¿›è¡Œå¤„ç†
</span><span class="c1">// pkg/controller/controller.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">controller</span><span class="p">)</span> <span class="nf">worker</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">log</span> <span class="o">:=</span> <span class="nx">logf</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">ctx</span><span class="p">)</span>

  <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;starting worker&#34;</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">{</span>
      <span class="c1">// queue å³ queueingController çš„ Register è·å–çš„
</span><span class="c1"></span>    <span class="nx">obj</span><span class="p">,</span> <span class="nx">shutdown</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">shutdown</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">key</span> <span class="kt">string</span>
    <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
      <span class="k">if</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">obj</span><span class="p">.(</span><span class="kt">string</span><span class="p">);</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="nx">log</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">WithValues</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;syncing item&#34;</span><span class="p">)</span>

          <span class="c1">// å³ queueingController çš„ ProcessItem
</span><span class="c1"></span>      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">syncHandler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
          <span class="c1">// ...
</span><span class="c1"></span>      <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;finished processing work item&#34;</span><span class="p">)</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nf">Forget</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="p">}()</span>
  <span class="p">}</span>
  <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;exiting worker loop&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¯ä¹¦è¯·æ±‚æ§åˆ¶å™¨å®šä¹‰å’Œé€»è¾‘å¦‚ä¸‹ï¼Œæ¯æ¬¡æœ‰è¯ä¹¦è¯·æ±‚äº‹ä»¶æ—¶ï¼Œå°±è·å–å…¶å¼•ç”¨çš„ issuer è¿›è¡Œç­¾åï¼Œç„¶åå°†ç­¾ååçš„è¯ä¹¦å’Œ ca å†™å…¥åˆ° CertificateRequest çš„ status ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/controller/certificaterequests/controller.go
</span><span class="c1">// Controller å®ç°äº† queueingController æ¥å®ç°è¯ä¹¦è¯·æ±‚
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Controller</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">helper</span> <span class="nx">issuer</span><span class="p">.</span><span class="nx">Helper</span>
  <span class="nx">cmClient</span> <span class="nx">cmclient</span><span class="p">.</span><span class="nx">Interface</span>
  <span class="nx">fieldManager</span> <span class="nx">strin</span>

  <span class="nx">certificateRequestLister</span> <span class="nx">cmlisters</span><span class="p">.</span><span class="nx">CertificateRequestLister</span>
  <span class="nx">secretLister</span> <span class="nx">internalinformers</span><span class="p">.</span><span class="nx">SecretLister</span>

  <span class="nx">queue</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span>
  <span class="nx">recorder</span> <span class="nx">record</span><span class="p">.</span><span class="nx">EventRecorder</span>
  <span class="c1">// the issuer kind to react to when a certificate request is synced
</span><span class="c1"></span>  <span class="nx">issuerType</span> <span class="kt">string</span>
  <span class="nx">issuerLister</span>        <span class="nx">cmlisters</span><span class="p">.</span><span class="nx">IssuerLister</span>
  <span class="nx">clusterIssuerLister</span> <span class="nx">cmlisters</span><span class="p">.</span><span class="nx">ClusterIssuerLister</span>
  <span class="nx">registerExtraInformers</span> <span class="p">[]</span><span class="nx">RegisterExtraInformerFn</span>

  <span class="c1">// Issuer to call sign function
</span><span class="c1"></span>  <span class="nx">issuerConstructor</span> <span class="nx">IssuerConstructor</span>
  <span class="nx">issuer</span>            <span class="nx">Issuer</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">issuerType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">issuerConstructor</span> <span class="nx">IssuerConstructor</span><span class="p">,</span> <span class="nx">registerExtraInformers</span> <span class="o">...</span><span class="nx">RegisterExtraInformerFn</span><span class="p">)</span> <span class="o">*</span><span class="nx">Controller</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Controller</span><span class="p">{</span>
    <span class="nx">issuerType</span><span class="p">:</span>             <span class="nx">issuerType</span><span class="p">,</span>
    <span class="nx">issuerConstructor</span><span class="p">:</span>      <span class="nx">issuerConstructor</span><span class="p">,</span>
    <span class="nx">registerExtraInformers</span><span class="p">:</span> <span class="nx">registerExtraInformers</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Register åˆå§‹åŒ– controllerï¼Œç›‘å¬ CertificateRequest å¹¶åŠ å…¥åˆ° queue ä¸­ï¼Œå¹¶è¿”å›ä¸€ç»„å¿…é¡»åŒæ­¥çš„å‡½æ•°
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">workqueue</span><span class="p">.</span><span class="nx">RateLimitingInterface</span><span class="p">,</span> <span class="p">[]</span><span class="nx">cache</span><span class="p">.</span><span class="nx">InformerSynced</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">componentName</span> <span class="o">:=</span> <span class="s">&#34;certificaterequests-issuer-&#34;</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">issuerType</span>

  <span class="c1">// construct a new named logger to be reused throughout the controller
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">log</span> <span class="p">=</span> <span class="nx">logf</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">RootContext</span><span class="p">,</span> <span class="nx">componentName</span><span class="p">)</span>

  <span class="c1">// create a queue used to queue up items to be processed
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span> <span class="p">=</span> <span class="nx">workqueue</span><span class="p">.</span><span class="nf">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nf">DefaultItemBasedRateLimiter</span><span class="p">(),</span> <span class="nx">componentName</span><span class="p">)</span>

  <span class="nx">secretsInformer</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">KubeSharedInformerFactory</span><span class="p">.</span><span class="nf">Secrets</span><span class="p">()</span>
  <span class="nx">issuerInformer</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Certmanager</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Issuers</span><span class="p">()</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">issuerLister</span> <span class="p">=</span> <span class="nx">issuerInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">()</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">secretLister</span> <span class="p">=</span> <span class="nx">secretsInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">()</span>

  <span class="c1">// obtain references to all the informers used by this controller
</span><span class="c1"></span>  <span class="nx">certificateRequestInformer</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">SharedInformerFactory</span><span class="p">.</span><span class="nf">Certmanager</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">CertificateRequests</span><span class="p">()</span>
  <span class="nx">mustSync</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">cache</span><span class="p">.</span><span class="nx">InformerSynced</span><span class="p">{</span>
    <span class="nx">certificateRequestInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">,</span>
    <span class="nx">issuerInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">,</span>
    <span class="nx">secretsInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">reg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">registerExtraInformers</span> <span class="p">{</span>
    <span class="nx">ms</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">reg</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to register extra informer: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">mustSync</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">mustSync</span><span class="p">,</span> <span class="nx">ms</span><span class="o">...</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">certificateRequestLister</span> <span class="p">=</span> <span class="nx">certificateRequestInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">()</span>
  <span class="c1">// æœ‰è¯ä¹¦è¯·æ±‚äº‹ä»¶æ—¶ï¼ŒåŠ å…¥åˆ° queue ä¸­
</span><span class="c1"></span>  <span class="nx">certificateRequestInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">QueuingEventHandler</span><span class="p">{</span><span class="nx">Queue</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">})</span>
  <span class="nx">issuerInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">BlockingEventHandler</span><span class="p">{</span><span class="nx">WorkFunc</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">handleGenericIssuer</span><span class="p">})</span>
  <span class="c1">// create an issuer helper for reading generic issuers
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">helper</span> <span class="p">=</span> <span class="nx">issuer</span><span class="p">.</span><span class="nf">NewHelper</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">issuerLister</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">clusterIssuerLister</span><span class="p">)</span>
  <span class="c1">// Construct the issuer implementation with the built component context.
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">issuer</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">issuerConstructor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

  <span class="nx">c</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;new certificate request controller registered&#34;</span><span class="p">,</span>
    <span class="s">&#34;type&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">issuerType</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">mustSync</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// ProcessItem åœ¨ä¸Šé¢çš„ worker å‡½æ•°ä¸­è°ƒç”¨ï¼Œæ¯å½“æœ‰æ–°çš„è¯ä¹¦è¯·æ±‚æ—¶ï¼Œå³æ–°çš„è¯ä¹¦è¯·æ±‚å¯¹è±¡
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">ProcessItem</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">log</span> <span class="o">:=</span> <span class="nx">logf</span><span class="p">.</span><span class="nf">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
  <span class="nx">dbg</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">)</span>

  <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">SplitMetaNamespaceKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;invalid resource key&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="nx">cr</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">certificateRequestLister</span><span class="p">.</span><span class="nf">CertificateRequests</span><span class="p">(</span><span class="nx">namespace</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">k8sErrors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dbg</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;certificate request in work queue no longer exists: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">logf</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">logf</span><span class="p">.</span><span class="nf">WithResource</span><span class="p">(</span><span class="nx">log</span><span class="p">,</span> <span class="nx">cr</span><span class="p">))</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Sync</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cr</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// pkg/controller/certificaterequests/sync.go
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Sync</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">cr</span> <span class="o">*</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">crCopy</span> <span class="o">:=</span> <span class="nx">cr</span><span class="p">.</span><span class="nf">DeepCopy</span><span class="p">()</span>
  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">saveErr</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">updateCertificateRequestStatusAndAnnotations</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cr</span><span class="p">,</span> <span class="nx">crCopy</span><span class="p">);</span> <span class="nx">saveErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="p">=</span> <span class="nx">utilerrors</span><span class="p">.</span><span class="nf">NewAggregate</span><span class="p">([]</span><span class="kt">error</span><span class="p">{</span><span class="nx">saveErr</span><span class="p">,</span> <span class="nx">err</span><span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}()</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">dbg</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;fetching issuer object referenced by CertificateRequest&#34;</span><span class="p">)</span>

  <span class="nx">issuerObj</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">helper</span><span class="p">.</span><span class="nf">GetGenericIssuer</span><span class="p">(</span><span class="nx">crCopy</span><span class="p">.</span><span class="nx">Spec</span><span class="p">.</span><span class="nx">IssuerRef</span><span class="p">,</span> <span class="nx">crCopy</span><span class="p">.</span><span class="nx">Namespace</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">log</span> <span class="p">=</span> <span class="nx">logf</span><span class="p">.</span><span class="nf">WithRelatedResource</span><span class="p">(</span><span class="nx">log</span><span class="p">,</span> <span class="nx">issuerObj</span><span class="p">)</span>
  <span class="nx">dbg</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;ensuring issuer type matches this controller&#34;</span><span class="p">)</span>
  <span class="nx">issuerType</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">apiutil</span><span class="p">.</span><span class="nf">NameForIssuer</span><span class="p">(</span><span class="nx">issuerObj</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">dbg</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;validating CertificateRequest resource object&#34;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">crCopy</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">dbg</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;certificate field is already set in status so skipping processing&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="nx">dbg</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;invoking sign function as existing certificate does not exist&#34;</span><span class="p">)</span>

  <span class="c1">// issuer æ˜¯è°ƒç”¨ NewCA åˆ›å»ºçš„ï¼Œ
</span><span class="c1"></span>  <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">issuer</span><span class="p">.</span><span class="nf">Sign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">crCopy</span><span class="p">,</span> <span class="nx">issuerObj</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;error issuing certificate request&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">err</span>
  <span class="p">}</span>

  <span class="c1">// If the issuer has not returned any data we may be pending or failed. The
</span><span class="c1"></span>  <span class="c1">// underlying issuer will have set the condition of pending or failed and we
</span><span class="c1"></span>  <span class="c1">// should potentially wait for a re-sync.
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">resp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="c1">// Update to status with the new given response.
</span><span class="c1"></span>  <span class="nx">crCopy</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Certificate</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Certificate</span>
  <span class="nx">crCopy</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">CA</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">CA</span>

  <span class="c1">// invalid cert
</span><span class="c1"></span>  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">pki</span><span class="p">.</span><span class="nf">DecodeX509CertificateBytes</span><span class="p">(</span><span class="nx">crCopy</span><span class="p">.</span><span class="nx">Status</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">reporter</span><span class="p">.</span><span class="nf">Failed</span><span class="p">(</span><span class="nx">crCopy</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;DecodeError&#34;</span><span class="p">,</span> <span class="s">&#34;Failed to decode returned certificate&#34;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="c1">// Set condition to Ready.
</span><span class="c1"></span>  <span class="nx">c</span><span class="p">.</span><span class="nx">reporter</span><span class="p">.</span><span class="nf">Ready</span><span class="p">(</span><span class="nx">crCopy</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">ni</span>
</code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­è¯ä¹¦è¯·æ±‚æ§åˆ¶å™¨æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p>
<ul>
<li>selfsigned</li>
<li>ca</li>
<li>venafi</li>
<li>acme</li>
<li>vault</li>
</ul>
<p>ca ç±»å‹çš„åˆå§‹åŒ–ä»£ç ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// pkg/controller/certificaterequests/ca/ca.go
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CA</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">issuerOptions</span> <span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">IssuerOptions</span>
  <span class="nx">secretsLister</span> <span class="nx">internalinformers</span><span class="p">.</span><span class="nx">SecretLister</span>

  <span class="nx">reporter</span> <span class="o">*</span><span class="nx">crutil</span><span class="p">.</span><span class="nx">Reporter</span>

  <span class="c1">// Used for testing to get reproducible resulting certificates
</span><span class="c1"></span>  <span class="nx">templateGenerator</span> <span class="nx">templateGenerator</span>
  <span class="nx">signingFn</span>         <span class="nx">signingFn</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// create certificate request controller for ca issuer
</span><span class="c1"></span>  <span class="nx">controllerpkg</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">CRControllerName</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">ContextFactory</span><span class="p">)</span> <span class="p">(</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">controllerpkg</span><span class="p">.</span><span class="nf">NewBuilder</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">CRControllerName</span><span class="p">).</span>
      <span class="nf">For</span><span class="p">(</span><span class="nx">certificaterequests</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">apiutil</span><span class="p">.</span><span class="nx">IssuerCA</span><span class="p">,</span> <span class="nx">NewCA</span><span class="p">)).</span>
      <span class="nf">Complete</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewCA</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">controllerpkg</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="nx">certificaterequests</span><span class="p">.</span><span class="nx">Issuer</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">CA</span><span class="p">{</span>
    <span class="nx">issuerOptions</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">IssuerOptions</span><span class="p">,</span>
    <span class="nx">secretsLister</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">KubeSharedInformerFactory</span><span class="p">.</span><span class="nf">Secrets</span><span class="p">().</span><span class="nf">Lister</span><span class="p">(),</span>
    <span class="nx">reporter</span><span class="p">:</span>      <span class="nx">crutil</span><span class="p">.</span><span class="nf">NewReporter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Clock</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Recorder</span><span class="p">),</span>
    <span class="nx">templateGenerator</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">x509</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">!</span><span class="nx">utilfeature</span><span class="p">.</span><span class="nx">DefaultMutableFeatureGate</span><span class="p">.</span><span class="nf">Enabled</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">DisallowInsecureCSRUsageDefinition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">pki</span><span class="p">.</span><span class="nf">DeprecatedCertificateTemplateFromCertificateRequestAndAllowInsecureCSRUsageDefinition</span><span class="p">(</span><span class="nx">cr</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">pki</span><span class="p">.</span><span class="nf">CertificateTemplateFromCertificateRequest</span><span class="p">(</span><span class="nx">cr</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="c1">// Sign ä¸­ä½¿ç”¨ï¼Œç”¨æ¥ç­¾åè¯ä¹¦
</span><span class="c1"></span>    <span class="nx">signingFn</span><span class="p">:</span> <span class="nx">pki</span><span class="p">.</span><span class="nx">SignCSRTemplate</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">CA</span><span class="p">)</span> <span class="nf">Sign</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">cr</span> <span class="o">*</span><span class="nx">cmapi</span><span class="p">.</span><span class="nx">CertificateRequest</span><span class="p">,</span> <span class="nx">issuerObj</span> <span class="nx">cmapi</span><span class="p">.</span><span class="nx">GenericIssuer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">issuerpkg</span><span class="p">.</span><span class="nx">IssueResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">secretName</span> <span class="o">:=</span> <span class="nx">issuerObj</span><span class="p">.</span><span class="nf">GetSpec</span><span class="p">().</span><span class="nx">CA</span><span class="p">.</span><span class="nx">SecretName</span>
  <span class="nx">resourceNamespace</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">issuerOptions</span><span class="p">.</span><span class="nf">ResourceNamespace</span><span class="p">(</span><span class="nx">issuerObj</span><span class="p">)</span>

  <span class="c1">// get a copy of the CA certificate named on the Issuer
</span><span class="c1"></span>  <span class="nx">caCerts</span><span class="p">,</span> <span class="nx">caKey</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kube</span><span class="p">.</span><span class="nf">SecretTLSKeyPairAndCA</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">secretsLister</span><span class="p">,</span> <span class="nx">resourceNamespace</span><span class="p">,</span> <span class="nx">issuerObj</span><span class="p">.</span><span class="nf">GetSpec</span><span class="p">().</span><span class="nx">CA</span><span class="p">.</span><span class="nx">SecretName</span><span class="p">)</span>
  <span class="c1">// ...
</span><span class="c1"></span>  <span class="nx">template</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">templateGenerator</span><span class="p">(</span><span class="nx">cr</span><span class="p">)</span>

  <span class="nx">template</span><span class="p">.</span><span class="nx">CRLDistributionPoints</span> <span class="p">=</span> <span class="nx">issuerObj</span><span class="p">.</span><span class="nf">GetSpec</span><span class="p">().</span><span class="nx">CA</span><span class="p">.</span><span class="nx">CRLDistributionPoints</span>
  <span class="nx">template</span><span class="p">.</span><span class="nx">OCSPServer</span> <span class="p">=</span> <span class="nx">issuerObj</span><span class="p">.</span><span class="nf">GetSpec</span><span class="p">().</span><span class="nx">CA</span><span class="p">.</span><span class="nx">OCSPServers</span>

  <span class="nx">bundle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">signingFn</span><span class="p">(</span><span class="nx">caCerts</span><span class="p">,</span> <span class="nx">caKey</span><span class="p">,</span> <span class="nx">template</span><span class="p">)</span>
  <span class="nx">log</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="nx">logf</span><span class="p">.</span><span class="nx">DebugLevel</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;certificate issued&#34;</span><span class="p">)</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">issuerpkg</span><span class="p">.</span><span class="nx">IssueResponse</span><span class="p">{</span>
    <span class="nx">Certificate</span><span class="p">:</span> <span class="nx">bundle</span><span class="p">.</span><span class="nx">ChainPEM</span><span class="p">,</span>
    <span class="nx">CA</span><span class="p">:</span>          <span class="nx">bundle</span><span class="p">.</span><span class="nx">CAPEM</span><span class="p">,</span>
  <span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="sidecar-é€»è¾‘åˆ†æ">sidecar é€»è¾‘åˆ†æ</h2>
<p>ä¸»è¦æ˜¯åˆ©ç”¨ [SecretManagerClient] æ¥åˆ›å»ºç§é’¥å’Œè·å–è¯ä¹¦ï¼Œå¯å‚è€ƒä¹‹å‰çš„ <a href="(https://yefengzhichen.github.io/post/istio_pilot_agent_src/#secretmanagerclient)">istio-agent æºç åˆ†æ</a>ã€‚
è¿™é‡ŒæŸ¥çœ‹ envoy é…ç½®ä¸­ï¼Œå…·ä½“å“ªé‡Œæœ‰ç”¨åˆ°è¯ä¹¦ç›¸å…³é…ç½®ã€‚æŸ¥çœ‹ helloworld sidecar ä¸­ envoy é…ç½®ä¸­ï¼Œæ¶‰åŠ 5000 ç«¯å£å…¥å‘æµé‡çš„é…ç½®ï¼Œå…¶ tls éƒ¨åˆ†å¦‚ä¸‹ï¼Œæ­¤æ—¶å½“å‰ pod ä½œä¸ºæœåŠ¡ç«¯ï¼Œä½¿ç”¨ ROOTCA è¯ä¹¦éªŒè¯å®¢æˆ·ç«¯è¯·æ±‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;filter_chain_match&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;destination_port&#34;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// å¯¹å¤–ç›‘å¬çš„ç«¯å£
</span><span class="c1"></span>     <span class="nt">&#34;transport_protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;tls&#34;</span><span class="p">,</span>
     <span class="nt">&#34;application_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&#34;istio&#34;</span><span class="p">,</span>
      <span class="s2">&#34;istio-peer-exchange&#34;</span><span class="p">,</span>
      <span class="s2">&#34;istio-http/1.0&#34;</span><span class="p">,</span>
      <span class="s2">&#34;istio-http/1.1&#34;</span><span class="p">,</span>
      <span class="s2">&#34;istio-h2&#34;</span>
     <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
     <span class="p">{</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.filters.network.http_connection_manager&#34;</span><span class="p">,</span>
      <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager&#34;</span><span class="p">,</span>
       <span class="nt">&#34;stat_prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;inbound_0.0.0.0_5000&#34;</span><span class="p">,</span>
        <span class="nt">&#34;validate_clusters&#34;</span><span class="p">:</span> <span class="kc">false</span>
       <span class="p">}</span><span class="err">...</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// ä¼ è¾“æ•°æ®çš„åº•å±‚å¥—æ¥å­—é…ç½®
</span><span class="c1"></span>     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>
     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext&#34;</span><span class="p">,</span>
      <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{},</span>
       <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;h2&#34;</span><span class="p">,</span>
        <span class="s2">&#34;http/1.1&#34;</span>
       <span class="p">],</span>
       <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">// æœåŠ¡å™¨ç«¯è¯ä¹¦
</span><span class="c1"></span>        <span class="p">{</span>
         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>  <span class="c1">// æœåŠ¡å™¨è¯ä¹¦åç§°
</span><span class="c1"></span>         <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
           <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
             <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span> <span class="c1">// è·å–æœåŠ¡å™¨ç«¯è¯ä¹¦çš„ SDS æœåŠ¡å™¨
</span><span class="c1"></span>             <span class="p">}</span>
            <span class="p">}</span>
           <span class="p">],</span>
           <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
           <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
          <span class="p">},</span>
          <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
          <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">],</span>
       <span class="nt">&#34;combined_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// éªŒè¯ä¸Šä¸‹æ–‡ï¼Œç”¨äºéªŒè¯å®¢æˆ·ç«¯ï¼Œä¼šåˆå¹¶é»˜è®¤å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡çš„è§„åˆ™
</span><span class="c1"></span>        <span class="nt">&#34;default_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// é»˜è®¤éªŒè¯ä¸Šä¸‹æ–‡
</span><span class="c1"></span>         <span class="nt">&#34;match_subject_alt_names&#34;</span><span class="p">:</span> <span class="p">[</span>  <span class="c1">// åŒ¹é…çš„ SAN è§„åˆ™ï¼Œç”¨äºéªŒè¯æœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯çš„è¯ä¹¦
</span><span class="c1"></span>          <span class="p">{</span>
           <span class="nt">&#34;prefix&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/&#34;</span>
          <span class="p">}</span>
         <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&#34;validation_context_sds_secret_config&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// åŠ¨æ€éªŒè¯ä¸Šä¸‹æ–‡
</span><span class="c1"></span>         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>  <span class="c1">// æ ¹è¯ä¹¦åç§°
</span><span class="c1"></span>         <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
           <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
             <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>  <span class="c1">// è·å–æ ¹è¯ä¹¦çš„ SDS æœåŠ¡å™¨
</span><span class="c1"></span>             <span class="p">}</span>
            <span class="p">}</span>
           <span class="p">],</span>
           <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
           <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
          <span class="p">},</span>
          <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
          <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;require_client_certificate&#34;</span><span class="p">:</span> <span class="kc">true</span>
     <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;0.0.0.0_5000&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ sds-grpc cluster é…ç½®ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
 <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span><span class="p">,</span>
 <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;STATIC&#34;</span><span class="p">,</span>
 <span class="nt">&#34;connect_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;1s&#34;</span><span class="p">,</span>
 <span class="nt">&#34;load_assignment&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span><span class="p">,</span>
  <span class="nt">&#34;endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
   <span class="p">{</span>
    <span class="nt">&#34;lb_endpoints&#34;</span><span class="p">:</span> <span class="p">[</span>
     <span class="p">{</span>
      <span class="nt">&#34;endpoint&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;pipe&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// path ä¸º sds æœåŠ¡åœ°å€ï¼Œå³ pilot-agent çš„ socket åœ°å€
</span><span class="c1"></span>         <span class="nt">&#34;path&#34;</span><span class="p">:</span> <span class="s2">&#34;./var/run/secrets/workload-spiffe-uds/socket&#34;</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">}</span>
     <span class="p">}</span>
    <span class="p">]</span>
   <span class="p">}</span>
  <span class="p">]</span>
 <span class="p">},</span>
 <span class="nt">&#34;typed_extension_protocol_options&#34;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>åŒæ—¶ helloworld sidecar ä¸­ æœ‰é…ç½® sleep cluster ä¿¡æ¯å¦‚ä¸‹ï¼Œæ­¤æ—¶å½“å‰ pods ä½œä¸ºå®¢æˆ·ç«¯ï¼Œå°† default è¯ä¹¦ä½œä¸ºå®¢æˆ·ç«¯è¯ä¹¦ï¼Œä½¿ç”¨ ROOTCA è¯ä¹¦éªŒè¯æœåŠ¡ç«¯çš„è¯ä¹¦ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
 <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-10-24T05:54:24Z/30&#34;</span><span class="p">,</span>
 <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|80||sleep.sample.svc.cluster.local&#34;</span><span class="p">,</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;EDS&#34;</span><span class="p">,</span>
  <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
   <span class="nt">&#34;filter_metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;istio&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;services&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
       <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;sample&#34;</span><span class="p">,</span>
       <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;sleep&#34;</span><span class="p">,</span>
       <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;sleep.sample.svc.cluster.local&#34;</span>
      <span class="p">}</span>
     <span class="p">]</span>
    <span class="p">}</span>
   <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&#34;transport_socket_matches&#34;</span><span class="p">:</span> <span class="p">[</span>
   <span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-istio&#34;</span><span class="p">,</span>
    <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;tlsMode&#34;</span><span class="p">:</span> <span class="s2">&#34;istio&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span>
     <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext&#34;</span><span class="p">,</span>
      <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
       <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;tls_minimum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_2&#34;</span><span class="p">,</span>
        <span class="nt">&#34;tls_maximum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span>
       <span class="p">},</span>
       <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;istio-peer-exchange&#34;</span><span class="p">,</span>
        <span class="s2">&#34;istio&#34;</span>
       <span class="p">],</span>
       <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
         <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
           <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
             <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>
             <span class="p">}</span>
            <span class="p">}</span>
           <span class="p">]</span>
          <span class="p">}</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">],</span>
       <span class="nt">&#34;combined_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;default_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;match_subject_alt_names&#34;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
           <span class="nt">&#34;exact&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/sample/sa/sleep&#34;</span>
          <span class="p">}</span>
         <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&#34;validation_context_sds_secret_config&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>
         <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;api_config_source&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;api_type&#34;</span><span class="p">:</span> <span class="s2">&#34;GRPC&#34;</span><span class="p">,</span>
           <span class="nt">&#34;grpc_services&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
             <span class="nt">&#34;envoy_grpc&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;cluster_name&#34;</span><span class="p">:</span> <span class="s2">&#34;sds-grpc&#34;</span>
             <span class="p">}</span>
            <span class="p">}</span>
           <span class="p">],</span>
           <span class="nt">&#34;set_node_on_first_message_only&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
           <span class="nt">&#34;transport_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
          <span class="p">},</span>
          <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
          <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;sni&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_.80_._.sleep.sample.svc.cluster.local&#34;</span>
     <span class="p">}</span>
    <span class="p">}</span>
   <span class="p">}</span>
  <span class="p">]</span>
 <span class="p">},</span>
 <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-10-25T08:08:29.168Z&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ€»ç»“å°±æ˜¯ï¼Œsidecar ä» cert-manager è·å–äº†æ ¹è¯ä¹¦å’ŒæœåŠ¡å™¨è¯ä¹¦ï¼Œåœ¨ mTLS è¯·æ±‚ä¸­æœ‰ä¸¤ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>ä½œä¸ºæœåŠ¡å™¨æ—¶ï¼šä¸‹å‘å½“å‰è¯ä¹¦ç»™è°ƒç”¨æ–¹ï¼Œç”¨äºè°ƒç”¨æ–¹éªŒè¯èº«ä»½ï¼›åŒæ—¶ç”¨æ ¹è¯ä¹¦éªŒè¯è°ƒç”¨æ–¹èº«ä»½</li>
<li>ä½œä¸ºå®¢æˆ·ç«¯æ—¶ï¼šç”¨æ ¹è¯ä¹¦éªŒè¯æœåŠ¡å™¨èº«ä»½ï¼›åŒæ—¶ä¸‹å‘å½“å‰è¯ä¹¦ç»™æœåŠ¡å™¨ï¼Œç”¨äºæœåŠ¡å™¨éªŒè¯èº«ä»½</li>
</ul>
<p>mTLS è®¤è¯æµç¨‹ï¼Œå¯å‚è€ƒ <a href="https://help.aliyun.com/zh/api-gateway/user-guide/mutual-tls-authentication">HTTPS åŒå‘è®¤è¯</a>ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://jimmysong.io/blog/istio-certificates-management/">Istio ä¸­çš„è¯ä¹¦ç®¡ç†æ–¹å¼ä»‹ç»</a></li>
<li><a href="https://jimmysong.io/blog/understanding-the-tls-encryption-in-istio/">å¦‚ä½•ç†è§£ Istio ä¸­çš„ MTLS æµé‡åŠ å¯†</a></li>
<li><a href="https://www.zhaohuabing.com/post/2020-05-25-istio-certificate/">Isito ä¸­çš„è¯ä¹¦å·¥ä½œæœºåˆ¶</a></li>
<li><a href="https://help.aliyun.com/zh/api-gateway/user-guide/mutual-tls-authentication">HTTPS åŒå‘è®¤è¯</a></li>
<li><a href="https://www.cloudflare.com/zh-cn/learning/access-management/what-is-mutual-tls/">ä»€ä¹ˆæ˜¯mTLS</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">yefengzhichen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2023-10-26
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="../../tags/kubernetes/">kubernetes</a>
          <a href="../../tags/istio/">istio</a>
          <a href="../../tags/cert-manager/">cert-manager</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="../../post/istio_multicluster_analyse/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">istio å¤šé›†ç¾¤è®¿é—®æµç¨‹å’Œæºç åˆ†æ</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="../../post/istio_visibility/">
            <span class="next-text nav-default">Istio æœåŠ¡å¯è§æ€§å’Œå‘½åç©ºé—´éš”ç¦»</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="yefengzhichen/yefengzhichen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="zhutao_hust@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/yefengzhichen" class="iconfont icon-github" title="github"></a>
  <a href="https://yefengzhichen.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2022 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>yefengzhichen</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="../../js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
