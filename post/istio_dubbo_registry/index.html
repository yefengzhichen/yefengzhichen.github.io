<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Istio dubbo协议支持 - yefengzhichen&#39;s blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="yefengzhichen" /><meta name="description" content="背景 需求场景是，将 dubbo2 框架的应用迁移到 istio 网格中，dubbo2 使用的注册中心可能有 zookeeper、nacos、etcd，这里对 dubbo 接入网格的几" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.92.1 with theme even" />


<link rel="canonical" href="https://yefengzhichen.github.io/post/istio_dubbo_registry/" />
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../manifest.json">
<link rel="mask-icon" href="../../safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="../../sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Istio dubbo协议支持" />
<meta property="og:description" content="背景 需求场景是，将 dubbo2 框架的应用迁移到 istio 网格中，dubbo2 使用的注册中心可能有 zookeeper、nacos、etcd，这里对 dubbo 接入网格的几" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yefengzhichen.github.io/post/istio_dubbo_registry/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-02-28T11:34:07+08:00" />
<meta property="article:modified_time" content="2023-02-28T11:34:07+08:00" />

<meta itemprop="name" content="Istio dubbo协议支持">
<meta itemprop="description" content="背景 需求场景是，将 dubbo2 框架的应用迁移到 istio 网格中，dubbo2 使用的注册中心可能有 zookeeper、nacos、etcd，这里对 dubbo 接入网格的几"><meta itemprop="datePublished" content="2023-02-28T11:34:07+08:00" />
<meta itemprop="dateModified" content="2023-02-28T11:34:07+08:00" />
<meta itemprop="wordCount" content="7415">
<meta itemprop="keywords" content="kubernetes,dubbo,registry,istio," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Istio dubbo协议支持"/>
<meta name="twitter:description" content="背景 需求场景是，将 dubbo2 框架的应用迁移到 istio 网格中，dubbo2 使用的注册中心可能有 zookeeper、nacos、etcd，这里对 dubbo 接入网格的几"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="../../">
        <li class="mobile-menu-item">首页</li>
      </a><a href="../../post/">
        <li class="mobile-menu-item">列表</li>
      </a><a href="../../tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="../../categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="../../" class="logo">yefengzhichen&#39;s blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="../../">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../post/">列表</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="../../categories/">分类</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Istio dubbo协议支持</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-02-28 </span>
        <div class="post-category">
            <a href="../../categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"> 云原生 </a>
            </div>
          <span class="more-meta"> 约 7415 字 </span>
          <span class="more-meta"> 预计阅读 15 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a>
      <ul>
        <li><a href="#dubbo-接入-mesh-方案">dubbo 接入 mesh 方案</a></li>
        <li><a href="#istio-支持第三方注册中心原理">istio 支持第三方注册中心原理</a></li>
      </ul>
    </li>
    <li><a href="#dubbo-demo-代码解读">dubbo-demo 代码解读</a>
      <ul>
        <li><a href="#maven-和-pom-说明">Maven 和 POM 说明</a></li>
        <li><a href="#代码解读">代码解读</a></li>
      </ul>
    </li>
    <li><a href="#dubbo2-接入-aeraki-mesh">dubbo2 接入 Aeraki Mesh</a>
      <ul>
        <li><a href="#安装-istio-和-aeraki">安装 istio 和 Aeraki</a></li>
        <li><a href="#接入-zookeeper-实例">接入 zookeeper 实例</a></li>
        <li><a href="#接入-nacos-实例">接入 nacos 实例</a></li>
        <li><a href="#接入-etcd-实例">接入 etcd 实例</a></li>
      </ul>
    </li>
    <li><a href="#aeraki-mesh-逻辑分析">Aeraki mesh 逻辑分析</a></li>
    <li><a href="#使用-envoyfilter-接入-dubbo2">使用 EnvoyFilter 接入 dubbo2</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="背景">背景</h1>
<p>需求场景是，将 dubbo2 框架的应用迁移到 istio 网格中，dubbo2 使用的注册中心可能有 zookeeper、nacos、etcd，这里对 dubbo 接入网格的几种方式做个对比。</p>
<h2 id="dubbo-接入-mesh-方案">dubbo 接入 mesh 方案</h2>
<p>dubbo 接入 mesh，这里要区分 dubbo 和 dubbo3，下面是目前的方案汇总：</p>
<ul>
<li>dubbo2：开源社区方案，如 Aeraki。</li>
<li>dubbo3：需开启新特性（新的地址发现模型、基于 HTTP/2 的 Triple 协议、统一的路由规则），可参考 <a href="https://cn.dubbo.apache.org/zh-cn/overview/tasks/migration/2to3/">升级到 Dubbo3</a> 来迁移 dubbo3，支持两种部署方式
<ul>
<li>Sidecar 模式：只能用 Triple 协议，Dubbo ThinSDK 将只提供面向业务应用的编程 API、RPC 传输通信能力，其余服务治理 包括地址发现、负载均衡、路由寻址等都统一下沉到 Sidecar。</li>
<li>Proxyless 模式：同时支持 Dubbo2、Triple 协议，但只支持应用级服务发现的地址模型，Dubbo3 SDK 直接实现 xDS 协议解析，Dubbo 进程可以与控制面（Control Plane）直接通信，进而实现控制面对流量管控、服务治理、可观测性、安全等的统一管控</li>
</ul>
</li>
</ul>
<p>这几种方案的对比如下：</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>dubbo 版本</th>
<th>支持协议</th>
<th>支持注册中心</th>
<th>调用方式</th>
<th>优点</th>
<th>缺点｜</th>
</tr>
</thead>
<tbody>
<tr>
<td>社区项目 aeraki</td>
<td>dubbo2</td>
<td>dubbo、 thrift 和其他私有协议</td>
<td>zookeeper、nacos、etcd 等</td>
<td>interface 级</td>
<td>兼容 dubbo3、支持协议较多</td>
<td>部分功能可能受限，同时会有一定的性能和容量瓶颈</td>
</tr>
<tr>
<td>dubbo3 Sidecar</td>
<td>dubbo3</td>
<td>triple</td>
<td>只支持 k8s</td>
<td>应用级，providedBy 参数指定</td>
<td>平滑升级、多语言、业务侵入小</td>
<td>不支持自定义注册中心、sidecar 的性能损耗、部署环境受限</td>
</tr>
<tr>
<td>dubbo3 proxyless</td>
<td>dubbo3</td>
<td>triple、dubbo2</td>
<td>只支持 k8s</td>
<td>应用级，providedBy 参数指定</td>
<td>没有 proxy 中转的损耗、架构简单、便于遗留系统的平滑迁移</td>
<td>不支持自定义注册中心</td>
</tr>
</tbody>
</table>
<p>文章最后针对一个特殊场景，只需要支持 dubbo2 协议和第三方注册中心，并且使用 dubbo 自身的服务治理能力的场景，提出一个简化方案，不引入 Aeraki 组件和 MetaProtocol Proxy 代理，只使用 dubbo2istio，手动生成 EnvoyFilter 来支持 dubbo 协议。</p>
<h2 id="istio-支持第三方注册中心原理">istio 支持第三方注册中心原理</h2>
<p>istio 1.8 不再通过 in-tree 方式支持外部注册中心，istio 1.9 改为 MCP-over-XDS 的方式支持外部注册中心。其支持的流程为：</p>
<ul>
<li>为第三方注册中心编写 MCP-over-XDS server。</li>
<li>MCP-over-XDS server 获取第三方注册中心的数据，并转换为 ServiceEntry。</li>
<li>推送给 pilot（如 nacos，pilot 启动时需设置 configSource 参数） 或者写到 ServiceEntry CR 中（如 dubbo2istio）。</li>
<li>pilot 接受到数据后，会对比内存中的数据，保证数据一致。</li>
</ul>
<p>通过这种方式，原有 SDK 注册和调用方式不需要做更改，能更加快速的迁移原有服务。因为 nacos 已经支持了 MCP-over-XDS，这里看下 nacos 支持时，是怎么配置的。nacos 配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">nacos.istio.mcp.server.enabled=true</span><span class="w"> </span><span class="c"># nacos 开启 istio 同步</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>istio 配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">rootNamespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">trustDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span><span class="w"></span><span class="nt">configSources</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置 xds 地址为 nacos</span><span class="w">
</span><span class="w">  </span>- <span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">xds://xxx:18848</span><span class="w">
</span><span class="w"></span><span class="c"># 开启捕获 DNS 请求，解析自定义的 ServiceEntry，参考 [dns 代理](https://preliminary.istio.io/latest/zh/docs/ops/configuration/traffic-management/dns-proxy/)</span><span class="w">
</span><span class="w"></span><span class="nt">proxyMetadata</span><span class="p">:</span><span class="w">  </span><span class="c"># 为代理提供的额外环境变量，会写到代理的启动配置中</span><span class="w">
</span><span class="w">  </span><span class="nt">ISTIO_META_DNS_AUTO_ALLOCATE</span><span class="p">:</span><span class="w"> </span><span class="l">\&#34;true\&#34;</span><span class="w"> </span><span class="c"># 为每个 ServiceEntry 自动分配一个不同的独立地址</span><span class="w">
</span><span class="w">  </span><span class="nt">ISTIO_META_DNS_CAPTURE</span><span class="p">:</span><span class="w"> </span><span class="l">\&#34;true\&#34; </span><span class="w"> </span><span class="c"># 开启 dns 代理，应用程序的 DNS 请求将会被重定向到 Sidecar</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="dubbo-demo-代码解读">dubbo-demo 代码解读</h1>
<p>下面示例的代码来自 <a href="https://github.com/aeraki-mesh/dubbo-demo.git">aeraki-dubbo-demo</a>，因为之前不了解 java 和 dubbo，这里整理下其中的一些知识。</p>
<h2 id="maven-和-pom-说明">Maven 和 POM 说明</h2>
<p>Maven 是专门为 Java 项目打造的管理和构建工具，它的主要功能有：</p>
<ul>
<li>提供了一套标准化的项目结构</li>
<li>提供了一套标准化的构建流程（编译，测试，打包，发布……）</li>
<li>提供了一套依赖管理机制</li>
</ul>
<p>项目目录结构中 pom.xml 是 Maven 的配置文件，POM 是项目对象模型（Project Object Model），用于管理项目的依赖关系、构建设置、插件配置等。执行任务或目标时，Maven 会在当前目录中查找 POM。它读取 POM，获取所需的配置信息，然后执行目标。POM 中可以指定以下配置：</p>
<ul>
<li>项目依赖</li>
<li>插件</li>
<li>执行目标</li>
<li>项目构建 profile</li>
<li>项目版本</li>
<li>项目开发者列表</li>
<li>相关邮件列表信息</li>
</ul>
<p>以下是一个简单的 pom.xml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- 项目分组，公司或者组织的唯一标志 --&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.dubbo<span class="nt">&lt;/groupId&gt;</span>
    <span class="c">&lt;!-- 版本号 --&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="c">&lt;!-- 模型版本 --&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    <span class="c">&lt;!-- 项目的唯一 ID --&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>dubbo-samples-basic<span class="nt">&lt;/artifactId&gt;</span>

    <span class="c">&lt;!-- 属性，其他地方使用${属性名}的方式引用该属性 --&gt;</span>
    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;source.level&gt;</span>1.8<span class="nt">&lt;/source.level&gt;</span>
        <span class="nt">&lt;target.level&gt;</span>1.8<span class="nt">&lt;/target.level&gt;</span>
        <span class="nt">&lt;main-class&gt;</span>org.apache.dubbo.samples.basic.BasicProvider<span class="nt">&lt;/main-class&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>

    <span class="c">&lt;!-- 依赖 --&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Maven 主要会使用到以下命令：</p>
<ul>
<li>mvn package：用于创建项目的可执行 JAR 或 WAR 包，通常情况下，生成的文件名遵循格式“<artifactId>-<version>.<extension>”，比如上面例子中生成的名称是 dubbo-samples-basic-1.0-SNAPSHOT.jar</li>
<li>mvn install： 把打好的包放入本地仓库 (~/.m2/repository)</li>
<li>mvn clean: 清除各个模块 target 目录及里面的内容</li>
<li>mvn deploy: 部署，把包发布到远程仓库</li>
</ul>
<p>其中 mvn package 打包后生成的 jar 包，可以用“jar -xf xx.jar”解压，我们将上面生成的 jar 解压，目录如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">.
├── LICENSE.txt
├── META-INF
├── MapValue.proto
├── ThrowablePB.proto
├── about.html
├── about_files
│   └── LICENSE_CDDL.txt
├── afu
│   ├── org
│   └── plume
├── android
│   └── annotation
├── auth.proto
├── com
│   ├── alibaba
│   ├── embedded
│   ├── fasterxml
│   ├── google
│   └── sun
├── election.proto
├── google
│   ├── api
│   ├── cloud
│   ├── geo
│   ├── logging
│   ├── longrunning
│   ├── protobuf
│   ├── rpc
│   └── <span class="nb">type</span>
├── grpc
│   └── lb
├── io
│   ├── etcd
│   ├── grpc
│   ├── netty
│   ├── perfmark
│   └── prometheus
├── javassist
├── javax
├── jetty-dir.css
├── jline
├── kv.proto
├── lock.proto
├── log4j.properties
├── nacos-log4j2.xml
├── nacos-logback.xml
├── nacos-version.txt
├── net
│   ├── jcip
│   └── jodah
├── org
│   ├── aopalliance
│   ├── apache  <span class="c1"># class 位置</span>
│   ├── checkerframework
│   ├── codehaus
│   ├── eclipse
│   ├── jboss
│   ├── reflections
│   ├── scannotation
│   ├── slf4j
│   ├── springframework
│   └── yaml
├── plugin.properties
├── rpc.proto
├── security
│   └── serialize.blockedlist
└── spring  <span class="c1"># 应用的 xml 配置</span>
    ├── dubbo-demo-consumer.xml
    ├── dubbo-demo-provider.xml
    └── dubbo-second-provider.xml
</code></pre></td></tr></table>
</div>
</div><p>在运行的时候，直接执行以下类似的命令即可：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">java -cp ./dubbo-samples-basic-1.0-SNAPSHOT.jar org.apache.dubbo.samples.basic.BasicProvider
</code></pre></td></tr></table>
</div>
</div><h2 id="代码解读">代码解读</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicProvider</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">//new EmbeddedZooKeeper(2181, false).start();
</span><span class="c1"></span>        <span class="c1">// wait for embedded zookeeper start completely.
</span><span class="c1"></span>        <span class="c1">//Thread.sleep(1000);
</span><span class="c1"></span>        <span class="c1">// 使用到 xml 文件来描述 Spring 中 Bean，在后面可获取到相应的 Bean
</span><span class="c1"></span>        <span class="n">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">&#34;spring/dubbo-demo-provider.xml&#34;</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;dubbo service started&#34;</span><span class="o">);</span>
        <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="n">1</span><span class="o">).</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>查看其 bean 配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;beans</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
       <span class="na">xmlns:dubbo=</span><span class="s">&#34;http://dubbo.apache.org/schema/dubbo&#34;</span>
       <span class="na">xmlns=</span><span class="s">&#34;http://www.springframework.org/schema/beans&#34;</span> <span class="na">xmlns:context=</span><span class="s">&#34;http://www.springframework.org/schema/context&#34;</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
</span><span class="s">       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- 激活${...}占位符的替换，根据指定的属性文件解析 --&gt;</span>
    <span class="nt">&lt;context:property-placeholder/&gt;</span>

    <span class="c">&lt;!-- 当前应用名 --&gt;</span>
    <span class="nt">&lt;dubbo:application</span> <span class="na">name=</span><span class="s">&#34;dubbo-sample-provider&#34;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;dubbo:parameter</span> <span class="na">key=</span><span class="s">&#34;aeraki_meta_app_namespace&#34;</span> <span class="na">value=</span><span class="s">&#34;${AERAKI_META_APP_NAMESPACE}&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;dubbo:parameter</span> <span class="na">key=</span><span class="s">&#34;aeraki_meta_app_service_account&#34;</span> <span class="na">value=</span><span class="s">&#34;${AERAKI_META_APP_SERVICE_ACCOUNT}&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;dubbo:parameter</span> <span class="na">key=</span><span class="s">&#34;aeraki_meta_app_version&#34;</span> <span class="na">value=</span><span class="s">&#34;${AERAKI_META_APP_VERSION}&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;dubbo:parameter</span> <span class="na">key=</span><span class="s">&#34;aeraki_meta_workload_selector&#34;</span> <span class="na">value=</span><span class="s">&#34;${AERAKI_META_WORKLOAD_SELECTOR}&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;dubbo:parameter</span> <span class="na">key=</span><span class="s">&#34;aeraki_meta_locality&#34;</span> <span class="na">value=</span><span class="s">&#34;${AERAKI_META_LOCALITY}&#34;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;dubbo:parameter</span> <span class="na">key=</span><span class="s">&#34;service_group&#34;</span> <span class="na">value=</span><span class="s">&#34;${SERVICE_GROUP}&#34;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/dubbo:application&gt;</span>

    <span class="c">&lt;!-- 注册中心配置，address：地址 --&gt;</span>
    <span class="c">&lt;!-- register：是否向此注册中心注册服务，如果设为 false，将只订阅，不注册 --&gt;</span>
    <span class="c">&lt;!-- subscribe：是否向此注册中心订阅服务，如果设为 false，将只注册，不订阅 --&gt;</span>
    <span class="nt">&lt;dubbo:registry</span> <span class="na">address=</span><span class="s">&#34;${REGISTRY_ADDR}&#34;</span> <span class="na">register=</span><span class="s">&#34;${REGISTER}&#34;</span> <span class="na">subscribe=</span><span class="s">&#34;false&#34;</span> <span class="na">timeout=</span><span class="s">&#34;60000&#34;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--
</span><span class="c">        &lt;dubbo:parameter key=&#34;group&#34; value=&#34;test&#34; /&gt;
</span><span class="c">        &lt;dubbo:parameter key=&#34;namespace&#34; value=&#34;test&#34; /&gt;
</span><span class="c">        --&gt;</span>
    <span class="nt">&lt;/dubbo:registry&gt;</span>

    <span class="c">&lt;!-- bean id 和类的全限定名 --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&#34;demoProvider&#34;</span> <span class="na">class=</span><span class="s">&#34;org.apache.dubbo.samples.basic.impl.DemoProviderImpl&#34;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 服务提供者暴露服务配置，interface：服务接口名，ref：服务对象实现引用 --&gt;</span>
    <span class="nt">&lt;dubbo:service</span> <span class="na">interface=</span><span class="s">&#34;org.apache.dubbo.samples.basic.api.DemoService&#34;</span> <span class="na">ref=</span><span class="s">&#34;demoProvider&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dubbo:service</span> <span class="na">interface=</span><span class="s">&#34;org.apache.dubbo.samples.basic.api.TestService&#34;</span> <span class="na">ref=</span><span class="s">&#34;demoProvider&#34;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- group：接口有多个实现用分组区分，version：服务版本 --&gt;</span>
    <span class="nt">&lt;dubbo:service</span> <span class="na">interface=</span><span class="s">&#34;org.apache.dubbo.samples.basic.api.ComplexService&#34;</span> <span class="na">ref=</span><span class="s">&#34;demoProvider&#34;</span> <span class="na">group=</span><span class="s">&#34;test&#34;</span> <span class="na">version=</span><span class="s">&#34;1.0.0&#34;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;dubbo:service</span> <span class="na">interface=</span><span class="s">&#34;org.apache.dubbo.samples.basic.api.ComplexService&#34;</span> <span class="na">ref=</span><span class="s">&#34;demoProvider&#34;</span> <span class="na">group=</span><span class="s">&#34;product&#34;</span> <span class="na">version=</span><span class="s">&#34;2.0.0&#34;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- 服务消费者引用服务配置，id：服务引用 BeanId --&gt;</span>
    <span class="nt">&lt;dubbo:reference</span> <span class="na">id=</span><span class="s">&#34;secondService&#34;</span> <span class="na">check=</span><span class="s">&#34;true&#34;</span> <span class="na">interface=</span><span class="s">&#34;org.apache.dubbo.samples.basic.api.SecondService&#34;</span> <span class="na">url=</span><span class="s">&#34;dubbo://org.apache.dubbo.samples.basic.api.secondservice:20880&#34;</span> <span class="na">timeout=</span><span class="s">&#34;3000&#34;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="dubbo2-接入-aeraki-mesh">dubbo2 接入 Aeraki Mesh</h1>
<p>这里参考 <a href="https://www.aeraki.net/zh/docs/v1.x/tutorials/dubbo/">Aeraki 官网实例</a>，并将其安装步骤做了简化，下面说明了 dubbo 在 Aeraki Mesh 中，如何接入不同的注册中心 zookeeper、nacos、etcd。</p>
<h2 id="安装-istio-和-aeraki">安装 istio 和 Aeraki</h2>
<p>istio 安装配置文件 istio_config.yaml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">install.istio.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">IstioOperator</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l">default:debug</span><span class="w">
</span><span class="w">  </span><span class="nt">meshConfig</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enableTracing</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 是否开启 trace，需要设置 trace 收集配置</span><span class="w">
</span><span class="w">    </span><span class="nt">accessLogFile</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/stdout</span><span class="w">
</span><span class="w">    </span><span class="nt">accessLogFormat</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;[%START_TIME%] %REQ(X-META-PROTOCOL-APPLICATION-PROTOCOL)%
</span><span class="s2">     %RESPONSE_CODE% %RESPONSE_CODE_DETAILS% %CONNECTION_TERMINATION_DETAILS% \&#34;%UPSTREAM_TRANSPORT_FAILURE_REASON%\&#34;
</span><span class="s2">     %BYTES_RECEIVED% %BYTES_SENT% %DURATION% \&#34;%REQ(X-FORWARDED-FOR)%\&#34; \&#34;%REQ(X-REQUEST-ID)%\&#34; %UPSTREAM_CLUSTER%
</span><span class="s2">     %UPSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_LOCAL_ADDRESS% %DOWNSTREAM_REMOTE_ADDRESS% %ROUTE_NAME%\n&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">defaultConfig</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">holdApplicationUntilProxyStarts</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 添加一个 hook 来延迟应用启动，等 pod 代理准备好接收流量后</span><span class="w">
</span><span class="w">      </span><span class="nt">proxyMetadata</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">ISTIO_META_DNS_CAPTURE</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w"> </span><span class="c"># 开启 dns 代理</span><span class="w">
</span><span class="w">      </span><span class="nt">proxyStatsMatcher</span><span class="p">:</span><span class="w">    </span><span class="c"># 代理统计匹配器</span><span class="w">
</span><span class="w">        </span><span class="nt">inclusionPrefixes</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">thrift</span><span class="w">
</span><span class="w">          </span>- <span class="l">dubbo</span><span class="w">
</span><span class="w">          </span>- <span class="l">kafka</span><span class="w">
</span><span class="w">          </span>- <span class="l">meta_protocol</span><span class="w">
</span><span class="w">        </span><span class="nt">inclusionRegexps</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="l">.*dubbo.*</span><span class="w">
</span><span class="w">          </span>- <span class="l">.*thrift.*</span><span class="w">
</span><span class="w">          </span>- <span class="l">.*kafka.*</span><span class="w">
</span><span class="w">          </span>- <span class="l">.*zookeeper.*</span><span class="w">
</span><span class="w">          </span>- <span class="l">.*meta_protocol.*</span><span class="w">
</span><span class="w">      </span><span class="nt">tracing</span><span class="p">:</span><span class="w"> </span><span class="c"># tracing 配置</span><span class="w">
</span><span class="w">        </span><span class="nt">sampling</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">        </span><span class="nt">zipkin</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l">zipkin.istio-system:9411</span><span class="w">
</span><span class="w">  </span><span class="nt">components</span><span class="p">:</span><span class="w">   </span><span class="c"># 参考 [IstioComponentSetSpec](https://istio.io/latest/docs/reference/config/istio.operator.v1alpha1/#IstioComponentSetSpec)</span><span class="w">
</span><span class="w">    </span><span class="nt">pilot</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">hub</span><span class="p">:</span><span class="w"> </span><span class="l">istio   </span><span class="w"> </span><span class="c"># 镜像</span><span class="w">
</span><span class="w">      </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="m">1.14.5</span><span class="w">   </span><span class="c"># tag</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> aeraki
vim istio_config.yaml <span class="c1"># 编辑 istio 配置</span>
istioctl install -y -f istio_config.yaml <span class="c1"># 安装 istio</span>
make install    <span class="c1"># 安装 aeraki</span>

<span class="c1"># 下载代码和创建命名空间</span>
git clone https://github.com/aeraki-mesh/dubbo2istio.git
<span class="nb">cd</span> dubbo2istio
kubectl create ns meta-dubbo
kubectl label namespace meta-dubbo istio-injection<span class="o">=</span>enabled --overwrite<span class="o">=</span><span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="接入-zookeeper-实例">接入 zookeeper 实例</h2>
<p>执行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f demo/k8s/zk -n meta-dubbo
</code></pre></td></tr></table>
</div>
</div><p>等待服务启动后查看部署情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@dev:~/zt/istio/dubbo2istio# kubens meta-dubbo
✔ Active namespace is <span class="s2">&#34;meta-dubbo&#34;</span>
root@dev:~/zt/istio/dubbo2istio# kubectl get pods
NAME                                            READY   STATUS    RESTARTS   AGE
dubbo2istio-5c49bc5f8d-4wns5                    1/1     Running   <span class="m">0</span>          79m
dubbo-sample-consumer-6749fc7df9-lc7hj          2/2     Running   <span class="m">0</span>          79m
dubbo-sample-provider-v2-566c4fd8bb-9w6mg       2/2     Running   <span class="m">0</span>          79m
dubbo-sample-provider-v1-86d5d5cc7c-vvg5d       2/2     Running   <span class="m">0</span>          79m
zookeeper-cc7f59dd6-tlnpg                       1/1     Running   <span class="m">0</span>          79m
dubbo-sample-second-provider-7958bfbbdc-qnz7b   2/2     Running   <span class="m">0</span>          79m
</code></pre></td></tr></table>
</div>
</div><p>查看 consumer 日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Periodically call dubbo server
Start a http server for e2e test
...
Hello Aeraki, response from dubbo-sample-provider-v1-86d5d5cc7c-vvg5d/10.42.0.27
Hello Aeraki, response from dubbo-sample-provider-v2-566c4fd8bb-9w6mg/10.42.0.30
Hello Aeraki, response from dubbo-sample-provider-v1-86d5d5cc7c-vvg5d/10.42.0.27
Hello Aeraki, response from dubbo-sample-provider-v2-566c4fd8bb-9w6mg/10.42.0.30
</code></pre></td></tr></table>
</div>
</div><h2 id="接入-nacos-实例">接入 nacos 实例</h2>
<p>执行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 先卸载上面的 zookeeper 部署</span>
kubectl delete -f demo/k8s/zk -n meta-dubbo
kubectl apply -f demo/k8s/nacos -n meta-dubbo
</code></pre></td></tr></table>
</div>
</div><p>同样查看 consumer 日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">Periodically call dubbo server
Start a http server <span class="k">for</span> e2e <span class="nb">test</span>
...
Hello Aeraki, response from dubbo-sample-provider-v1-76c9c7f88c-6mbbk/10.42.0.40
Hello Aeraki, response from dubbo-sample-provider-v2-5bb778d49b-ln8d4/10.42.0.39
Hello Aeraki, response from dubbo-sample-provider-v1-76c9c7f88c-6mbbk/10.42.0.40
Hello Aeraki, response from dubbo-sample-provider-v2-5bb778d49b-ln8d4/10.42.0.39
</code></pre></td></tr></table>
</div>
</div><h2 id="接入-etcd-实例">接入 etcd 实例</h2>
<p>执行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 先卸载上面的 nacos 部署</span>
kubectl delete -f demo/k8s/nacos -n meta-dubbo
kubectl apply -f demo/k8s/etcd -n meta-dubbo
</code></pre></td></tr></table>
</div>
</div><p>同样查看 consumer 日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">Periodically call dubbo server
Start a http server <span class="k">for</span> e2e <span class="nb">test</span>
...
Hello Aeraki, response from dubbo-sample-provider-v1-5d9496c8bc-zdhdk/10.42.0.51
Hello Aeraki, response from dubbo-sample-provider-v2-59c8778bb-8hbmk/10.42.0.54
Hello Aeraki, response from dubbo-sample-provider-v1-5d9496c8bc-zdhdk/10.42.0.51
Hello Aeraki, response from dubbo-sample-provider-v2-59c8778bb-8hbmk/10.42.0.54
</code></pre></td></tr></table>
</div>
</div><h1 id="aeraki-mesh-逻辑分析">Aeraki mesh 逻辑分析</h1>
<p>以使用 zookeeper 注册中心为例，这里先查看 dubbo2istio 的日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">2023-02-27T11:57:25.254890Z	info	dubbo2istio runs in Zookeeper mode: registry: default, addr: zookeeper:2181
2023-02-27T11:57:25.257483Z	info	connected to 10.43.194.10:2181
2023-02-27T11:57:33.374613Z	info	service entry aeraki-org-apache-dubbo-samples-basic-api-demoservice has been updated: <span class="o">{</span><span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;aeraki-org-apache-dubbo-samples-basic-api-demoservice&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;meta-dubbo&#34;</span>,<span class="s2">&#34;resourceVersion&#34;</span>:<span class="s2">&#34;421514&#34;</span>,<span class="s2">&#34;creationTimestamp&#34;</span>:null,<span class="s2">&#34;labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;manager&#34;</span>:<span class="s2">&#34;aeraki&#34;</span>,<span class="s2">&#34;registry&#34;</span>:<span class="s2">&#34;dubbo2istio&#34;</span><span class="o">}</span>,<span class="s2">&#34;annotations&#34;</span>:<span class="o">{</span><span class="s2">&#34;interface&#34;</span>:<span class="s2">&#34;org.apache.dubbo.samples.basic.api.DemoService&#34;</span>,<span class="s2">&#34;workloadSelector&#34;</span>:<span class="s2">&#34;dubbo-sample-provider&#34;</span><span class="o">}}</span>,<span class="s2">&#34;spec&#34;</span>:<span class="o">{</span><span class="s2">&#34;hosts&#34;</span>:<span class="o">[</span><span class="s2">&#34;org.apache.dubbo.samples.basic.api.demoservice&#34;</span><span class="o">]</span>,<span class="s2">&#34;ports&#34;</span>:<span class="o">[{</span><span class="s2">&#34;number&#34;</span>:20880,<span class="s2">&#34;protocol&#34;</span>:<span class="s2">&#34;tcp&#34;</span>,<span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;tcp-metaprotocol-dubbo&#34;</span>,<span class="s2">&#34;targetPort&#34;</span>:20880<span class="o">}]</span>,<span class="s2">&#34;location&#34;</span>:<span class="s2">&#34;MESH_INTERNAL&#34;</span>,<span class="s2">&#34;resolution&#34;</span>:<span class="s2">&#34;STATIC&#34;</span>,<span class="s2">&#34;endpoints&#34;</span>:<span class="o">[{</span><span class="s2">&#34;address&#34;</span>:<span class="s2">&#34;10.42.0.64&#34;</span>,<span class="s2">&#34;ports&#34;</span>:<span class="o">{</span><span class="s2">&#34;tcp-metaprotocol-dubbo&#34;</span>:20880<span class="o">}</span>,<span class="s2">&#34;labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;anyhost&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;application&#34;</span>:<span class="s2">&#34;dubbo-sample-provider&#34;</span>,<span class="s2">&#34;default&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;deprecated&#34;</span>:<span class="s2">&#34;false&#34;</span>,<span class="s2">&#34;dubbo&#34;</span>:<span class="s2">&#34;2.0.2&#34;</span>,<span class="s2">&#34;dynamic&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;generic&#34;</span>:<span class="s2">&#34;false&#34;</span>,<span class="s2">&#34;interface&#34;</span>:<span class="s2">&#34;org.apache.dubbo.samples.basic.api.DemoService&#34;</span>,<span class="s2">&#34;metadata-type&#34;</span>:<span class="s2">&#34;remote&#34;</span>,<span class="s2">&#34;methods&#34;</span>:<span class="s2">&#34;testVoid-sayHello&#34;</span>,<span class="s2">&#34;pid&#34;</span>:<span class="s2">&#34;8&#34;</span>,<span class="s2">&#34;registryName&#34;</span>:<span class="s2">&#34;default&#34;</span>,<span class="s2">&#34;release&#34;</span>:<span class="s2">&#34;1.0-SNAPSHOT&#34;</span>,<span class="s2">&#34;revision&#34;</span>:<span class="s2">&#34;1.0-SNAPSHOT&#34;</span>,<span class="s2">&#34;service_group&#34;</span>:<span class="s2">&#34;batchjob&#34;</span>,<span class="s2">&#34;side&#34;</span>:<span class="s2">&#34;provider&#34;</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;1677499051587&#34;</span>,<span class="s2">&#34;version&#34;</span>:<span class="s2">&#34;v2&#34;</span><span class="o">}</span>,<span class="s2">&#34;locality&#34;</span>:<span class="s2">&#34;bj/800005&#34;</span>,<span class="s2">&#34;serviceAccount&#34;</span>:<span class="s2">&#34;default&#34;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;address&#34;</span>:<span class="s2">&#34;10.42.0.63&#34;</span>,<span class="s2">&#34;ports&#34;</span>:<span class="o">{</span><span class="s2">&#34;tcp-metaprotocol-dubbo&#34;</span>:20880<span class="o">}</span>,<span class="s2">&#34;labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;anyhost&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;application&#34;</span>:<span class="s2">&#34;dubbo-sample-provider&#34;</span>,<span class="s2">&#34;default&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;deprecated&#34;</span>:<span class="s2">&#34;false&#34;</span>,<span class="s2">&#34;dubbo&#34;</span>:<span class="s2">&#34;2.0.2&#34;</span>,<span class="s2">&#34;dynamic&#34;</span>:<span class="s2">&#34;true&#34;</span>,<span class="s2">&#34;generic&#34;</span>:<span class="s2">&#34;false&#34;</span>,<span class="s2">&#34;interface&#34;</span>:<span class="s2">&#34;org.apache.dubbo.samples.basic.api.DemoService&#34;</span>,<span class="s2">&#34;metadata-type&#34;</span>:<span class="s2">&#34;remote&#34;</span>,<span class="s2">&#34;methods&#34;</span>:<span class="s2">&#34;testVoid-sayHello&#34;</span>,<span class="s2">&#34;pid&#34;</span>:<span class="s2">&#34;7&#34;</span>,<span class="s2">&#34;registryName&#34;</span>:<span class="s2">&#34;default&#34;</span>,<span class="s2">&#34;release&#34;</span>:<span class="s2">&#34;1.0-SNAPSHOT&#34;</span>,<span class="s2">&#34;revision&#34;</span>:<span class="s2">&#34;1.0-SNAPSHOT&#34;</span>,<span class="s2">&#34;service_group&#34;</span>:<span class="s2">&#34;user&#34;</span>,<span class="s2">&#34;side&#34;</span>:<span class="s2">&#34;provider&#34;</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;1677499051569&#34;</span>,<span class="s2">&#34;version&#34;</span>:<span class="s2">&#34;v1&#34;</span><span class="o">}</span>,<span class="s2">&#34;locality&#34;</span>:<span class="s2">&#34;bj/800002&#34;</span>,<span class="s2">&#34;serviceAccount&#34;</span>:<span class="s2">&#34;default&#34;</span><span class="o">}]}</span>,<span class="s2">&#34;status&#34;</span>:<span class="o">{}}</span>
</code></pre></td></tr></table>
</div>
</div><p>针对 demoservice 生成了一个名为 aeraki-org-apache-dubbo-samples-basic-api-demoservice 的 ServiceEntry，用命令获取其描述如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceEntry</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.basic.api.DemoService</span><span class="w">
</span><span class="w">    </span><span class="nt">workloadSelector</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">manager</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki</span><span class="w">
</span><span class="w">    </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo2istio</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki-org-apache-dubbo-samples-basic-api-demoservice</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">meta-dubbo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="c"># 与该服务相关的虚拟 IP 地址，可以是 CIDR 前缀。对于 HTTP 流量，生成的路由配置将包括地址和主机字段值的 http 路由域，目的地将根据 HTTP 主机/授权头来识别。如果指定了一个或多个 IP 地址，如果目的地 IP 与地址字段中指定的 IP/CIDRs 相匹配，传入的流量将被识别为属于该服务。如果地址字段为空，流量将仅根据目标端口进行识别。</span><span class="w">
</span><span class="w">  </span><span class="nt">addresses</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="m">240.240.0.46</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">    </span><span class="c"># 此服务关联的 hosts，可以是带通配符的 DNS 名称</span><span class="w">
</span><span class="w">  </span>- <span class="l">org.apache.dubbo.samples.basic.api.demoservice</span><span class="w">
</span><span class="w">  </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l">MESH_INTERNAL  </span><span class="w"> </span><span class="c"># 指定服务是在网格外部还是网格内部</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp-metaprotocol-dubbo</span><span class="w"> </span><span class="c"># Aeraki 会识别后面的应用协议并进行相应的七层处理</span><span class="w">
</span><span class="w">    </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span><span class="w">  </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l">STATIC</span><span class="w">
</span><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="m">10.42.0.64</span><span class="w"> </span><span class="c"># dubbo-sample-provider-v2 的 pod ip</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">   </span><span class="c"># endpoints 相关的标签</span><span class="w">
</span><span class="w">      </span><span class="nt">anyhost</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">application</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w">      </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">deprecated</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">dubbo</span><span class="p">:</span><span class="w"> </span><span class="m">2.0.2</span><span class="w">
</span><span class="w">      </span><span class="nt">dynamic</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">generic</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.basic.api.DemoService</span><span class="w">
</span><span class="w">      </span><span class="nt">metadata-type</span><span class="p">:</span><span class="w"> </span><span class="l">remote</span><span class="w">
</span><span class="w">      </span><span class="nt">methods</span><span class="p">:</span><span class="w"> </span><span class="l">testVoid-sayHello</span><span class="w">
</span><span class="w">      </span><span class="nt">pid</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;8&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">registryName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">      </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="m">1.0</span>-<span class="l">SNAPSHOT</span><span class="w">
</span><span class="w">      </span><span class="nt">revision</span><span class="p">:</span><span class="w"> </span><span class="m">1.0</span>-<span class="l">SNAPSHOT</span><span class="w">
</span><span class="w">      </span><span class="nt">service_group</span><span class="p">:</span><span class="w"> </span><span class="l">batchjob</span><span class="w">
</span><span class="w">      </span><span class="nt">side</span><span class="p">:</span><span class="w"> </span><span class="l">provider</span><span class="w">
</span><span class="w">      </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1677499051587&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v2</span><span class="w">
</span><span class="w">    </span><span class="nt">locality</span><span class="p">:</span><span class="w"> </span><span class="l">bj/800005</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">tcp-metaprotocol-dubbo</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span><span class="w">    </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span>- <span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="m">10.42.0.63</span><span class="w">     </span><span class="c"># # dubbo-sample-provider-v1 的 pod ip</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ServiceEntry 是可以添加额外的服务项到 istio 内部的服务注册中心，这样网格可以将请求转发到这些指定的服务，这些服务的 endpoints 可以是 VM 负载或者 kubernetes 的 pods。 其中某些 host 是一个必选字段，表示与 ServiceEntry 相关的主机名，可以是一个 DNS 域名，还可以使用前缀模糊匹配。在使用上有以下几个说明：</p>
<ul>
<li>HTTP 的流量，在这个字段匹配 HTTP Header 的 Host 或 Authority。</li>
<li>HTTPS 或 TLS 流量，这个字段匹配 SNI。</li>
<li>其他协议的流量，这个字段不生效，使用下面的 addresses 和 port 字段。</li>
<li>当 resolution 被设置为 DNS 类型并且没有指定 endpoints 时，这个字段将作为后端的域名来进行路由。
这时在 istiod 中 pods 中通过<code>curl http://127.0.0.1:15014/debug/registryz</code>查看此注册项，如下：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
	<span class="nt">&#34;Attributes&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;ServiceRegistry&#34;</span><span class="p">:</span> <span class="s2">&#34;External&#34;</span><span class="p">,</span>
		<span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;org.apache.dubbo.samples.basic.api.demoservice&#34;</span><span class="p">,</span>
		<span class="nt">&#34;Namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;meta-dubbo&#34;</span><span class="p">,</span>
		<span class="nt">&#34;Labels&#34;</span><span class="p">:</span> <span class="p">{</span>
			<span class="nt">&#34;manager&#34;</span><span class="p">:</span> <span class="s2">&#34;aeraki&#34;</span><span class="p">,</span>
			<span class="nt">&#34;registry&#34;</span><span class="p">:</span> <span class="s2">&#34;dubbo2istio&#34;</span>
		<span class="p">},</span>
		<span class="nt">&#34;ExportTo&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
		<span class="nt">&#34;LabelSelectors&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
		<span class="nt">&#34;ClusterExternalAddresses&#34;</span><span class="p">:</span> <span class="p">{</span>
			<span class="nt">&#34;Addresses&#34;</span><span class="p">:</span> <span class="kc">null</span>
		<span class="p">},</span>
		<span class="nt">&#34;ClusterExternalPorts&#34;</span><span class="p">:</span> <span class="kc">null</span>
	<span class="p">},</span>
	<span class="nt">&#34;ports&#34;</span><span class="p">:</span> <span class="p">[{</span>
		<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tcp-metaprotocol-dubbo&#34;</span><span class="p">,</span>
		<span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="mi">20880</span><span class="p">,</span>
		<span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;TCP&#34;</span>
	<span class="p">}],</span>
	<span class="nt">&#34;creationTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-03-15T06:38:02Z&#34;</span><span class="p">,</span>
	<span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;org.apache.dubbo.samples.basic.api.demoservice&#34;</span><span class="p">,</span>
	<span class="nt">&#34;clusterVIPs&#34;</span><span class="p">:</span> <span class="p">{</span>
		<span class="nt">&#34;Addresses&#34;</span><span class="p">:</span> <span class="kc">null</span>
	<span class="p">},</span>
	<span class="nt">&#34;defaultAddress&#34;</span><span class="p">:</span> <span class="s2">&#34;240.240.0.46&#34;</span><span class="p">,</span>
	<span class="nt">&#34;Resolution&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="nt">&#34;MeshExternal&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nt">&#34;ResourceVersion&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>继续看下 consumer 中的代理配置，可以看到配置的 cluster 名称为 ServiceEntry 中的 hosts，并配置了其 endpoints 为两个 provider pods 的 ip：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">root@dev:~/zt/istio/dubbo2istio/demo/k8s/test-zk# istioctl proxy-config cluster dubbo-sample-consumer-67fc956cc8-c8ltf <span class="p">|</span> grep demo
org.apache.dubbo.samples.basic.api.demoservice                      <span class="m">20880</span>     -          outbound      EDS
root@dev:~/zt/istio/dubbo2istio/demo/k8s/test-zk# istioctl proxy-config endpoints dubbo-sample-consumer-67fc956cc8-c8ltf --cluster <span class="s2">&#34;outbound|20880||org.apache.dubbo.samples.basic.api.demoservice&#34;</span>
ENDPOINT              STATUS      OUTLIER CHECK     CLUSTER
10.42.0.159:20880     HEALTHY     OK                outbound<span class="p">|</span>20880<span class="o">||</span>org.apache.dubbo.samples.basic.api.demoservice
10.42.0.160:20880     HEALTHY     OK                outbound<span class="p">|</span>20880<span class="o">||</span>org.apache.dubbo.samples.basic.api.demoservice
</code></pre></td></tr></table>
</div>
</div><p>上面的逻辑解决了如何找到 provider 地址的问题，但是因为 consumer 中使用的是 dubbo 协议，而 istio 中目前不支持 dubbo 协议，因此 envoy 无法进行出向流量的劫持。</p>
<p>在 Aeraki 中通过 <a href="https://github.com/aeraki-mesh/meta-protocol-proxy.git">meta-protocol-proxy</a> 代理来解决的，这个代理目前支持 dubbo 和 thrift 协议。 Aeraki 服务会监测上面的 ServiceEntry，生成对应的 EnvoyFilter，将 tcp 网络过滤器替换为自定义的 meta_protocol_proxy 协议，由 istiod 下发到代理中。下面示例项目中生成的 EnvoyFilter：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">EnvoyFilter</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">manager</span><span class="p">:</span><span class="w"> </span><span class="l">Aeraki</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki-outbound-org.apache.dubbo.samples.basic.api.demoservice-240.240.0.6-20880</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">configPatches</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">applyTo</span><span class="p">:</span><span class="w"> </span><span class="l">NETWORK_FILTER</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">listener</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">filterChain</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">filter</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.filters.network.tcp_proxy</span><span class="w"> </span><span class="c"># 上面设置的是 tcp 协议，因此会生成 tcp 的 filter</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">240.240.0</span><span class="l">.6_20880</span><span class="w">
</span><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">operation</span><span class="p">:</span><span class="w"> </span><span class="l">REPLACE </span><span class="w"> </span><span class="c"># 替换上面的网络过滤器</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.filters.network.meta_protocol_proxy</span><span class="w"> </span><span class="c"># 替换 Aeraki 的自定义协议 meta_protocol_proxy</span><span class="w">
</span><span class="w">        </span><span class="nt">typed_config</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">&#39;@type&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">type.googleapis.com/udpa.type.v1.TypedStruct</span><span class="w">
</span><span class="w">          </span><span class="nt">type_url</span><span class="p">:</span><span class="w"> </span><span class="l">type.googleapis.com/aeraki.meta_protocol_proxy.v1alpha.MetaProtocolProxy</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">accessLog</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.access_loggers.file</span><span class="w">
</span><span class="w">              </span><span class="nt">typedConfig</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">&#39;@type&#39;</span><span class="p">:</span><span class="w"> </span><span class="l">type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span class="w">
</span><span class="w">                </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/stdout</span><span class="w">
</span><span class="w">            </span><span class="nt">applicationProtocol</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo </span><span class="w"> </span><span class="c"># 应用层协议为 dubbo</span><span class="w">
</span><span class="w">            </span><span class="nt">codec</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki.meta_protocol.codec.dubbo </span><span class="w"> </span><span class="c"># 应用层编码和解码协议</span><span class="w">
</span><span class="w">            </span><span class="nt">metaProtocolFilters</span><span class="p">:</span><span class="w">  </span><span class="c"># 一个单独的七层协议过滤器列表，默认为 router 即直接路由</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki.meta_protocol.filters.router</span><span class="w">
</span><span class="w">            </span><span class="nt">rds</span><span class="p">:</span><span class="w">  </span><span class="c"># 设置路由由 rDS 动态获取</span><span class="w">
</span><span class="w">              </span><span class="nt">configSource</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">apiConfigSource</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">apiType</span><span class="p">:</span><span class="w"> </span><span class="l">GRPC</span><span class="w">
</span><span class="w">                  </span><span class="nt">grpcServices</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="nt">envoyGrpc</span><span class="p">:</span><span class="w">
</span><span class="w">                      </span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki-xds</span><span class="w">
</span><span class="w">                  </span><span class="nt">transportApiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">V3</span><span class="w">
</span><span class="w">                </span><span class="nt">resourceApiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">V3</span><span class="w">
</span><span class="w">              </span><span class="c"># routeConfigName 路由配置的名称</span><span class="w">
</span><span class="w">              </span><span class="nt">routeConfigName</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.basic.api.demoservice_20880</span><span class="w">
</span><span class="w">            </span><span class="nt">statPrefix</span><span class="p">:</span><span class="w"> </span><span class="l">outbound|20880||org.apache.dubbo.samples.basic.api.demoservice</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在 EnvoyFilter 中设置了 routeConfigName，将会通过 xDS 下发给代理，代理中的路由配置如下，其中设置了路由到上面所示的 cluster 中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;1678172533&#34;</span><span class="p">,</span>
  <span class="nt">&#34;route_config&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/aeraki.meta_protocol_proxy.config.route.v1alpha.RouteConfiguration&#34;</span><span class="p">,</span>
  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;org.apache.dubbo.samples.basic.api.demoservice_20880&#34;</span><span class="p">,</span>
  <span class="nt">&#34;routes&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
    <span class="nt">&#34;route&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|20880||org.apache.dubbo.samples.basic.api.demoservice&#34;</span>
    <span class="p">}</span>
  <span class="err">]</span>
  <span class="p">},</span>
  <span class="s2">&#34;last_updated&#34;</span><span class="err">:</span> <span class="s2">&#34;2023-03-07T07:02:13.705Z&#34;</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>查看 envoy 中此集群的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json">    <span class="p">{</span>
     <span class="nt">&#34;version_info&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-03-15T06:38:56Z/18&#34;</span><span class="p">,</span>
     <span class="nt">&#34;cluster&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;</span><span class="p">,</span>
      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|20880||org.apache.dubbo.samples.basic.api.demoservice&#34;</span><span class="p">,</span>
      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;EDS&#34;</span><span class="p">,</span> <span class="c1">// 服务发现类型，用来解析 cluster，参考 [Cluster.DiscoveryType](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto.html#enum-config-cluster-v3-cluster-discoverytype)
</span><span class="c1"></span>      <span class="nt">&#34;eds_cluster_config&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// EDS 类型时的配置
</span><span class="c1"></span>       <span class="nt">&#34;eds_config&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;ads&#34;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1">// 当前为空，在这里可以指定要使用的 ADS 服务
</span><span class="c1"></span>        <span class="nt">&#34;initial_fetch_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;0s&#34;</span><span class="p">,</span>
        <span class="nt">&#34;resource_api_version&#34;</span><span class="p">:</span> <span class="s2">&#34;V3&#34;</span>
       <span class="p">},</span>
       <span class="c1">//  可选的集群替代名，用来提交给 EDS
</span><span class="c1"></span>       <span class="nt">&#34;service_name&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound|20880||org.apache.dubbo.samples.basic.api.demoservice&#34;</span>
      <span class="p">},</span>
      <span class="nt">&#34;connect_timeout&#34;</span><span class="p">:</span> <span class="s2">&#34;10s&#34;</span><span class="p">,</span>
      <span class="nt">&#34;lb_policy&#34;</span><span class="p">:</span> <span class="s2">&#34;LEAST_REQUEST&#34;</span><span class="p">,</span>
      <span class="nt">&#34;circuit_breakers&#34;</span><span class="p">:</span> <span class="p">{},</span> <span class="c1">// 熔断设置
</span><span class="c1"></span>      <span class="nt">&#34;metadata&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 用来提供关于 cluster 的额外信息，可以被用来做统计、日志和改变过滤器行为
</span><span class="c1"></span>       <span class="nt">&#34;filter_metadata&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// map&lt;string, Struct&gt;，key 是逆序的 DNS 过滤器名称，比如 com.acme.widget
</span><span class="c1"></span>        <span class="nt">&#34;istio&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 这里是指：istio 相关的过滤器？
</span><span class="c1"></span>         <span class="nt">&#34;config&#34;</span><span class="p">:</span> <span class="s2">&#34;/apis/networking.istio.io/v1alpha3/namespaces/meta-dubbo/destination-rule/dubbo-sample-provider&#34;</span><span class="p">,</span>
         <span class="nt">&#34;default_original_port&#34;</span><span class="p">:</span> <span class="mi">20880</span><span class="p">,</span>
         <span class="nt">&#34;services&#34;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
           <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;org.apache.dubbo.samples.basic.api.demoservice&#34;</span><span class="p">,</span>
           <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;org.apache.dubbo.samples.basic.api.demoservice&#34;</span><span class="p">,</span>
           <span class="nt">&#34;namespace&#34;</span><span class="p">:</span> <span class="s2">&#34;meta-dubbo&#34;</span>
          <span class="p">}</span>
         <span class="p">]</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&#34;common_lb_config&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 所有负载均衡实现的通用配置
</span><span class="c1"></span>       <span class="nt">&#34;locality_weighted_lb_config&#34;</span><span class="p">:</span> <span class="p">{}</span> <span class="c1">// 使用 [位置加权负载均衡](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/locality_weight#arch-overview-load-balancing-locality-weighted-lb)
</span><span class="c1"></span>      <span class="p">},</span>
      <span class="c1">// 有序的网络过滤器链，在 envoy 向此上游 cluster 请求时会应用
</span><span class="c1"></span>      <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">[</span>
       <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;istio.metadata_exchange&#34;</span><span class="p">,</span>
        <span class="c1">// 通过 PILOT_ENABLE_METADATA_EXCHANGE 开启的，pilot 会开启元数据交换过滤器，用来在遥测过滤器中使用
</span><span class="c1"></span>        <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.tcp.metadataexchange.config.MetadataExchange&#34;</span><span class="p">,</span>
         <span class="nt">&#34;protocol&#34;</span><span class="p">:</span> <span class="s2">&#34;istio-peer-exchange&#34;</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;transport_socket_matches&#34;</span><span class="p">:</span> <span class="p">[</span> <span class="c1">//为不同的 endponints 配置不同的传输 sockets
</span><span class="c1"></span>       <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-istio&#34;</span><span class="p">,</span>
        <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// 可选的端点元数据匹配准则，与元数据匹配的端点的连接将使用此传输套接字配置
</span><span class="c1"></span>         <span class="nt">&#34;tlsMode&#34;</span><span class="p">:</span> <span class="s2">&#34;istio&#34;</span>
        <span class="p">},</span>
        <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.tls&#34;</span><span class="p">,</span> <span class="c1">// 用于对不信任的下行和上行流量进行保护
</span><span class="c1"></span>         <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext&#34;</span><span class="p">,</span>
          <span class="nt">&#34;common_tls_context&#34;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&#34;tls_params&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;tls_minimum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_2&#34;</span><span class="p">,</span>
            <span class="nt">&#34;tls_maximum_protocol_version&#34;</span><span class="p">:</span> <span class="s2">&#34;TLSv1_3&#34;</span>
           <span class="p">},</span>
           <span class="nt">&#34;alpn_protocols&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&#34;istio-peer-exchange&#34;</span><span class="p">,</span>
            <span class="s2">&#34;istio&#34;</span>
           <span class="p">],</span>
           <span class="nt">&#34;tls_certificate_sds_secret_configs&#34;</span><span class="p">:</span> <span class="p">[</span>
            <span class="c1">// ...
</span><span class="c1"></span>           <span class="p">],</span>
           <span class="nt">&#34;combined_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;default_validation_context&#34;</span><span class="p">:</span> <span class="p">{</span>
             <span class="nt">&#34;match_subject_alt_names&#34;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
               <span class="nt">&#34;exact&#34;</span><span class="p">:</span> <span class="s2">&#34;spiffe://cluster.local/ns/meta-dubbo/sa/default&#34;</span>
              <span class="p">}</span>
             <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">&#34;validation_context_sds_secret_config&#34;</span><span class="p">:</span> <span class="p">{</span>
             <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ROOTCA&#34;</span><span class="p">,</span>
             <span class="nt">&#34;sds_config&#34;</span><span class="p">:</span> <span class="p">{</span><span class="c1">//...}
</span><span class="c1"></span>            <span class="p">}</span>
           <span class="p">}</span>
          <span class="p">},</span>
          <span class="c1">// 服务器名称指示，创建 TLS 后端连接时使用，SNI 是 TLS 握手期间的一个扩展，它允许客户端在建立 TLS 连接时指定要访问的服务器名称。服务器可以使用这个信息来选择正确的证书以及配置 TLS 连接
</span><span class="c1"></span>          <span class="nt">&#34;sni&#34;</span><span class="p">:</span> <span class="s2">&#34;outbound_.20880_._.org.apache.dubbo.samples.basic.api.demoservice&#34;</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">},</span>
       <span class="err">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tlsMode-disabled&#34;</span><span class="p">,</span>
        <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="nt">&#34;transport_socket&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;envoy.transport_sockets.raw_buffer&#34;</span><span class="p">,</span>
         <span class="nt">&#34;typed_config&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;@type&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/envoy.extensions.transport_sockets.raw_buffer.v3.RawBuffer&#34;</span>
         <span class="p">}</span>
        <span class="p">}</span>
       <span class="p">}</span>
      <span class="p">]</span>
     <span class="p">},</span>
     <span class="nt">&#34;last_updated&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-03-15T06:38:56.637Z&#34;</span>
    <span class="p">}</span><span class="err">,</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="使用-envoyfilter-接入-dubbo2">使用 EnvoyFilter 接入 dubbo2</h1>
<p>这里考虑一个场景，只需要支持 dubbo2 协议和第三方注册中心，并且使用 dubbo 自身的服务治理能力，那可以对上述逻辑进行简化，不引入 Aeraki 组件和 MetaProtocol Proxy 代理，只使用 dubbo2istio，手动生成 EnvoyFilter 来支持 dubbo 协议。</p>
<p>因为上面测试生成了 EnvoyFilter 和 ServiceEntry 等资源，这里先进行清理工作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubens meta-dubbo
<span class="nb">cd</span> dubbo2istio
kubectl delete -f demo/k8s/zk/dubbo-example.yaml
kubectl delete deploy -nistio-system aeraki
// 查看 aeraki 生成的 envoyfilter，然后删除
kubectl get envoyfilter -nistio-system <span class="p">|</span> grep aeraki
// 查看 aeraki 生成的 serviceentry，然后删除
kubectl get serviceentry
</code></pre></td></tr></table>
</div>
</div><p>这里将测试用例也进行了简化，provider.yaml 如下所示，去掉了 sidecar 相关的 annotations，因此默认会使用 envoy 代理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider-v1</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki/dubbo-sample-provider</span><span class="w">
</span><span class="w">          </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">REGISTRY_ADDR</span><span class="w">
</span><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">zookeeper://zookeeper:2181</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">REGISTER</span><span class="w">
</span><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">AERAKI_META_APP_NAMESPACE</span><span class="w">
</span><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">fieldRef</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l">metadata.namespace</span><span class="w">
</span><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>部署 provider 后，查看 dubbo2istio 生成的 ServiceEntry 为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceEntry</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.basic.api.DemoService</span><span class="w">
</span><span class="w">    </span><span class="nt">workloadSelector</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">manager</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki</span><span class="w">
</span><span class="w">    </span><span class="nt">registry</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo2istio</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki-org-apache-dubbo-samples-basic-api-demoservice</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">meta-dubbo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="m">10.42.0.20</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">anyhost</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">application</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-provider</span><span class="w">
</span><span class="w">      </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">deprecated</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">dubbo</span><span class="p">:</span><span class="w"> </span><span class="m">2.0.2</span><span class="w">
</span><span class="w">      </span><span class="nt">dynamic</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">generic</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.basic.api.DemoService</span><span class="w">
</span><span class="w">      </span><span class="nt">metadata-type</span><span class="p">:</span><span class="w"> </span><span class="l">remote</span><span class="w">
</span><span class="w">      </span><span class="nt">methods</span><span class="p">:</span><span class="w"> </span><span class="l">testVoid-sayHello</span><span class="w">
</span><span class="w">      </span><span class="nt">pid</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">registryName</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">      </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="m">1.0</span>-<span class="l">SNAPSHOT</span><span class="w">
</span><span class="w">      </span><span class="nt">revision</span><span class="p">:</span><span class="w"> </span><span class="m">1.0</span>-<span class="l">SNAPSHOT</span><span class="w">
</span><span class="w">      </span><span class="nt">service_group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">side</span><span class="p">:</span><span class="w"> </span><span class="l">provider</span><span class="w">
</span><span class="w">      </span><span class="nt">timestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1679308798700&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">tcp-metaprotocol-dubbo</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span><span class="w">    </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">org.apache.dubbo.samples.basic.api.demoservice</span><span class="w">
</span><span class="w">  </span><span class="nt">location</span><span class="p">:</span><span class="w"> </span><span class="l">MESH_INTERNAL</span><span class="w">
</span><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp-metaprotocol-dubbo</span><span class="w">
</span><span class="w">    </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">20880</span><span class="w">
</span><span class="w">  </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="l">STATIC</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>编辑此 ServiceEntry 增加 addresses 字段，分配一个保留网段的全局唯一 ip 值，比如 240.240.0.2，当 consumer 端请求到 host 服务时，经过域名解析后会请求到 240.240.0.2。
分配了 addresses 后，那 EnvoyFilter 中需要替换的过滤器就确定了。部署如下所示的 EnvoyFilter，会将配置中请求的 TCP 过滤器替换为 Dubbo 过滤器，并设置了路由的匹配方法和目标集群，这样请求会被转发到目标集群对应的 Endpoints（Istio 根据 ServiceEntry 的 Endpoints 信息下发到 envoy 中）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">EnvoyFilter</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki-inbound-org.apache.dubbo.samples.basic.api.demoservice-240.240.0.2-20880</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">configPatches</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">applyTo</span><span class="p">:</span><span class="w"> </span><span class="l">NETWORK_FILTER</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">listener</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">240.240.0</span><span class="l">.2_20880</span><span class="w">
</span><span class="w">        </span><span class="nt">filterChain</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">filter</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;envoy.filters.network.tcp_proxy&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">operation</span><span class="p">:</span><span class="w"> </span><span class="l">REPLACE</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.filters.network.dubbo_proxy</span><span class="w">
</span><span class="w">        </span><span class="nt">typed_config</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">&#34;@type&#34;: </span><span class="l">type.googleapis.com/envoy.extensions.filters.network.dubbo_proxy.v3.DubboProxy</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol_type</span><span class="p">:</span><span class="w"> </span><span class="l">Dubbo</span><span class="w">
</span><span class="w">          </span><span class="nt">serialization_type</span><span class="p">:</span><span class="w"> </span><span class="l">Hessian2</span><span class="w">
</span><span class="w">          </span><span class="nt">statPrefix</span><span class="p">:</span><span class="w"> </span><span class="l">outbound|20880||org.apache.dubbo.samples.basic.api.demoservice</span><span class="w">
</span><span class="w">          </span><span class="nt">route_config</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">outbound|20880||org.apache.dubbo.samples.basic.api.demoservice</span><span class="w">
</span><span class="w">            </span><span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">org.apache.dubbo.samples.basic.api.DemoService</span><span class="w">
</span><span class="w">            </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">method</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span><span class="w">                    </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l">sayHello</span><span class="w">
</span><span class="w">              </span><span class="nt">route</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l">outbound|20880||org.apache.dubbo.samples.basic.api.demoservice</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>继续部署如下所示的 consumer，部署描述中也去掉了 sidecar 相关的 annotations：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-consumer</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-consumer</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-consumer</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-consumer</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dubbo-sample-consumer</span><span class="w">
</span><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">aeraki/dubbo-sample-consumer</span><span class="w">
</span><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mode</span><span class="w">
</span><span class="w">              </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">demo</span><span class="w">
</span><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9009</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>查看日志可以看到，consumer 服务正常请求 provider 了。这里是通过手动修改 ServiceEntry，手动编写 EnvoyFilter，比较繁琐，可以将此过程自动化，新增一个模块 EController，整体框图如下所示。</p>
<p><img src="../../image/istio_dubbo_registry/econtrol_dubbo2istio.png" alt="econtrol_dubbo2istio.png" title="econtrol_dubbo2istio"></p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://www.aeraki.net/zh/docs/v1.x/tutorials/dubbo/">如何将 Dubbo 服务接入到 Aeraki Mesh</a></li>
<li><a href="https://penglei.github.io/post/dubbo-integrate-with-istio/">Dubbo 集成 Istio 的方案</a></li>
<li><a href="https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/xsd-configuration.html">XML Schema-based configuration</a></li>
<li><a href="https://cn.dubbo.apache.org/zh-cn/docs3-v2/java-sdk/reference-manual/config/properties/">dubbo 配置项参考</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/371085990">Istio 1.9 如何对接第三方注册中心</a></li>
<li><a href="https://blog.csdn.net/u014087707/article/details/120416146">Istio 集成 Nacos 作为注册中心</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">yefengzhichen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-02-28
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="../../tags/kubernetes/">kubernetes</a>
          <a href="../../tags/dubbo/">dubbo</a>
          <a href="../../tags/registry/">registry</a>
          <a href="../../tags/istio/">istio</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="../../post/dubbo_demo/">
            <span class="next-text nav-default">dubbo 多种部署场景测试</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="yefengzhichen/yefengzhichen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="zhutao_hust@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/yefengzhichen" class="iconfont icon-github" title="github"></a>
  <a href="https://yefengzhichen.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="../../img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2022 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>yefengzhichen</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="../../js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
